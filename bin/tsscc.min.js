function AudioLooper(e){this.bufferSize=4096,e!==undefined&&(this.bufferSize=e),this.channel=null,this.initialized=!0,this.firstAudioEvent=null,this.sampleRate=44100;if(window.webkitAudioContext||window.AudioContext){Log.getLog().info("AudioLooper: detect Web Audio API"),this.audioContext=new webkitAudioContext||new AudioContext;if(this.audioContext==null){Log.getLog().fatal("AudioLooper: could not create AudioContext"),this.initialized=!1;return}this.sampleRate=this.audioContext.sampleRate,Log.getLog().info("AudioLooper: sample rate is "+this.sampleRate),this.bufferSource=this.audioContext.createBufferSource(),this.jsNode=this.audioContext.createScriptProcessor(this.bufferSize,2,2),this.jsNode.owner=this,this.jsNode.onaudioprocess=function(e){this.owner.onAudioProcess(e)},this.bufferSource.noteOn&&this.bufferSource.noteOn(0),this.bufferSource.connect(this.jsNode),this.jsNode.connect(this.audioContext.destination);return}if(window.Audio){Log.getLog().info("AudioLooper: detect Audio Data API"),this.audio=new Audio;if(this.audio==null||this.audio["mozSetup"]==undefined){Log.getLog().fatal("AudioLooper: could not use Audio Data API"),this.initialized=!1;return}this.audioChannel=2,this.audioFrequency=44100,this.audio.mozSetup(this.audioChannel,this.audioFrequency),this.bufferId=0,this.bufferPage=4,this.bufferWritten=0,this.buffer=new Array(this.bufferPage);var t=this.bufferSize*this.audioChannel;for(var n=0;n<this.bufferPage;n++)this.buffer[n]=new Float32Array(t),this.bufferWritten+=this.audio.mozWriteAudio(this.buffer[n]);this.audio.owner=this;var r=this.bufferSize*1e3/44100/2;setInterval(function(e){e.onAudioInterval()},r,this);return}Log.getLog().error("AudioLooper: no known Audio API are available"),this.initialized=!1}function MasterChannel(){this.channels=new Array,this.buffers=null,this.buffer=null,this.bufferLength=0,this.player=null,this.intervalMsec=0,this.intervalLength=0,this.intervalRestLength=0,this.volume=MasterChannel.DEFAULT_VOLUME,this.sampleRate=MasterChannel.DEFAULT_SAMPLE_FREQUENCY}function TssChannel(){this.sampleRate=MasterChannel.DEFAULT_SAMPLE_FREQUENCY,this.buffer=null,this.fmBuffer=[null,null,null,null],this.player=null,this.module=[],this.midi=new Array(TssChannel.MAX_MIDI_PORT);for(var e=0;e<TssChannel.MAX_MIDI_PORT;++e)this.midi[e]=new TssChannel.MIDI;this.timer=[{enable:!1,timer:0,count:0,base:0,self:null,callback:null},{enable:!1,timer:0,count:0,base:0,self:null,callback:null}],this.maxChannel=0,this.wave=[]}function TString(){this.object=null}function TsdPlayer(){this.device=null,this.input=null,this.header=null,this.channel=null,this.activeChannel=0,this.midi=new Array(TsdPlayer.MAX_MIDI_PORT),this.table=[];for(var e=0;e<256;e++)this.table[e]=new Uint8Array(0)}function TssCompiler(){this.logMmlCompile=!1,this.source=null,this.directives=[],this.channels=[],this.validWaves=0,this.waves=[],this.validTables=0,this.tables=[],this.tags={title:null,channels:0,fineness:TssCompiler._DEFAULT_FINENESS},this.modes={hardware:TssCompiler.HARDWARE_MODE_NORMAL,octave:TssCompiler.OCTAVE_MODE_NORMAL,volumeRelative:TssCompiler.VOLUME_RELATIVE_MODE_NORMAL},this.channelData=[]}window.exports||(window.exports={}),window.Log||(window.Log={enabled:!1,log:[],on:function(){Log.enabled=!0},off:function(){Log.enabled=!1},flush:function(){var e=Log.log.join("\n");return Log.log=[],e},getLog:function(){return Log},info:function(e){},warn:function(e){},error:function(e){Log.enabled&&Log.log.push(e)},fatal:function(e){Log.enabled&&Log.log.push(e)}}),AudioLooper.prototype.getSampleRate=function(){return this.sampleRate},AudioLooper.prototype.setChannel=function(e){null!=e&&(e.setBufferLength(this.bufferSize*2),e.setSampleRate(this.sampleRate)),this.channel=e},AudioLooper.prototype.onAudioProcess=function(e){null==this.firstAudioEvent&&(this.firstAudioEvent=!0,Log.getLog().info(e));var t=e.outputBuffer.getChannelData(0),n=e.outputBuffer.getChannelData(1),r;if(null==this.channel){for(r=0;r<this.bufferSize;r++)t[r]=0,n[r]=0;return}this.channel.generate(this.bufferSize*2);var i=this.channel.getBuffer();for(r=0;r<this.bufferSize;r++)t[r]=i[r*2+0]/32768,n[r]=i[r*2+1]/32768},AudioLooper.prototype.onAudioInterval=function(){null==this.firstAudioEvent&&(this.firstAudioEvent=!0,Log.getLog().info("onAudioInterval"),Log.getLog().info(this));var e=this.audio.mozCurrentSampleOffset(),t=this.bufferSize*this.audioChannel,n=e%(t*this.bufferPage),r=~~(n/t);if(this.bufferId==r&&this.bufferWritten!=e)return;var i=this.buffer[this.bufferId];this.bufferId=(this.bufferId+1)%this.bufferPage;var s;if(null==this.channel)for(s=0;s<this.bufferSize;s++)i[s*2+0]=0,i[s*2+1]=0;else{this.channel.generate(this.bufferSize*this.audioChannel);var o=this.channel.getBuffer();for(s=0;s<this.bufferSize;s++)i[s*2+0]=o[s*2+0]/32768,i[s*2+1]=o[s*2+1]/32768}this.bufferWritten+=this.audio.mozWriteAudio(i)},AudioLooper.prototype.isActive=function(){return this.audioContext&&this.audioContext["currentTime"]==0?!1:!0},AudioLooper.prototype.activate=function(){if(this.isActive())return;this.bufferSource.noteOn(0)},MasterChannel.DEFAULT_SAMPLE_FREQUENCY=44100,MasterChannel.MAX_WAVE_VALUE=32767,MasterChannel.MIN_WAVE_VALUE=-32767,MasterChannel.MSEC_PER_SEC=1e3,MasterChannel.DEFAULT_VOLUME=8,MasterChannel.prototype.reconstructBuffers=function(){var e=new Array(this.channels.length);for(var t=0;t<this.channels.length;t++)e[t]=this.channels[t].getBuffer();this.buffers=e},MasterChannel.prototype.setVolume=function(e){this.volume=e},MasterChannel.prototype.addChannel=function(e){var t=this.channels.push(e);return e.setSampleRate(this.sampleRate),0!=this.bufferLength&&(e.setBufferLength(this.bufferLength),this.reconstructBuffers()),t},MasterChannel.prototype.removeChannel=function(e){for(var t=0;t<this.channels.length;t++)if(e==this.channels[t])return this.buffers=null,this.channels.splice(t,1),this.reconstructBuffers(),!0;return!1},MasterChannel.prototype.clearChannel=function(){this.buffers=null,this.channels=new Array,this.reconstructBuffers()},MasterChannel.prototype.setPlayer=function(e){this.player=e},MasterChannel.prototype.setPlayerInterval=function(e){this.intervalMsec=e,this.intervalLength=2*this.sampleRate*e/MasterChannel.MSEC_PER_SEC,this.intervalLength&=-2,this.intervalRestLength=this.intervalLength},MasterChannel.prototype._generate=function(e,t){var n=this.channels.length,r;for(r=0;r<n;r++)this.channels[r].generate(t);for(var i=0;i<t;i++){var s=0;for(r=0;r<n;r++)s+=this.buffers[r][i];s*=this.volume,s>MasterChannel.MAX_WAVE_VALUE?s=MasterChannel.MAX_WAVE_VALUE:s<MasterChannel.MIN_WAVE_VALUE&&(s=MasterChannel.MIN_WAVE_VALUE),this.buffer[e+i]=s}},MasterChannel.prototype.setBufferLength=function(e){this.buffers=null,this.buffer=new Int32Array(e),this.bufferLength=e;for(var t=0;t<this.channels.length;t++)this.channels[t].setBufferLength(e);this.reconstructBuffers()},MasterChannel.prototype.setSampleRate=function(e){this.sampleRate=e;for(var t=0;t<this.channels.length;t++)this.channels[t].setSampleRate(e);this.setPlayerInterval(this.intervalMsec)},MasterChannel.prototype.getBuffer=function(){return this.buffer},MasterChannel.prototype.generate=function(e){if(null==this.buffers)return;if(null==this.player||0==this.intervalLength)this._generate(0,e);else{var t=e,n=0;while(t>this.intervalRestLength)this._generate(n,this.intervalRestLength),t-=this.intervalRestLength,n+=this.intervalRestLength,this.intervalRestLength=this.intervalLength,this.player.updateDevice();0!=t&&(this._generate(n,t),this.intervalRestLength-=t)}},TssChannel.MAX_MIDI_PORT=4,TssChannel.MODULE_CHANNEL_L=0,TssChannel.MODULE_CHANNEL_R=1,TssChannel.MODULE_CHANNEL_C=2,TssChannel.FM_OUT_MODE_OFF=0,TssChannel.FM_OUT_MODE_NEW=1,TssChannel.FM_OUT_MODE_ADD=2,TssChannel._RND_TABLE=new Int8Array(4096),TssChannel._SIN_TABLE=new Int8Array(256),function(){var e;for(e=0;e<4096;e++){var t=~~(Math.random()*2147483647)>>8&255;t>=128&&(t-=256),TssChannel._RND_TABLE[e]=t}for(e=0;e<256;e++)TssChannel._SIN_TABLE[e]=~~(Math.sin(Math.PI*e/128)*64+.5)}(),TssChannel.prototype.setBufferLength=function(e){this.buffer=new Int32Array(e);for(var t=0;t<4;t++)this.fmBuffer[t]=new Int32Array(e);for(var n=0;n<TssChannel.MAX_MIDI_PORT;++n)this.midi[n]&&this.midi[n].setBufferLength(e)},TssChannel.prototype.setSampleRate=function(e){this.sampleRate=e;for(var t=0;t<2;++t){var n=this.timer[t].base*e/44100|0;this.timer[t].timer=n,this.timer[t].count=n}},TssChannel.prototype.getBuffer=function(){return this.buffer},TssChannel.prototype.setPlayer=function(e){this.player=e},TssChannel.prototype.generate=function(e){var t=0;while(t<e){var n=e-t>>2,r;for(r=0;r<2;r++)this.timer[r].enable&&this.timer[r].count<n&&(n=this.timer[r].count);var i=n<<2;this._generateInternal(t,i),t+=i;for(r=0;r<2;r++){if(!this.timer[r].enable)continue;this.timer[r].count-=n;if(0!=this.timer[r].count)continue;this.timer[r].count=this.timer[r].timer,this.timer[r].callback.apply(this.timer[r].self)}}},TssChannel.prototype.reset=function(){for(var e=0;e<TssChannel.MAX_MIDI_PORT;++e)this.midi[e].device&&this.midi[e].device.processSystemReset()},TssChannel.prototype.setVirtualDevices=function(e){for(var t=0;t<TssChannel.MAX_MIDI_PORT;++t)this.midi[t].setDevice(e[t])},TssChannel.prototype._CheckId=function(e){if(typeof e=="undefined"||e>this.maxChannel)throw new RangeError("TSC: Invalid module channel: "+e)},TssChannel.prototype.setMaxChannel=function(e){this.maxChannel=e;for(var t=0;t<e;t++)this.module[t]=new TssChannel.Module(this,t)},TssChannel.prototype.setWave=function(e,t){Log.getLog().info("TSC: Set wave table "+e),Log.getLog().info(t),this.wave[e]=t},TssChannel.prototype.setTimerCallback=function(e,t,n,r){if(e>2)return;if(null!=r&&t<=0)return;var i=t*this.sampleRate/44100|0;this.timer[e]={enable:null!=r,timer:i,count:i,base:t,self:n,callback:r}},TssChannel.prototype.setModuleFrequency=function(e,t){this._CheckId(e),this.module[e].frequency=t},TssChannel.prototype.setModuleVolume=function(e,t,n){this._CheckId(e),t==TssChannel.MODULE_CHANNEL_L?this.module[e].volume.l=n:t==TssChannel.MODULE_CHANNEL_R?this.module[e].volume.r=n:t==TssChannel.MODULE_CHANNEL_C?this.module[e].volume.c=n:Log.getLog().error("TSC: Invalid volume channel: "+t)},TssChannel.prototype.getModuleVolume=function(e,t){this._CheckId(e);if(t==TssChannel.MODULE_CHANNEL_L)return this.module[e].volume.l;if(t==TssChannel.MODULE_CHANNEL_R)return this.module[e].volume.r;throw new RangeError("TSC: Invalid volume channel: "+e)},TssChannel.prototype.setModuleType=function(e,t){this._CheckId(e),this.module[e].setType(t),TssChannel.Module.TYPE_SCC==t&&(this.wave[0]||Log.getLog().warn("TSC: wave table 0 not found"))},TssChannel.prototype.getModuleType=function(e){return this._CheckId(e),this.module[e].type},TssChannel.prototype.setModulePort=function(e,t,n){this._CheckId(e);var r=this.getModuleType(e);if(TssChannel.Module.TYPE_MIDI!=r)return;this.derefMidi(this.module[e].mid),this.addrefMidi(t),this.module[e].mid=t,this.module[e].mch=n},TssChannel.prototype.setModuleVoice=function(e,t){this._CheckId(e);var n=this.getModuleType(e);if(TssChannel.Module.TYPE_SCC==n)this.wave[t]||Log.getLog().warn("TSC: wave table "+t+" not found");else if(TssChannel.Module.TYPE_MIDI==n){var r=this.midi[this.module[e].mid].device;r&&r.processProgramChange(this.module[e].mch,t)}this.module[e].voice=t},TssChannel.prototype.setModuleFmInPipe=function(e,t,n){this._CheckId(e),this.module[e].setFmInPipe(t,n)},TssChannel.prototype.setModuleFmOutPipe=function(e,t,n){this._CheckId(e),this.module[e].setFmOutPipe(t,n)},TssChannel.prototype.setModulePhase=function(e,t){this._CheckId(e),this.module[e].phase=t},TssChannel.prototype.keyOn=function(e,t){this._CheckId(e);var n=this.getModuleType(e);if(TssChannel.Module.TYPE_MIDI!=n)return;this.module[e].note=t;var r=this.midi[this.module[e].mid].device;r&&r.processNoteOn(this.module[e].mch,t,this.module[e].volume.c>>1)},TssChannel.prototype.keyOff=function(e){this._CheckId(e);var t=this.getModuleType(e);if(TssChannel.Module.TYPE_MIDI!=t)return;var n=this.midi[this.module[e].mid].device;n&&n.processNoteOff(this.module[e].mch,this.module[e].note,0)},TssChannel.prototype.pitchBend=function(e,t){this._CheckId(e);var n=this.getModuleType(e);if(TssChannel.Module.TYPE_MIDI!=n)return;var r=this.midi[this.module[e].mid].device;r&&r.processPitchBend(this.module[e].mch,t)},TssChannel.prototype.panpot=function(e,t){this._CheckId(e);var n=this.getModuleType(e);if(TssChannel.Module.TYPE_MIDI!=n)return;var r=this.midi[this.module[e].mid].device;r&&r.processControlChange(this.module[e].mch,10,t)},TssChannel.prototype._generateInternal=function(e,t){var n=this.buffer.subarray(e,e+t),r=[this.fmBuffer[0].subarray(e,e+t),this.fmBuffer[1].subarray(e,e+t),this.fmBuffer[2].subarray(e,e+t),this.fmBuffer[3].subarray(e,e+t)];for(var i=0;i<t;i++)n[i]=0;for(var s=0;s<this.maxChannel;s++)this.module[s].generate(n,r);for(var o=0;o<TssChannel.MAX_MIDI_PORT;++o){if(!this.midi[o].device||this.midi[o].reference==0)continue;this.midi[o].device.generate(t);var u=this.midi[o].inBuffer;for(var a=0;a<t;++a)n[a]+=u[a]}},TssChannel.prototype.addrefMidi=function(e){if(TssChannel.MAX_MIDI_PORT<=e)return;this.midi[e].reference++},TssChannel.prototype.derefMidi=function(e){if(TssChannel.MAX_MIDI_PORT<=e)return;this.midi[e].reference--},TssChannel.Module=function(e,t){this.id=t,this.channel=e,this.volume={l:0,r:0,c:0},this.frequency=0,this.fm={inRate:0,inPipe:0,outMode:0,outPipe:0},this.multiple=1,this.note=0,this.setType(TssChannel.Module.TYPE_PSG)},TssChannel.Module.TYPE_INVALID=-1,TssChannel.Module.TYPE_PSG=0,TssChannel.Module.TYPE_FC=1,TssChannel.Module.TYPE_NOISE=2,TssChannel.Module.TYPE_SIN=3,TssChannel.Module.TYPE_SCC=4,TssChannel.Module.TYPE_OSC=5,TssChannel.Module.TYPE_GB_SQUARE=13,TssChannel.Module.TYPE_GB_WAVE=14,TssChannel.Module.TYPE_MIDI=15,TssChannel.Module.prototype.setType=function(e){this.type==TssChannel.Module.TYPE_MIDI&&this.channel.derefMidi(this.mid),this.type=e,this.count=0,this.phase=0,this.voice=0,this.mid=0,this.mch=0;switch(e){case TssChannel.Module.TYPE_PSG:this.generate=this.generatePsg;break;case TssChannel.Module.TYPE_FC:this.generate=this.generateFc,this.voice=3;break;case TssChannel.Module.TYPE_NOISE:this.generate=this.generateNoise;break;case TssChannel.Module.TYPE_SCC:this.generate=this.generateScc;break;case TssChannel.Module.TYPE_SIN:this.generate=this.generateSin;break;case TssChannel.Module.TYPE_MIDI:this.generate=this.generateNothing,this.channel.addrefMidi(this.mid);break;default:Log.getLog().warn("TSC: unknown device type "+e),this.generate=this.generateNothing}},TssChannel.Module.prototype.setFmInPipe=function(e,t){this.fm.inRate=e,this.fm.inPipe=t},TssChannel.Module.prototype.setFmOutPipe=function(e,t){this.fm.outMode=e,this.fm.outPipe=t},TssChannel.Module.prototype.generatePsg=function(e,t){var n=this.volume.l<<4,r=this.volume.r<<4,i=e.length,s=this.frequency*2*this.multiple,o=this.count,u=this.phase;0==u&&(n=-n,r=-r);for(var a=0;a<i;a+=2){e[a+0]+=n,e[a+1]+=r,o+=s;while(o>this.channel.sampleRate)n=-n,r=-r,o-=this.channel.sampleRate,u++,u&=1}this.count=o,this.phase=u},TssChannel.Module.prototype.generateFc=function(e,t){var n=this.volume.l<<4,r=this.volume.r<<4,i=e.length,s=this.frequency*8*this.multiple,o=this.count,u=this.phase,a=this.voice;u<a&&(n=-n,r=-r);for(var f=0;f<i;f+=2){e[f+0]+=n,e[f+1]+=r,o+=s;while(o>this.channel.sampleRate){o-=this.channel.sampleRate,u++,u&=7;if(u==0||u==a)n=-n,r=-r}}this.count=o,this.phase=u},TssChannel.Module.prototype.generateNoise=function(e,t){var n=this.volume.l>>2,r=this.volume.r>>2,i=e.length,s=this.frequency*this.multiple,o=this.count,u=this.phase;for(var a=0;a<i;a+=2){var f=TssChannel._RND_TABLE[u];e[a+0]+=f*n,e[a+1]+=f*r,o+=s;while(o>0)u++,u&=4095,o-=880}this.count=o,this.phase=u},TssChannel.Module.prototype.generateScc=function(e,t){var n=this.channel.wave[this.voice];if(!n)return;var r=e;TssChannel.FM_OUT_MODE_OFF!=this.fm.outMode&&(r=t[this.fm.outPipe]);var i=this.volume.l>>2,s=this.volume.r>>2,o=e.length,u=this.frequency*32*this.multiple,a=this.count,f=this.phase,l;if(0==this.fm.inRate)if(TssChannel.FM_OUT_MODE_NEW==this.fm.outMode)for(l=0;l<o;l+=2){r[l+0]=n[f]*i,r[l+1]=n[f]*s,a+=u;while(a>this.channel.sampleRate)a-=this.channel.sampleRate,f++,f&=31}else for(l=0;l<o;l+=2){r[l+0]+=n[f]*i,r[l+1]+=n[f]*s,a+=u;while(a>this.channel.sampleRate)a-=this.channel.sampleRate,f++,f&=31}else{var c=t[this.fm.inPipe],h=this.fm.inRate<<3,p,d;if(TssChannel.FM_OUT_MODE_NEW==this.fm.outMode)for(l=0;l<o;l+=2){p=f+(c[l+0]>>h)&31,d=f+(c[l+1]>>h)&31,r[l+0]=n[p]*i,r[l+1]=n[d]*s,a+=u;while(a>this.channel.sampleRate)a-=this.channel.sampleRate,f++,f&=31}else for(l=0;l<o;l+=2){p=f+(c[l+0]>>h)&31,d=f+(c[l+1]>>h)&31,r[l+0]+=n[p]*i,r[l+1]+=n[d]*s,a+=u;while(a>this.channel.sampleRate)a-=this.channel.sampleRate,f++,f&=31}}this.count=a,this.phase=f},TssChannel.Module.prototype.generateSin=function(e,t){var n=e;TssChannel.FM_OUT_MODE_OFF!=this.fm.outMode&&(n=t[this.fm.outPipe]);var r=this.volume.l>>1,i=this.volume.r>>1,s=e.length,o=this.frequency*256*this.multiple,u=this.count,a=this.phase,f;if(0==this.fm.inRate)if(TssChannel.FM_OUT_MODE_NEW==this.fm.outMode)for(f=0;f<s;f+=2){n[f+0]=TssChannel._SIN_TABLE[a]*r,n[f+1]=TssChannel._SIN_TABLE[a]*i,u+=o;while(u>this.channel.sampleRate)u-=this.channel.sampleRate,a++,a&=255}else for(f=0;f<s;f+=2){n[f+0]+=TssChannel._SIN_TABLE[a]*r,n[f+1]+=TssChannel._SIN_TABLE[a]*i,u+=o;while(u>this.channel.sampleRate)u-=this.channel.sampleRate,a++,a&=255}else{var l=t[this.fm.inPipe],c=this.fm.inRate,h,p;if(TssChannel.FM_OUT_MODE_NEW==this.fm.outMode)for(f=0;f<s;f+=2){h=a+(l[f+0]>>c)&255,p=a+(l[f+1]>>c)&255,n[f+0]=TssChannel._SIN_TABLE[h]*r,n[f+1]=TssChannel._SIN_TABLE[p]*i,u+=o;while(u>this.channel.sampleRate)u-=this.channel.sampleRate,a++,a&=255}else for(f=0;f<s;f+=2){h=a+(l[f+0]>>c)&255,p=a+(l[f+1]>>c)&255,n[f+0]+=TssChannel._SIN_TABLE[h]*r,n[f+1]+=TssChannel._SIN_TABLE[p]*i,u+=o;while(u>this.channel.sampleRate)u-=this.channel.sampleRate,a++,a&=255}}this.count=u,this.phase=a},TssChannel.Module.prototype.generateNothing=function(e,t){},TssChannel.MIDI=function(){this.device=null,this.bufferLength=0,this.inBuffer=null,this.reference=0},TssChannel.MIDI.prototype.setDevice=function(e){e&&this.bufferLength!=0&&(e.setBufferLength(length),this.inBuffer=this.device.getBuffer()),this.device=e},TssChannel.MIDI.prototype.setBufferLength=function(e){this.bufferLength=e,this.device&&(this.device.setBufferLength(e),this.inBuffer=this.device.getBuffer())},TString.CODE_NUL=0,TString.CODE_HT=9,TString.CODE_LF=10,TString.CODE_CR=13,TString.CODE_SP=32,TString.CODE_0=48,TString.CODE_9=57,TString.CODE_A=65,TString.CODE_Z=90,TString.CODE_a=97,TString.CODE_z=122,TString._isBMP=function(e){return e<0||65536<=e?!1:e<55296?!0:e>=57344?!0:!1},TString._isHighSurrogates=function(e){return 55296<=e&&e<56320?!0:!1},TString._isLowSurrogates=function(e){return 56320<=e&&e<57344?!0:!1},TString._decodeSurrogatePair=function(e,t){if(!TString._isHighSurrogates(e)||!TString._isLowSurrogates(t))throw new RangeError("TString: invalid surrogate pair ("+e+", "+t+")");var n=e>>6&15,r=n+1,i=(e&63)<<10|t&1023,s=(r<<16)+i;return s<0?4294967296+s:s},TString._bytesInUTF8=function(e){if(e<0)throw new RangeError("TString: invalid UCS-2 code "+e);if(e<128)return 1;if(e<2048)return 2;if(e<65536)return 3;if(e<2097152)return 4;if(e<67108864)return 5;if(e<2147483648)return 6;throw new RangeError("TString: invalid UCS-2 code "+e)},TString._countString=function(e){var t=0;for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);if(!TString._isBMP(r)){if(++n>=e.length)throw new RangeError("TString: invalid surrogate pair");r=TString._decodeSurrogatePair(r,e.charCodeAt(n))}t+=TString._bytesInUTF8(r)}return t},TString._setUcs2=function(e,t,n){if(n<0)throw new RangeError("TString: invalid UCS-2 code "+n);if(n<128)return e[t]=n,1;if(n<2048)return e[t+0]=192|n>>6,e[t+1]=128|n&63,2;if(n<65536)return e[t+0]=224|n>>12,e[t+1]=128|n>>6&63,e[t+2]=128|n&63,3;if(n<2097152)return e[t+0]=240|n>>18,e[t+1]=128|n>>12&63,e[t+2]=128|n>>6&63,e[t+3]=128|n&63,4;if(n<67108864)return e[t+0]=248|n>>24,e[t+1]=128|n>>18&63,e[t+2]=128|n>>12&63,e[t+3]=128|n>>6&63,e[t+4]=128|n&63,5;if(n<2147483648)return e[t+0]=252|n>>30,e[t+1]=128|n>>24&63,e[t+2]=128|n>>18&63,e[t+3]=128|n>>12&63,e[t+4]=128|n>>6&63,e[t+5]=128|n&63,6;throw new RangeError("TString: invalid UCS-2 code "+n)},TString._buildUint8ArrayString=function(e){var t=TString._countString(e),n=new Uint8Array(t),r=0;for(var i=0;i<e.length;i++){var s=e.charCodeAt(i);if(!TString._isBMP(s)){if(++i>=e.length)throw new RangeError("TString: invalid surrogate pair");s=TString._decodeSurrogatePair(s,e.charCodeAt(i))}r+=TString._setUcs2(n,r,s)}return n},TString.createFromString=function(e){var t=new TString;return t._fromString(e),t},TString.createFromUint8Array=function(e){var t=new TString;return t._fromUint8Array(e),t},TString.prototype._fromString=function(e){this.object=TString._buildUint8ArrayString(e)},TString.prototype._fromUint8Array=function(e){this.object=e},TString.prototype.at=function(e){if(e>=this.object.byteLength)throw new RangeError("TString: offset is out of range");return this.object[e]},TString.prototype.charAt=function(e){return String.fromCharCode(this.at(e))},TString.prototype.lowerCharAt=function(e){var t=this.at(e);return TString.CODE_A<=t&&t<=TString.CODE_Z&&(t|=32),String.fromCharCode(t)},TString.prototype.numberAt=function(e){return this.isNumber(e)?this.object[e]-TString.CODE_0:-1},TString.prototype.setAt=function(e,t){if(e>=this.object.byteLength)throw new RangeError("TString: offset is out of range");this.object[e]=t},TString.prototype.setCharAt=function(e,t){this.setAt(e,t.charCodeAt(0))},TString.prototype.setASCII=function(e,t){for(var n=0;n<t.length;n++)this.setAt(e+n,t.charCodeAt(n));return this.setAt(e+t.length,0),e+t.length+1},TString.prototype.setTString=function(e,t){for(var n=0;n<t.byteLength();n++)this.setAt(e+n,t.at(n));return this.setAt(e+t.byteLength(),0),e+t.byteLength()+1},TString.prototype.setUint16=function(e,t){return this.setAt(e,t>>8),this.setAt(e+1,t&255),e+2},TString.prototype.setUint32=function(e,t){return this.setAt(e,t>>24),this.setAt(e+1,t>>16&255),this.setAt(e+2,t>>8&255),this.setAt(e+3,t&255),e+4},TString.prototype.byteLength=function(){return this.object.length},TString.prototype.slice=function(e,t){return TString.createFromUint8Array(this.object.subarray(e,t))},TString.prototype.containString=function(e,t){var n=TString.createFromString(t);return this.containUint8Array(e,n.object)},TString.prototype.containUint8Array=function(e,t){for(var n=0;n<t.length;n++)if(this.object[e+n]!=t[n])return!1;return!0},TString.prototype.containASCII=function(e,t){for(var n=0;n<t.length;n++)if(this.object[e+n]!=t.charCodeAt(n))return!1;return!0},TString.prototype.countLine=function(e){var t=0;for(var n=e;n<this.object.length;n++){var r=this.object[n];if(TString.CODE_CR==r||TString.CODE_LF==r)break;t++}return t},TString.prototype.countLineDelimiter=function(e){if(e>=this.object.length)return 0;var t=0,n=this.object[e++];if(TString.CODE_CR==n){if(e==this.object.length)return 1;t++,n=this.object[e]}return TString.CODE_LF==n&&t++,t},TString.prototype.countSpaces=function(e){var t=0;for(var n=e;n<this.object.length;n++){var r=this.object[n];if(TString.CODE_NUL!=r&&TString.CODE_HT!=r&&TString.CODE_SP!=r)break;t++}return t},TString.prototype.alphabetIndex=function(e){var t=this.object[e];return TString.CODE_A<=t&&t<=TString.CODE_Z?t-TString.CODE_A:TString.CODE_a<=t&&t<=TString.CODE_z?t-TString.CODE_a:-1},TString.prototype.isNumber=function(e){if(e>=this.object.byteLength)return!1;var t=this.object[e];return t<TString.CODE_0||TString.CODE_9<t?!1:!0},TString.prototype.find=function(e,t){for(var n=e;n<this.object.length;n++)if(this.object[n]==t)return n;return-1},TString.prototype.toString=function(e,t){arguments.length<1&&(e=0),arguments.length<2&&(t=this.byteLength()-e);var n="",r=!0,i=1,s=0;for(var o=0;o<t&&o<this.object.length;o++){var u=this.object[e+o];if(r){if(0==u)break;if(u<128){n+=String.fromCharCode(u);continue}r=!1;if(u<194)throw new TypeError("TString: invalid UTF-8");if(u<224)i=2,s=u&31;else if(u<240)i=3,s=u&15;else if(u<248)i=4,s=u&7;else if(u<252)i=5,s=u&3;else{if(!(u<254))throw new TypeError("TString: invalid UTF-8");i=6,s=u&1}i--}else{if(u<128||191<u)throw new TypeError("TString: invalid UTF-8");s=s<<6|u&63,i--;if(0==i){r=!0;if(s<55296||57344<=s)n+=String.fromCharCode(s);else{var a=s>>16&31,f=a-1,l=s&65535;n+=String.fromCharCode(55296+(f<<6)+(l>>10)),n+=String.fromCharCode(56320+(l&1023))}}}}if(!r)throw new TypeError("TString: invalid UTF-8");return n},exports.TString=TString,TsdPlayer.VERSION=.94,TsdPlayer.MAX_MIDI_PORT=TssChannel.MAX_MIDI_PORT,TsdPlayer.CMD_LAST_NOTE=127,TsdPlayer.CMD_NOTE_OFF=128,TsdPlayer.CMD_VOLUME_MONO=129,TsdPlayer.CMD_SUSTAIN_MODE=130,TsdPlayer.CMD_DETUNE=131,TsdPlayer.CMD_PORTAMENT=132,TsdPlayer.CMD_VOLUME_LEFT=133,TsdPlayer.CMD_VOLUME_RIGHT=134,TsdPlayer.CMD_PANPOT=135,TsdPlayer.CMD_RELATIVE_VOLUME_UP=136,TsdPlayer.CMD_RELATIVE_VOLUME_DOWN=137,TsdPlayer.CMD_TEMPO=144,TsdPlayer.CMD_FINENESS=145,TsdPlayer.CMD_KEY_ON_PHASE=146,TsdPlayer.CMD_MULTIPLE=147,TsdPlayer.CMD_PITCH_MODULATION_DELAY=160,TsdPlayer.CMD_PITCH_MODULATION_DEPTH=161,TsdPlayer.CMD_PITCH_MODULATION_WIDTH=162,TsdPlayer.CMD_PITCH_MODULATION_HEIGHT=163,TsdPlayer.CMD_PITCH_MODULATION_DELTA=164,TsdPlayer.CMD_AMP_EMVELOPE=184,TsdPlayer.CMD_NOTE_EMVELOPE=200,TsdPlayer.CMD_ENDLESS_LOOP_POINT=224,TsdPlayer.CMD_LOCAL_LOOP_START=225,TsdPlayer.CMD_LOCAL_LOOP_BREAK=226,TsdPlayer.CMD_LOCAL_LOOP_END=227,TsdPlayer.CMD_FREQUENCY_MODE_CHANGE=240,TsdPlayer.CMD_VOLUME_MODE_CHANGE=241,TsdPlayer.CMD_FM_IN=248,TsdPlayer.CMD_FM_OUT=249,TsdPlayer.CMD_CONTROL_CHANGE=251,TsdPlayer.CMD_PORT_CHANGE=252,TsdPlayer.CMD_VOICE_CHANGE=253,TsdPlayer.CMD_MODULE_CHANGE=254,TsdPlayer.CMD_END=255,TsdPlayer._DEFAULT_TIMER_COUNT=368,TsdPlayer._TIMER_AUTOMATION=0,TsdPlayer._TIMER_SEQUENCER=1,TsdPlayer._CH_L=TssChannel.MODULE_CHANNEL_L,TsdPlayer._CH_R=TssChannel.MODULE_CHANNEL_R,TsdPlayer._CH_C=TssChannel.MODULE_CHANNEL_C,TsdPlayer._PAN_L=1,TsdPlayer._PAN_R=2,TsdPlayer._PAN_C=TsdPlayer._PAN_L|TsdPlayer._PAN_R,TsdPlayer._FREQUENCY_TYPE_NORMAL=0,TsdPlayer._FREQUENCY_TYPE_MSX=1,TsdPlayer._FREQUENCY_TYPE_FM=2,TsdPlayer._FREQUENCY_TYPE_GB_SQUARE=3,TsdPlayer._VOLUME_TYPE_NORMAL=0,TsdPlayer._VOLUME_TYPE_FM=1,TsdPlayer._NOTE_FREQUENCY_TABLE=[null,null,null,null],TsdPlayer._NOTE_PARAMETER_TABLE=[null,null,null,null],TsdPlayer._PARAMETER_FREQUENCY_TABLE=[null,null,null,null],TsdPlayer._FM_VOLUME_TABLE=null,TsdPlayer._MSX_PARAMETER_TABLE=[3421,3228,3047,2876,2715,2562,2419,2283,2155,2034,1920,1812,1711,1614,1524,1438,1358,1281,1210,1142,1078,1017,960,906,855,807,762,719,679,641,605,571,539,509,480,453,428,404,381,360,339,320,302,285,269,254,240,227,214,202,190,180,170,160,151,143,135,127,120,113,107,101,95,90,85,80,76,71,67,64,60,57,53,50,48,45,42,40,38,36,34,32,30,28,27,25,24,22,21,20,19,18,17,16,15,14],function(){var e,t=new Uint16Array(128);TsdPlayer._NOTE_FREQUENCY_TABLE[TsdPlayer._FREQUENCY_TYPE_NORMAL]=t;for(e=0;e<128;e++)t[e]=~~(440*Math.pow(2,(e-69)/12)+.5);t=new Uint16Array(128),TsdPlayer._NOTE_FREQUENCY_TABLE[TsdPlayer._FREQUENCY_TYPE_GB_SQUARE]=t;for(e=0;e<128;e++){var n=440*Math.pow(2,(e-69)/12),r=2048-131072/n+.5;r<0&&(r=0),t[e]=r}t=new Uint16Array(128),TsdPlayer._NOTE_PARAMETER_TABLE[TsdPlayer._FREQUENCY_TYPE_MSX]=t;for(e=0;e<12;e++)t[e]=0;for(e=12;e<108;e++)t[e]=TsdPlayer._MSX_PARAMETER_TABLE[e-12];for(e=108;e<128;e++)t[e]=0;t=new Uint16Array(4096),TsdPlayer._PARAMETER_FREQUENCY_TABLE[TsdPlayer._FREQUENCY_TYPE_MSX]=t,t[0]=0;for(e=1;e<4096;e++)t[e]=~~(111860.78125/e/2+.5);t=new Uint16Array(8192),TsdPlayer._PARAMETER_FREQUENCY_TABLE[TsdPlayer._FREQUENCY_TYPE_FM]=t;for(e=0;e<8192;e++){var i=e>>6,s=e&63,o=(i-69+s/64)/12;t[e]=~~(440*Math.pow(2,o)+.5)}t=new Uint8Array(256),TsdPlayer._FM_VOLUME_TABLE=t;for(e=0;e<256;e++)t[e]=~~(255*Math.pow(10,-0.75*(255-e)/2/20)+.5)}(),TsdPlayer.prototype.setMasterChannel=function(e){this.device=new TssChannel,this.device.setPlayer(this),this.device.setVirtualDevices(this.midi),e.clearChannel(),e.addChannel(this.device)},TsdPlayer.prototype.setMIDI=function(e,t){return e>=TsdPlayer.MAX_MIDI_PORT?!1:(this.midi[e]=t,this.device&&this.device.setVirtualDevices(this.midi),!0)},TsdPlayer.prototype._readI8=function(e){var t=this.input[e];return t>=128&&(t-=256),t},TsdPlayer.prototype._readU16=function(e){return this.input[e]<<8|this.input[e+1]},TsdPlayer.prototype._readU32=function(e){var t=this.input[e]<<24|this.input[e+1]<<16|this.input[e+2]<<8|this.input[e+3];return t<0?4294967296+t:t},TsdPlayer.prototype._clamp=function(e,t,n){return e<t?t:e>n?n:e},TsdPlayer.prototype._setTable=function(e,t){Log.getLog().info("TSD: Set envelope table "+e),Log.getLog().info(t),this.table[e]=t},TsdPlayer.prototype.play=function(e){try{this.input=new Uint8Array(e);var t=TString.createFromUint8Array(this.input);if(!t.containASCII(0,"T'SoundSystem"))return Log.getLog().warn("TSD: magic T'SoundSystem not found."),!1;var n={};n.majorVersion=this.input[14],n.minorVersion=this.input[15],n.fullVersion=n.majorVersion+n.minorVersion/100,Log.getLog().info("TSD: version = "+n.fullVersion);if(n.fullVersion<=.6||TsdPlayer.VERSION<n.fullVersion)return Log.getLog().warn("TSD: unsupported format"),!1;n.titleSize=this._readU16(16),n.title=TString.createFromUint8Array(this.input.subarray(18,18+n.titleSize)).toString(),Log.getLog().info("TSD: title = "+n.title);var r=18+(n.titleSize+1&-2);n.numOfChannel=this._readU16(r),r+=2,Log.getLog().info("TSD: channel = "+n.numOfChannel),this.device.reset(),this.device.setMaxChannel(n.numOfChannel),this.header=n,this.activeChannel=n.numOfChannel;var i=[],s;for(s=0;s<n.numOfChannel;s++){i[s]={id:s,baseOffset:0,size:0,offset:0,loop:{offset:0,count:0},localLoop:[],wait:1,sustain:0,portament:0,detune:0,keyOn:!1,volume:{type:0,l:0,c:0,r:0},pan:TsdPlayer._PAN_C,frequency:{type:0,note:0,param:0,hz:0},tone:0,phase:0,pitchModulation:{enable:!1,base:0,delayCount:0,widthCount:0,deltaCount:0,currentDepth:0,currentHeight:0,currentDiff:0,delay:0,depth:0,width:0,height:0,delta:0},ampEnvelope:{enable:!1,id:0,wait:0,state:0,count:0,volume:{l:0,r:0}},nt:{enable:!1,id:0,wait:0,state:0,count:0}};for(var o=0;o<16;o++)i[s].localLoop[o]={offset:0,count:0,end:0};i[s].baseOffset=this._readU32(r),r+=4,i[s].size=this._readU32(r),r+=4,Log.getLog().info("TSD: ch."+(s+1)+" offset = "+i[s].baseOffset+", size = "+i[s].size)}Log.getLog().info(i),this.channel=i;var u=this._readU32(r);Log.getLog().info("TSD: table offset = "+u),r=u;var a=this._readU16(r);Log.getLog().info("TSD: found "+a+" wave table(s)"),r+=2;for(s=0;s<a;s++){if(32!=this.input[r+1])return Log.getLog().error("TSD: invalid WAVE size"),!1;this.device.setWave(this.input[r],new Int8Array(e,r+2,32)),r+=34}var f=this._readU16(r);Log.getLog().info("TSD: found "+f+" envelope table(s)"),r+=2;for(s=0;s<f;s++){var l=this.input[r+1];this._setTable(this.input[r],new Int8Array(e,r+2,l)),r+=2+l}this.device.setTimerCallback(TsdPlayer._TIMER_AUTOMATION,TsdPlayer._DEFAULT_TIMER_COUNT,this,this._performAutomation),this.device.setTimerCallback(TsdPlayer._TIMER_SEQUENCER,TsdPlayer._DEFAULT_TIMER_COUNT,this,this._performSequencer)}catch(c){return Log.getLog().error("TSD: "+c),!1}return!0},TsdPlayer.prototype._performAutomation=function(){for(var e=0;e<this.header.numOfChannel;e++){var t=this.channel[e];t.keyOn||(0!=t.sustain&&this._performSustain(t),0!=t.portament&&this._performPortament(t)),t.pitchModulation.enable&&this._performPitchModulation(t),t.ampEnvelope.enable&&this._performAmpEnvelope(t)}},TsdPlayer.prototype._performSustain=function(e){e.ampEnvelope.volume.l>e.sustain?e.ampEnvelope.volume.l-=e.sustain:e.ampEnvelope.volume.l=0,e.ampEnvelope.volume.r>e.sustain?e.ampEnvelope.volume.r-=e.sustain:e.ampEnvelope.volume.r=0;var t=e.pan;e.pan=TsdPlayer._PAN_C,this._setVolume(e,TsdPlayer._CH_L,e.ampEnvelope.volume.l),this._setVolume(e,TsdPlayer._CH_R,e.ampEnvelope.volume.r),e.pan=t},TsdPlayer.prototype._performPortament=function(e){var t=e.frequency.hz;switch(e.frequency.type){case TsdPlayer._FREQUENCY_TYPE_NORMAL:e.frequency.param+e.portament<1?e.frequency.param=1:e.frequency.param+e.portament>65535?e.frequency.param=65535:e.frequency.param+=e.portament,t=e.frequency.param;break;case TsdPlayer._FREQUENCY_TYPE_MSX:e.frequency.param-e.portament<0?e.frequency.param=0:e.frequency.param-e.portament>4095?e.frequency.param=4095:e.frequency.param-=e.portament,t=TsdPlayer._PARAMETER_FREQUENCY_TABLE[TsdPlayer._FREQUENCY_TYPE_MSX][e.frequency.param];break;case TsdPlayer._FREQUENCY_TYPE_FM:e.frequency.param+e.portament<0?e.frequency.param=0:e.frequency.param+e.portament>8191?e.frequency.param=8191:e.frequency.param+=e.portament,t=TsdPlayer._PARAMETER_FREQUENCY_TABLE[TsdPlayer._FREQUENCY_TYPE_FM][e.frequency.param
];break;case TsdPlayer._FREQUENCY_TYPE_GB_SQUARE:}this.device.setModuleFrequency(e.id,t)},TsdPlayer.prototype._performPitchModulation=function(e){var t=e.pitchModulation;if(t.delayCount<t.delay){t.delayCount++;return}if(t.delayCount==t.delay){switch(e.frequency.type){case TsdPlayer._FREQUENCY_TYPE_NORMAL:t.base=e.frequency.hz;break;case TsdPlayer._FREQUENCY_TYPE_MSX:t.base=e.frequency.param;break;case TsdPlayer._FREQUENCY_TYPE_FM:t.base=e.frequency.param;break;case TsdPlayer._FREQUENCY_TYPE_GB_SQUARE:}t.currentDepth=t.depth,t.currentHeight=t.height,t.currentDiff=0,t.widthCount=0,t.deltaCount=0,t.delayCount++;return}if(++t.widthCount!=t.width)return;t.widthCount=0,t.currentDiff+=t.currentHeight;if(t.currentDiff>=t.currentDepth||t.currentDiff<=-t.currentDepth)t.currentHeight=-t.currentHeight,t.deltaCount++,t.deltaCount==t.delta&&(t.deltaCount=0,t.currentDepth++);var n=e.frequency.hz,r;switch(e.frequency.type){case TsdPlayer._FREQUENCY_TYPE_NORMAL:n=t.base+t.currentDiff;break;case TsdPlayer._FREQUENCY_TYPE_MSX:r=t.base+t.currentDiff,r<0?r=0:r>4095&&(r=4095),n=TsdPlayer._PARAMETER_FREQUENCY_TABLE[TsdPlayer._FREQUENCY_TYPE_MSX][r];break;case TsdPlayer._FREQUENCY_TYPE_FM:r=t.base+t.currentDiff,r<0?r=0:r>8191&&(r=8191),n=TsdPlayer._PARAMETER_FREQUENCY_TABLE[TsdPlayer._FREQUENCY_TYPE_FM][r];break;case TsdPlayer._FREQUENCY_TYPE_GB_SQUARE:}this.device.setModuleFrequency(e.id,n)},TsdPlayer.prototype._performAmpEnvelope=function(e){var t=e.ampEnvelope;if(++t.count!=t.wait)return;t.count=0;var n=this.table[t.id][t.state];t.state++,t.state==this.table[t.id].length&&t.state--;var r=t.volume.l+n,i=t.volume.r+n;0!=(e.pan&TsdPlayer._PAN_L)?r=this._clamp(r,0,255):r=0,0!=(e.pan&TsdPlayer._PAN_R)?i=this._clamp(i,0,255):i=0,this._setVolume(e,TsdPlayer._CH_L,r),this._setVolume(e,TsdPlayer._CH_R,i)},TsdPlayer.prototype._performSequencer=function(){for(var e=0;e<this.header.numOfChannel;e++){var t=this.channel[e];if(0==t.wait)continue;if(0!=--t.wait)continue;for(;;){var n=this.input[t.baseOffset+t.offset++],r,i;if(n<=TsdPlayer.CMD_LAST_NOTE){this._noteOn(t,n),t.wait=this.input[t.baseOffset+t.offset++],255==t.wait&&(t.wait=this._readU16(t.baseOffset+t.offset),t.offset+=2);if(0!=t.wait)break}else if(n==TsdPlayer.CMD_NOTE_OFF){this._noteOff(t),t.wait=this.input[t.baseOffset+t.offset++],255==t.wait&&(t.wait=this._readU16(t.baseOffset+t.offset),t.offset+=2);if(0!=t.wait)break}else if(n==TsdPlayer.CMD_VOLUME_MONO)r=this.input[t.baseOffset+t.offset++],t.volume.c=r,t.pan&TsdPlayer._PAN_L&&(t.volume.l=r),t.pan&TsdPlayer._PAN_R&&(t.volume.r=r);else if(n==TsdPlayer.CMD_SUSTAIN_MODE)t.sustain=this.input[t.baseOffset+t.offset++];else if(n==TsdPlayer.CMD_DETUNE)t.detune=this._readI8(t.baseOffset+t.offset),t.offset++,this.device.pitchBend(t.id,t.detune*128);else if(n==TsdPlayer.CMD_PORTAMENT)t.portament=this._readI8(t.baseOffset+t.offset),t.offset++,t.pitchModulation.enable=!1;else if(n==TsdPlayer.CMD_VOLUME_LEFT)t.offset++,Log.getLog().info("TSD: volume left");else if(n==TsdPlayer.CMD_VOLUME_RIGHT)t.offset++,Log.getLog().info("TSD: volume right");else if(n==TsdPlayer.CMD_PANPOT){t.pan=this.input[t.baseOffset+t.offset++];if(t.pan!=0){var s=t.pan==1?0:t.pan==2?127:64;this.device.panpot(t.id,s)}}else if(n==TsdPlayer.CMD_RELATIVE_VOLUME_UP)t.offset++,Log.getLog().info("TSD: volume up");else if(n==TsdPlayer.CMD_RELATIVE_VOLUME_DOWN)t.offset++,Log.getLog().info("TSD: volume down");else if(n==TsdPlayer.CMD_TEMPO)r=this._readU16(t.baseOffset+t.offset),t.offset+=2,this._setSequencerFineness(r);else if(n==TsdPlayer.CMD_FINENESS)r=this._readU16(t.baseOffset+t.offset),t.offset+=2,this._setAutomationFineness(r);else if(n==TsdPlayer.CMD_KEY_ON_PHASE)t.offset++,Log.getLog().info("TSD: key on phase");else if(n==TsdPlayer.CMD_MULTIPLE)t.offset++,Log.getLog().info("TSD: multiple");else if(n==TsdPlayer.CMD_PITCH_MODULATION_DELAY)r=this._readU16(t.baseOffset+t.offset),t.offset+=2,t.pitchModulation.delay=r,t.pitchModulation.enable=0!=r,t.portament=0;else if(n==TsdPlayer.CMD_PITCH_MODULATION_DEPTH)r=this.input[t.baseOffset+t.offset++],t.pitchModulation.depth=r;else if(n==TsdPlayer.CMD_PITCH_MODULATION_WIDTH)r=this.input[t.baseOffset+t.offset++],t.pitchModulation.width=r;else if(n==TsdPlayer.CMD_PITCH_MODULATION_HEIGHT)r=this._readI8(t.baseOffset+t.offset),t.offset++,t.pitchModulation.height=r;else if(n==TsdPlayer.CMD_PITCH_MODULATION_DELTA)r=this.input[t.baseOffset+t.offset++],t.pitchModulation.delta=r;else if(n==TsdPlayer.CMD_AMP_EMVELOPE)r=this.input[t.baseOffset+t.offset++],t.ampEnvelope.id=r,r=this.input[t.baseOffset+t.offset++],t.ampEnvelope.wait=r,t.ampEnvelope.enable=0!=r;else if(n==TsdPlayer.CMD_ENDLESS_LOOP_POINT)t.loop.offset=t.offset;else if(n==TsdPlayer.CMD_LOCAL_LOOP_START)r=this.input[t.baseOffset+t.offset++],t.localLoop[r].count=this.input[t.baseOffset+t.offset++],t.localLoop[r].offset=t.offset;else if(n==TsdPlayer.CMD_LOCAL_LOOP_BREAK)r=this.input[t.baseOffset+t.offset++],t.localLoop[r].count==1&&(t.offset=t.localLoop[r].end);else if(n==TsdPlayer.CMD_LOCAL_LOOP_END)r=this.input[t.baseOffset+t.offset++],t.localLoop[r].end=t.offset,0!=--t.localLoop[r].count&&(t.offset=t.localLoop[r].offset);else if(n==TsdPlayer.CMD_FREQUENCY_MODE_CHANGE)t.frequency.type=this.input[t.baseOffset+t.offset++];else if(n==TsdPlayer.CMD_VOLUME_MODE_CHANGE)t.volume.type=this.input[t.baseOffset+t.offset++];else if(n==TsdPlayer.CMD_FM_IN)r=this.input[t.baseOffset+t.offset++],this._setFmInPipe(t,r>>4,r&15);else if(n==TsdPlayer.CMD_FM_OUT)r=this.input[t.baseOffset+t.offset++],this._setFmOutPipe(t,r>>4,r&15);else if(n==TsdPlayer.CMD_CONTROL_CHANGE)Log.getLog().error("TSD: control change is not implemented.");else if(n==TsdPlayer.CMD_PORT_CHANGE)r=this.input[t.baseOffset+t.offset++],i=this.input[t.baseOffset+t.offset++],this._setPort(t,r,i);else if(n==TsdPlayer.CMD_VOICE_CHANGE)r=this.input[t.baseOffset+t.offset++],this._setVoice(t,r);else if(n==TsdPlayer.CMD_MODULE_CHANGE)r=this.input[t.baseOffset+t.offset++],this._setModule(t,r);else{if(n!=TsdPlayer.CMD_END){Log.getLog().error("TSD: unsupported cmd "+n.toString(16)),Log.getLog().info(this);break}if(0==t.loop.offset){this._noteOff(t),this.activeChannel--;break}t.offset=t.loop.offset,t.loop.count++}}}},TsdPlayer.prototype._noteOn=function(e,t){var n=e.frequency.type,r,i;switch(n){case TsdPlayer._FREQUENCY_TYPE_NORMAL:r=e.detune+TsdPlayer._NOTE_FREQUENCY_TABLE[n][t],i=r;break;case TsdPlayer._FREQUENCY_TYPE_MSX:r=e.detune+TsdPlayer._NOTE_PARAMETER_TABLE[n][t],i=TsdPlayer._PARAMETER_FREQUENCY_TABLE[n][r];break;case TsdPlayer._FREQUENCY_TYPE_FM:r=e.detune+t<<6,i=TsdPlayer._PARAMETER_FREQUENCY_TABLE[n][r];break;case TsdPlayer._FREQUENCY_TYPE_GB_SQUARE:r=e.detune+TsdPlayer._NOTE_FREQUENCY_TABLE[n][t],i=r}this.device.setModuleFrequency(e.id,i),e.frequency.note=t,e.frequency.param=r,e.frequency.hz=i,this._setVolume(e,TsdPlayer._CH_L,e.volume.l),this._setVolume(e,TsdPlayer._CH_R,e.volume.r),this._setVolume(e,TsdPlayer._CH_C,e.volume.c),e.keyOn&&this.device.keyOff(e.id),e.keyOn=!0,this.device.setModulePhase(e.id,e.phase),this.device.keyOn(e.id,t),e.ampEnvelope.volume.l=e.volume.l,e.ampEnvelope.volume.r=e.volume.r,e.ampEnvelope.state=0,e.ampEnvelope.count=0,e.pitchModulation.delayCount=0},TsdPlayer.prototype._noteOff=function(e){0==e.sustain&&(e.ampEnvelope.enable?(e.ampEnvelope.volume.l=this.device.getModuleVolume(e.id,TsdPlayer._CH_L),e.ampEnvelope.volume.r=this.device.getModuleVolume(e.id,TsdPlayer._CH_R)):(this.device.setModuleVolume(e.id,TsdPlayer._CH_L,0),this.device.setModuleVolume(e.id,TsdPlayer._CH_R,0))),e.keyOn=!1,this.device.keyOff(e.id)},TsdPlayer.prototype._setVolume=function(e,t,n){var r=n;TsdPlayer._CH_L==t&&0==(e.pan&TsdPlayer._PAN_L)?r=0:TsdPlayer._CH_R==t&&0==(e.pan&TsdPlayer._PAN_R)?r=0:TsdPlayer._VOLUME_TYPE_FM==e.volume.type&&(r=TsdPlayer._FM_VOLUME_TABLE[r]),this.device.setModuleVolume(e.id,t,r)},TsdPlayer.prototype._setSequencerFineness=function(e){this.device.setTimerCallback(TsdPlayer._TIMER_SEQUENCER,e,this,this._performSequencer)},TsdPlayer.prototype._setAutomationFineness=function(e){this.device.setTimerCallback(TsdPlayer._TIMER_AUTOMATION,e,this,this._performAutomation)},TsdPlayer.prototype._setFmInPipe=function(e,t,n){var r=t;0!=r&&(r=9-r),this.device.setModuleFmInPipe(e.id,r,n)},TsdPlayer.prototype._setFmOutPipe=function(e,t,n){this.device.setModuleFmOutPipe(e.id,t,n)},TsdPlayer.prototype._setPort=function(e,t,n){this.device.setModulePort(e.id,t,n)},TsdPlayer.prototype._setVoice=function(e,t){this.device.setModuleVoice(e.id,t);if(TssChannel.Module.TYPE_SIN!=this.device.getModuleType(e.id))return;var n=t>>4,r=t&15;0!=n?this._setFmInPipe(e,5,n%5-1):this._setFmInPipe(e,0,0),0!=r?this._setFmOutPipe(e,1,r%5-1):this._setFmOutPipe(e,0,0)},TsdPlayer.prototype._setModule=function(e,t){this.device.setModuleType(e.id,t&15),0!=(t&128)?e.frequency.type=t>>7:e.frequency.type=t>>4},TssCompiler.VERSION=.94,TssCompiler.HARDWARE_MODE_NORMAL=0,TssCompiler.HARDWARE_MODE_FAMICOM=1,TssCompiler.HARDWARE_MODE_GAMEBOY=2,TssCompiler.VOLUME_RANGE_MODE_NORMAL=0,TssCompiler.VOLUME_RANGE_MODE_UPPER=1,TssCompiler.VOLUME_RELATIVE_MODE_NORMAL=0,TssCompiler.VOLUME_RELATIVE_MODE_REVERSE=1,TssCompiler.OCTAVE_MODE_NORMAL=0,TssCompiler.OCTAVE_MODE_REVERSE=1,TssCompiler._DEFAULT_FINENESS=368,TssCompiler._ALPHABET_COUNT="z".charCodeAt(0)-"a".charCodeAt(0)+1,TssCompiler._CODE_ESCAPE="\\".charCodeAt(0),TssCompiler._CODE_SHARP="#".charCodeAt(0),TssCompiler._CODE_GT=">".charCodeAt(0),TssCompiler._TONE_TABLE={c:0,d:2,e:4,f:5,g:7,a:9,b:11},TssCompiler._TRIANGLE_TABLE=[0,16,32,48,64,80,96,112,127,112,96,80,64,48,32,16,0,-16,-32,-48,-64,-80,-96,-112,-128,-112,-96,-80,-64,-48,-32,-16],TssCompiler.CompileError=function(e,t,n){this.line=e,this.offset=t,this.message=n},TssCompiler.CompileError.prototype.toString=function(){var e=0,t,n,r=this.line.data;for(n=0;n<=this.offset;n++){t=r.at(n);if(0==t||TssCompiler._CODE_ESCAPE==t)continue;e++}var i=new Uint8Array(e--);for(n=0;n<e;n++)i[n]=32;i[n]="^".charCodeAt(0);var s=TString.createFromUint8Array(i).toString();return"TSS: { line: "+this.line.line+", offset: "+this.offset+" } "+this.message+"\n"+r.toString()+"\n"+s},TssCompiler._toUint8=function(e){if(e<-128||127<e)throw new RangeError("unsupported range");return e<0&&(e=256+e),e&255},TssCompiler._getBracedParameter=function(e,t){var n=e.data,r=n.byteLength(),i=t+n.countSpaces(t);if(i>=r||"<"!=n.charAt(i))return{begin:i,end:i,parameter:undefined};i++;var s=0,o=0;for(var u=i;u<r;u++){o=n.at(u);if(0==o||TssCompiler._CODE_ESCAPE==o)continue;if(TssCompiler._CODE_GT==o)break;s++}var a=i+s-1,f=TString.createFromUint8Array(new Uint8Array(s));s=0;for(u=i;u<=a;u++){o=n.at(u);if(0==o||TssCompiler._CODE_ESCAPE==o)continue;f.setAt(s++,o)}return{begin:i-1,end:a+1,parameter:f}},TssCompiler._getNumberParameter=function(e,t){var n=e.data,r=t+n.countSpaces(t),i=n.byteLength();if(r>=i)return{begin:r,end:r,parameter:undefined};var s=1;"-"==n.charAt(r)&&(r++,r+=n.countSpaces(r),s=-1);var o=n.numberAt(r);if(o<0)return{begin:r,end:r,parameter:undefined};var u=0;for(var a=r+1;a<i;a++){u=n.at(a);if(0==u||TssCompiler._CODE_ESCAPE==u)continue;var f=n.numberAt(a);if(f<0)return{begin:r,end:a-1,parameter:s*o};o=o*10+f}return{begin:r,end:a-1,parameter:s*o}},TssCompiler._getStringParameter=function(e,t){var n=e.data,r=t+n.countSpaces(t),i=n.byteLength(),s=0,o=0;for(var u=r;u<i;u++){o=n.at(u);if(0==o||TssCompiler._CODE_ESCAPE==o)continue;s++}var a=r+s-1,f=TString.createFromUint8Array(new Uint8Array(s));s=0;for(u=r;u<=a;u++){o=n.at(u);if(0==o||TssCompiler._CODE_ESCAPE==o)continue;f.setAt(s++,o)}return{begin:r,end:a,parameter:f}},TssCompiler._getTableParameter=function(e,t){var n={lines:e,line:0,offset:t},r=[],i=n.offset,s=n.lines[0].directive,o=TssCompiler._getNumberParameter(n.lines[n.line],n.offset);if(typeof o.parameter=="undefined")throw new TssCompiler.CompileError(n.lines[n.line],o.begin,"id number not found in #"+s);var u=o.parameter;if(u<0||255<u)throw new TssCompiler.CompileError(n.lines[n.line],o.begin,"id "+u+" is out or range 0 to 255 in #"+s);n.offset=o.end+1,TssCompiler._checkCharacter(n,",","',' not found after id number in #"+s),TssCompiler._checkCharacter(n,"<","'<' not found in #"+s);for(;;){var a=TssCompiler._findNextCharacter(n,"incomplete entry in #"+s);if("("==a){n.offset++;var f="number not found after '(' in #"+s;TssCompiler._findNextCharacter(n,f),o=TssCompiler._getNumberParameter(n.lines[n.line],n.offset);if(typeof o.parameter=="undefined")throw new TssCompiler.CompileError(n.lines[n.line],o.begin,f);var l=o.parameter,c="number is out of range -128 to 127 in #"+s;if(l<-128||127<l)throw new TssCompiler.CompileError(n.lines[n.line],o.begin,c);n.offset=o.end+1,TssCompiler._checkCharacter(n,",","',' not found after the first number after '(' in #"+s);var h="the second number not found after '(' in #"+s;TssCompiler._findNextCharacter(n,h),o=TssCompiler._getNumberParameter(n.lines[n.line],n.offset);if(typeof o.parameter=="undefined")throw new TssCompiler.CompileError(n.lines[n.line],o.begin,h);var p=o.parameter;if(p<-128||127<p)throw new TssCompiler.CompileError(n.lines[n.line],o.begin,c);n.offset=o.end+1,TssCompiler._checkCharacter(n,")","')' not found after the second number in #"+s),TssCompiler._checkCharacter(n,",","',' not found after '(x,y)' syntax in #"+s);var d="number not found after '(x,y),' syntax in #"+s;TssCompiler._findNextCharacter(n,d),o=TssCompiler._getNumberParameter(n.lines[n.line],n.offset);if(typeof o.parameter=="undefined")throw new TssCompiler.CompileError(n.lines[n.line],o.begin,d);var v=o.parameter;n.offset=o.end+1;var m=[];for(var g=0;g<v;g++){var y=~~(l+(p-l)*g/(v-1));m.push(y),r.push(y)}Log.getLog().info("TSS: expanding ("+l+","+p+"),"+v+" to "+m)}else{var b="number not found in #"+s;TssCompiler._findNextCharacter(n,b),o=TssCompiler._getNumberParameter(n.lines[n.line],n.offset);if(typeof o.parameter=="undefined")throw new TssCompiler.CompileError(n.lines[n.line],o.begin,b);if(o.parameter<-128||127<o.parameter)throw new TssCompiler.CompileError(n.lines[n.line],o.begin,c);n.offset=o.end+1,r.push(o.parameter)}var w="',' or '>' not found in #"+s;a=TssCompiler._findNextCharacter(n,w);if(","!=a){if(">"==a){n.offset++;break}throw new TssCompiler.CompileError(n.lines[n.line],n.offset,w)}n.offset++}try{TssCompiler._findNextCharacter(n,"")}catch(E){return Log.getLog().info("TSS: table complete "+r),{begin:i,end:n.offset,parameter:{id:u,table:r}}}throw new TssCompiler.CompileError(n.lines[n.line],n.offset,"unknown data after table in #"+s)},TssCompiler._getCharacter=function(e,t,n){var r=e.data,i=t+r.countSpaces(t);return i>=r.byteLength()?-1:n!=r.charAt(i)?-1:i},TssCompiler._findNextCharacter=function(e,t){var n=e.lines.length;TssCompiler._checkEnd(e.lines[e.line],e.offset)&&e.line+1<n&&(e.line++,e.offset=0),e.offset+=e.lines[e.line].data.countSpaces(e.offset);if(e.offset==e.lines[e.line].data.byteLength())throw new TssCompiler.CompileError(e.lines[e.line],e.offset,t);return e.lines[e.line].data.charAt(e.offset)},TssCompiler._checkCharacter=function(e,t,n){TssCompiler._findNextCharacter(e,n);var r=TssCompiler._getCharacter(e.lines[e.line],e.offset,t);if(r<0)throw new TssCompiler.CompileError(e.lines[e.line],e.offset,n);e.offset=r+1},TssCompiler._checkEnd=function(e,t){var n=e.data;return t+=n.countSpaces(t),t==n.byteLength()},TssCompiler._checkChannelDirective=function(e){if(2<e.directive.length||0==e.directive.length)return;var t=TString.createFromString(e.directive),n=0,r=0,i;if(2==t.byteLength()){i=t.alphabetIndex(r++);if(i<0)return;n=i*TssCompiler._ALPHABET_COUNT}i=t.alphabetIndex(r);if(i<0)return;n+=i,e.directive=n},TssCompiler._checkDirective=function(e){var t=e.data,n=t.byteLength(),r=0;for(var i=0;i<n;i++){r=t.at(i);if(0==r)continue;if(TssCompiler._CODE_SHARP==r){t.setAt(i++,0);break}e.directive=null;return}for(var s=i;i<n;i++)if(32==t.at(i))break;e.directive=t.slice(s,i).toString();for(var o=s;o<i;o++)t.setAt(o,0);TssCompiler._checkChannelDirective(e)},TssCompiler.prototype._setWave=function(e,t){Log.getLog().info("TSC: set wave "+e),this.waves[e]||this.validWaves++,this.waves[e]=t},TssCompiler.prototype._setTable=function(e,t){Log.getLog().info("TSC: set table "+e+"; size = "+t.length),this.tables[e]||this.validTables++,this.tables[e]=t},TssCompiler.prototype._preprocessLine=function(e,t,n){var r={line:e.line,offset:t,count:n,data:null,empty:!0,directive:null,continuation:!1},i=this.source.slice(t,t+n);r.data=i;for(var s=0;s<n;s++){var o=i.charAt(s);if(e.commentNest>0)"\\"==o?i.setAt(s++,0):"{"==o?e.commentNest++:"}"==o&&e.commentNest--,i.setAt(s,0);else if("\\"==o)i.setAt(s++,0),r.empty=!1;else if("{"==o)e.commentNest++,i.setAt(s,0);else if("}"==o){e.commentNest--,i.setAt(s,0);if(e.commentNest<0)throw new TssCompiler.CompileError(r,s,"'}' appears without '{'")}else"	"==o&&i.setAt(s,32),r.empty=!1}return r.empty||TssCompiler._checkDirective(r),r},TssCompiler.prototype._parseLines=function(){var e={line:1,commentNest:0},t=null,n=this.source.byteLength();for(var r=0;r<n;e.line++){var i=this.source.countLine(r),s=this._preprocessLine(e,r,i);if(!s.empty){if(null==s.directive){if(null==t)throw new TssCompiler.CompileError(s,0,"invalid line without any directive");s.directive=t,s.continuation=!0}else t=s.directive;if(typeof s.directive=="number")undefined==this.channels[s.directive]&&(this.channels[s.directive]=[]),this.channels[s.directive].push(s);else{if("END"==s.directive)break;this.directives.push(s)}}r+=i,r+=this.source.countLineDelimiter(r)}Log.getLog().info("TSS: found "+this.directives.length+" directive(s)"),Log.getLog().info("TSS: found "+this.channels.length+" channel(s)");for(var o=0;o<this.channels.length;o++){var u=0;undefined!=this.channels[o]&&(u=this.channels[o].length),Log.getLog().info("TSS: channel "+(o+1)+" has "+u+" line(s)")}},TssCompiler.prototype._parseDirectives=function(){for(var e=0;e<this.directives.length;e++){var t=this.directives[e].directive,n=0,r;if("CHANNEL"==t){r=TssCompiler._getNumberParameter(this.directives[e],0);if(typeof r.parameter=="undefined")throw new TssCompiler.CompileError(this.directives[e],r.begin,"number not found in #CHANNEL");this.tags.channels=r.parameter,n=r.end+1,Log.getLog().info("TSS: CHANNEL> "+this.tags.channels)}else if("FINENESS"==t){r=TssCompiler._getNumberParameter(this.directives[e],0);if(typeof r.parameter=="undefined")throw new TssCompiler.CompileError(this.directives[e],r.begin,"number not found in #FINENESS");this.tags.fineness=r.parameter,n=r.end+1,Log.getLog().info("TSS: FINENESS> "+this.tags.fineness)}else if("OCTAVE"==t){r=TssCompiler._getStringParameter(this.directives[e],0);if(!r.parameter)throw new TssCompiler.CompileError(this.directives[e],r.begin,"syntax error in #PRAGMA");var i=r.parameter.toString();if(i=="NORMAL")this.modes.octave=TssCompiler.OCTAVE_MODE_NORMAL;else{if(i!="REVERSE")throw new TssCompiler.CompileError(this.directive[e],r.begin,"invalid argument in #OCTAVE");this.modes.octave=TssCompiler.OCTAVE_MODE_REVERSE}n=r.end+1}else if("PRAGMA"==t){r=TssCompiler._getStringParameter(this.directives[e],0);if(!r.parameter)throw new TssCompiler.CompileError(this.directives[e],r.begin,"syntax error in #PRAGMA");var s=r.parameter.toString();if(s=="FAMICOM")this.modes.hardware=TssCompiler.HARDWARE_MODE_FAMICOM,this._setWave(0,TssCompiler._TRIANGLE_TABLE);else{if(s!="GAMEBOY")throw new TssCompiler.CompileError(this.directives[e],r.begin,"unknown pragma parameter "+s);this.modes.hardware=TssCompiler.HARDWARE_MODE_GAMEBOY}n=r.end+1,Log.getLog().info("TSS: PRAGMA> "+s)}else if("TABLE"==t){var o=[];for(;;e++){o.push(this.directives[e]);if(e+1==this.directives.length)break;if(!this.directives[e+1].continuation)break}r=TssCompiler._getTableParameter(o,0),this._setTable(r.parameter.id,r.parameter.table),n=r.end}else if("TITLE"==t){r=TssCompiler._getBracedParameter(this.directives[e],0);if(!r.parameter)throw new TssCompiler.CompileError(this.directives[e],r.begin,"syntax error in #TITLE");this.tags.title=r.parameter,n=r.end+1,Log.getLog().info("TSS: TITLE> "+this.tags.title.toString())}else if("VOLUME"==t){r=TssCompiler._getStringParameter(this.directives[e],0);if(!r.parameter)throw new TssCompiler.CompileError(this.directives[e],r.begin,"syntax error in #VOLUME");var u=r.parameter.toString();if(u=="NORMAL")this.modes.volumeRelative=TssCompiler.VOLUME_RELATIVE_MODE_NORMAL;else{if(u!="REVERSE")throw new TssCompiler.CompileError(this.directive[e],r.begin,"invalid argument in #VOLUME");this.modes.volumeRelative=TssCompiler.VOLUME_RELATIVE_MODE_REVERSE}n=r.end+1}else{if("WAV"!=t)throw new TssCompiler.CompileError(this.directives[e],0,"unknown directive: "+t);var o=[];for(;;e++){o.push(this.directives[e]);if(e+1==this.directives.length)break;if(!this.directives[e+1].continuation)break}r=TssCompiler._getTableParameter(o,0);if(32!=r.parameter.table.length)throw new TssCompiler.CompileError(this.directive[e],r.begin,"invalid wave table size "+r.parameter.table.length);this._setWave(r.parameter.id,r.parameter.table),n=r.end}if(!TssCompiler._checkEnd(this.directives[e],n))throw new TssCompiler.CompileError(this.directives[e],n,"syntax error after #"+t)}},TssCompiler.prototype._parseChannels=function(){var e=16,t=function(e,t,n,r){throw new TssCompiler.CompileError(t.lineObject,t.offset,"command '"+n+"' not implemented")},n=function(e,t,n,r){var i=255;t.mode==TssCompiler.HARDWARE_MODE_GAMEBOY&&(i=16);var s="(";t.volumeRelativeMode!=TssCompiler.VOLUME_RELATIVE_MODE_NORMAL&&(s=")");var o=t.currentVolume.r>=0;n==s?(t.currentVolume.l+=1<<t.volumeShift,o&&(t.currentVolume.r+=1<<t.volumeShift)):(t.currentVolume.l-=1<<t.volumeShift,o&&(t.currentVolume.r-=1<<t.volumeShift));if(t.currentVolume.l<0||t.currentVolume.l>i||o&&t.currentVolume.r<0||o&&t.currentVolume.r>i)throw new TssCompiler.CompileError(t.lineObject,t.offset,"commmand '"+n+"' causes volume range error");o?(t.data.push(TsdPlayer.CMD_VOLUME_LEFT),t.data.push(t.currentVolume.l),t.data.push(TsdPlayer.CMD_VOLUME_RIGHT),t.data.push(t.currentVolume.r)):(t.data.push(TsdPlayer.CMD_VOLUME_MONO),t.data.push(t.currentVolume.l))},r={$:{args:[],callback:function(e,t,n,r){t.data.push(TsdPlayer.CMD_ENDLESS_LOOP_POINT)}},"%":{args:[{def:0,min:0,max:255}],callback:function(e,t,n,r){if(TssCompiler.HARDWARE_MODE_FAMICOM==t.mode||TssCompiler.HARDWARE_MODE_GAMEBOY==t.mode)throw new TssCompiler.CompileError(t.lineObject,t.offset,"'%' is not supported in NES/GameBoy mode");t.data.push(TsdPlayer.CMD_MODULE_CHANGE),t.data.push(r[0])}},"(":{args:[],callback:n},")":{args:[],callback:n},"/":{sequence:":",args:[],callback:function(e,t,n,r){if(t.localLoopId==0)throw new TssCompiler.CompileError(t.lineObject,t.offset,"'/' found without '/:'");t.data.push(TsdPlayer.CMD_LOCAL_LOOP_BREAK),t.data.push(t.localLoopId-1)}},"/:":{args:[{def:2,min:2,max:255}],callback:function(e,t,n,r){if(t.localLoopId>15)throw new TssCompiler.CompileError(t.lineObject,t.offset,"local loop is too deep (>16)");t.data.push(TsdPlayer.CMD_LOCAL_LOOP_START),t.data.push(t.localLoopId++),t.data.push(r[0])}},":":{sequence:"/"},":/":{args:[],callback:function(e,t,n,r){if(t.localLoopId==0)throw new TssCompiler.CompileError(t.lineObject,t.offset,"':/' found without '/:'");t.data.push(TsdPlayer.CMD_LOCAL_LOOP_END),t.data.push(--t.localLoopId)}},"<":{args:[],callback:function(e,t,n,r){TssCompiler.OCTAVE_MODE_NORMAL==t.octaveMode?t.currentOctave++:t.currentOctave--}},">":{args:[],callback:function(e,t,n,r){TssCompiler.OCTAVE_MODE_NORMAL==t.octaveMode?t.currentOctave--:t.currentOctave++}},"@":{sequence:"ciopv",args:[{def:0,min:0,max:255}],callback:function(e,t,n,r){if(TssCompiler.HARDWARE_MODE_FAMICOM==t.mode){if(t.lineObject.directive==2)throw new TssCompiler.CompileError(t.lineObject,t.offset,"'@' is not supported in famicom mode channel 3");if(2!=r[0]&&4!=r[0]&&6!=r[0]&&7!=r[0])throw new TssCompiler.CompileError(t.lineObject,t.offset,"voice id "+r[0]+" is invalid in famicom mode")}t.data.push(TsdPlayer.CMD_VOICE_CHANGE),t.data.push(r[0])}},"@c":{args:[{def:0,min:0,max:127},{def:0,min:0,max:127}],callback:function(e,t,n,r){t.data.push(TsdPlayer.CMD_CONTROL_CHANGE),t.data.push(r[0]),t.data.push(r[1])}},"@i":{args:[{def:0,min:0,max:8},{def:0,min:0,max:3}],callback:function(e,t,n,r){t.data.push(TsdPlayer.CMD_FM_IN),t.data.push(r[0]<<4|r[1])}},"@o":{args:[{def:0,min:0,max:2},{def:0,min:0,max:3}],callback:function(e,t,n,r){t.data.push(TsdPlayer.CMD_FM_OUT),t.data.push(r[0]<<4|r[1])}},"@p":{args:[{def:0,min:0,max:3},{def:0,min:0,max:127}],callback:function(e,t,n,r){t.data.push(TsdPlayer.CMD_PORT_CHANGE),t.data.push(r[0]),t.data.push(r[1])}},"@v":{args:[{def:10,min:0,max:255},{def:0,min:0,max:255}],callback:function(e,t,n,r){t.volumeShift=0,1==r.length?(t.currentVolume.l=r[0],t.currentVolume.r=-1,t.data.push(TsdPlayer.CMD_VOLUME_MONO),t.data.push(r[0])):(t.currentVolume.l=r[0],t.currentVolume.r=r[1],t.data.push(TsdPlayer.CMD_VOLUME_LEFT),t.data.push(r[0]),t.data.push(TsdPlayer.CMD_VOLUME_RIGHT),t.data.push(r[1]))}},"]":{args:[],callback:function(e,t,n,r){if(0==t.loop.count)throw new TssCompiler.CompileError(t.lineObject,t.offset,"']' found without '['");if(--t.loop.count==0)return;t.loop.end.line=t.line,t.loop.end.offset=t.offset,t.line=t.loop.line,t.offset=t.loop.offset,t.lineObject=e.channels[t.lineObject.directive][t.line]}},"[":{args:[{def:2,min:2,max:65535}],callback:function(e,t,n,r){t.loop.count=r[0],t.loop.line=t.line,t.loop.offset=t.offset}},_:{args:[],callback:t},"|":{args:[],callback:function(e,t,n,r){if(t.loop.count>1)return;t.line=t.loop.end.line,t.offset=t.loop.end.offset,t.lineObject=e.channels[t.lineObject.directive][t.line]}},"~":{args:[],callback:t},k:{args:[{def:0,min:-128,max:127}],callback:function(e,t,n,r){t.data.push(TsdPlayer.CMD_DETUNE),t.data.push(TssCompiler._toUint8(r[0]))}},l:{args:[{def:4,min:1,max:1024}],callback:function(e,t,n,r){t.defaultLength=r[0],t.defaultDot=0;for(;;){var i=TssCompiler._getCharacter(t.lineObject,t.offset,".");if(i<0)break;t.offset=i+1,t.defaultDot++}}},m:{sequence:"p",args:[],callback:t},mp:{args:[{def:undefined,min:0,max:65535},{def:undefined,min:0,max:255},{def:undefined,min:0,max:255},{def:undefined,min:-128,max:127},{def:undefined,min:0,max:255}],callback:function(e,t,n,r){typeof r[0]!="undefined"&&(t.data.push(TsdPlayer.CMD_PITCH_MODULATION_DELAY),t.data.push(r[0]>>8),t.data.push(r[0]&255));if(r.length<2)return;typeof r[1]!="undefined"&&(t.data.push(TsdPlayer.CMD_PITCH_MODULATION_DEPTH),t.data.push(r[1]));if(r.length<3)return;typeof r[2]!="undefined"&&(t.data.push(TsdPlayer.CMD_PITCH_MODULATION_WIDTH),t.data.push(r[2]));if(r.length<4)return;typeof r[3]!="undefined"&&(t.data.push(TsdPlayer.CMD_PITCH_MODULATION_HEIGHT),t.data.push(TssCompiler._toUint8(r[3])));if(r.length<5)return;typeof r[4]!="undefined"&&(t.data.push(TsdPlayer.CMD_PITCH_MODULATION_DELTA),t.data.push(r[4]))}},n:{sequence:"ast"},na:{args:[{def:0,min:0,max:255},{def:0,min:0,max:255}],callback:function(e,t,n,r){t.data.push(TsdPlayer.CMD_AMP_EMVELOPE),t.data.push(r[0]),t.data.push(r[1])}},ns:{args:[],callback:t},nt:{args:[],callback:t},o:{args:[{def:4,min:0,max:10}],callback:function(e,t,n,r){t.currentOctave=r[0]}},p:{sequence:"h",args:[{def:0,min:0,max:3}],callback:function(e,t,n,r){t.data.push(TsdPlayer.CMD_PANPOT),t.data.push(r[0])}},ph:{args:[],callback:t},q:{args:[{def:e,min:0,max:e}],callback:function(e,t,n,r){t.currentGate=r[0]}},r:{args:[],callback:function(e,t,n,r){if("r"!=n)if(t.currentOctave<0||10<t.currentOctave)throw new TssCompiler.CompileError(t.lineObject,t.offset,"current octave is out of range");t.offset+=t.lineObject.data.countSpaces(t.offset);var i=0;if(t.offset<t.lineObject.data.byteLength()){var s=t.lineObject.data.charAt(t.offset);if("-"==s||"+"==s||"#"==s)t.offset++,"-"==s?i=-1:i=1}var o=0;for(;;){var u=TssCompiler._getNumberParameter(t.lineObject,t.offset),a=0,f=0;typeof u.parameter=="undefined"?(a=t.defaultLength,f=t.defaultDot):(a=u.parameter,t.offset=u.end+1);for(;;){var l=TssCompiler._getCharacter(t.lineObject,t.offset,".");if(l<0)break;t.offset=l+1,f++}0!=t.clock%a&&Log.getLog().warn("TSS: time resolution is not enough for length "+a);var c=~~(t.clock/a);o+=c;while(f-->0){if(0!=c%2)throw new TssCompiler.CompileError(t.lineObject,t.offset,"too many '.' against time resolution");c/=2,o+=c}l=TssCompiler._getCharacter(t.lineObject,t.offset,"^");if(l<0)break;t.offset=l+1}var h=0;t.count+=o,"r"==n?t.data.push(TsdPlayer.CMD_NOTE_OFF):(i+=t.currentOctave*12+TssCompiler._TONE_TABLE[n],i<0?(Log.getLog().warn("TSS: too low tone (clamped)"),i=0):i>127&&(Log.getLog().warn("TSS: too high tone (clamped)"),i=127),t.data.push(i),h=o,o=~~(o*t.currentGate/t.maxGate),h-=o),e.logMmlCompile&&Log.getLog().info(o+","+h);if(o<255)t.data.push(o);else{if(!(o<65535))throw new TssCompiler.CompileError(t.lineObject,t.offset,"note length is too long");t.data.push(255),t.data.push(o>>8),t.data.push(o&255)}if(h>0){t.data.push(TsdPlayer.CMD_NOTE_OFF);if(h<255)t.data.push(h);else{if(!(h<65535))throw new TssCompiler.CompileError(t.lineObject,t.offset,"rest length is too long");t.data.push(255),t.data.push(h>>8),t.data.push(h&255)}}}},s:{args:[{def:undefined,min:0,max:255},{def:undefined,min:-128,max:127}],callback:function(e,t,n,r){typeof r[0]!="undefined"&&(t.data.push(TsdPlayer.CMD_SUSTAIN_MODE),t.data.push(r[0])),2==r.length&&typeof r[1]!="undefined"&&(t.data.push(TsdPlayer.CMD_PORTAMENT),t.data.push(TssCompiler._toUint8(r[1])))}},t:{args:[{def:120,min:1,max:512}],callback:function(e,t,n,r){var i=~~(27562.5/r[0]);t.data.push(TsdPlayer.CMD_TEMPO),t.data.push(i>>8),t.data.push(i&255)}},v:{args:[{def:10,min:0,max:15},{def:0,min:0,max:15}],callback:function(e,t,n,r){if(TsdPlayer.HARDWARE_MODE_GAMEBOY==t.mode&&2==t.lineObject.directive)for(var i=0;i<r.length;i++)if(r[i]>3)throw new TssCompiler.CompileError(t.lineObject,t.offset,"volume must be less than 4 for channel 2 in gameboy mode");var s=0;t.volumeShift=3,TsdPlayer.HARDWARE_MODE_GAMEBOY==t.mode?t.volumeShift=0:TssCompiler.VOLUME_RANGE_MODE_NORMAL==t.volumeRangeMode?t.volumeShift=4:s=128,1==r.length?(t.currentVolume.l=s+(r[0]<<t.volumeShift),t.currentVolume.r=-1,t.data.push(TsdPlayer.CMD_VOLUME_MONO),t.data.push(t.currentVolume.l)):(t.currentVolume.l=s+(r[0]<<t.volumeShift),t.currentVolume.r=s+(r[1]<<t.volumeShift),t.data.push(TsdPlayer.CMD_VOLUME_LEFT),t.data.push(t.currentVolume.l),t.data.push(TsdPlayer.CMD_VOLUME_RIGHT),t.data.push(t.currentVolume.r))}},x:{args:[{def:undefined,min:0,max:17},{def:undefined,min:0,max:3}],callback:function(e,t,n,r){if(r[0]!=undefined){if((r[0]&15)>1)throw new TssCompiler.CompileError(t.lineObject,t.offset,"invalid volume mode "+r[0]+" for 'x'");(r[0]&16)==0?t.volumeRangeMode=TssCompiler.VOLUME_RANGE_MODE_NORMAL:t.volumeRangeMode=TssCompiler.VOLUME_RANGE_MODE_UPPER,t.data.push(TsdPlayer.CMD_VOLUME_MODE_CHANGE),t.data.push(r[0]&15)}r[1]!=undefined&&(t.data.push(TsdPlayer.CMD_FREQUENCY_MODE_CHANGE),t.data.push(r[1]))}}};for(var i=0;i<this.tags.channels;i++){var s={offset:0,line:0,lineObject:null,clock:192,maxGate:e,mode:this.modes.hardware,volumeRangeMode:TssCompiler.VOLUME_RANGE_MODE_NORMAL,volumeRelativeMode:this.modes.volumeRelative,volumeShift:0,octaveMode:this.modes.octave,currentVolume:{l:0,r:0},currentOctave:4,currentGate:e,defaultDot:0,defaultLength:4,loop:{offset:0,line:0,count:0,end:{offset:0,line:0}},localLoopId:0,count:0,data:[],dataLength:0};0==i&&(s.data.push(TsdPlayer.CMD_FINENESS),s.data.push(this.tags.fineness>>8),s.data.push(this.tags.fineness&255)),TssCompiler.HARDWARE_MODE_FAMICOM==s.mode?(s.data.push(TsdPlayer.CMD_MODULE_CHANGE),2!=i?s.data.push(1):s.data.push(4)):TssCompiler.HARDWARE_MODE_GAMEBOY==s.mode&&(s.data.push(TsdPlayer.CMD_MODULE_CHANGE),3==i?s.data.push(15):2==i?s.data.push(14):s.data.push(13),s.data.push(TsdPlayer.CMD_FREQUENCY_MODE_CHANGE),2==i&&s.data.push(3));for(s.line=0;s.line<this.channels[i].length;s.line++){s.lineObject=this.channels[i][s.line];for(s.offset=0;s.offset<s.lineObject.data.byteLength();){s.offset+=s.lineObject.data.countSpaces(s.offset);if(s.offset>=s.lineObject.data.byteLength())break;var o=s.lineObject.data.lowerCharAt(s.offset),u=o,a=[];"a"<=o&&o<="g"&&(o="r");if(!r[o])throw new TssCompiler.CompileError(s.lineObject,s.offset,"unknown command '"+o+"'");s.offset++;if(r[o].sequence){s.offset+=s.lineObject.data.countSpaces(s.offset);if(s.offset>=s.lineObject.data.byteLength())break;var f=s.lineObject.data.lowerCharAt(s.offset);r[o].sequence.indexOf(f)>=0&&(o+=f,u=o,s.offset++)}this.logMmlCompile&&Log.getLog().info("command "+u+" with parameters as follows");for(var l=0;l<r[o].args.length;l++){if(0!=l){var c=TssCompiler._getCharacter(s.lineObject,s.offset,",");if(c<0)break;s.offset=c+1}var h=TssCompiler._getNumberParameter(s.lineObject,s.offset);if(typeof h.parameter=="undefined"){if(typeof r[o].args[l].def=="undefined"&&r[o].args[l].mandatory)throw new TssCompiler.CompileError(s.lineObject,s.offset,"missing argument for '"+
o+"'");a.push(r[o].args[l].def)}else a.push(h.parameter),s.offset=h.end+1}this.logMmlCompile&&Log.getLog().info(a),s.dataLength=s.data.length,r[o].callback&&r[o].callback(this,s,u,a);if(this.logMmlCompile){var p="> "+s.dataLength.toString(16)+": ";for(l=s.dataLength;l<s.data.length;l++)l!=s.dataLength&&(p+=", "),p+=s.data[l].toString(16);Log.getLog().info(p)}s.dataLength=s.data.length}}s.data.push(TsdPlayer.CMD_END),this.channelData[i]=s.data,Log.getLog().info("TSS: DATA "+(i+1)+"> "+s.data.length+" Byte(s) / "+s.count+" Tick(s)")}},TssCompiler.prototype._generateTsd=function(){var e=this.tags.title.byteLength();0!=e%2&&e++;var t=18+e+2+8*this.tags.channels+4,n=t;Log.getLog().info("TSS: HEADER SIZE> "+n);var r;for(r=0;r<this.tags.channels;r++)n+=this.channelData[r].length;var i=n;n+=2,Log.getLog().info("TSS: WAVE> "+this.validWaves);for(r=0;r<this.waves.length;r++){if(!this.waves[r])continue;Log.getLog().info("TSS:  "+r+"> "+this.waves[r].length),n+=2+this.waves[r].length}n+=2,Log.getLog().info("TSS: TABLE> "+this.validTables);for(r=0;r<this.tables.length;r++){if(!this.tables[r])continue;Log.getLog().info("TSS:  "+r+"> "+this.tables[r].length),n+=2+this.tables[r].length}var s=new Uint8Array(n);Log.getLog().info("TSS: TOTAL SIZE> "+n);var o=TString.createFromUint8Array(s),u=o.setASCII(0,"T'SoundSystem");o.setAt(u++,Math.floor(TssCompiler.VERSION)),o.setAt(u++,Math.floor(TssCompiler.VERSION*100)%100),u=o.setUint16(u,this.tags.title.byteLength()),u=o.setTString(u,this.tags.title),0==this.tags.title.byteLength()%2&&u--,u=o.setUint16(u,this.tags.channels);var a=t;for(r=0;r<this.tags.channels;r++){var f=this.channelData[r].length;u=o.setUint32(u,a),u=o.setUint32(u,f);for(var l=0;l<f;l++)o.setAt(a+l,this.channelData[r][l]);a+=f}u=o.setUint32(u,i),u=o.setUint16(i,this.validWaves);for(r=0;r<this.validWaves;r++){if(!this.waves[r])continue;o.setAt(u++,r);var c=this.waves[r].length;o.setAt(u++,c);for(var h=0;h<c;h++)o.setAt(u++,TssCompiler._toUint8(this.waves[r][h]))}u=o.setUint16(u,this.validTables);for(r=0;r<this.validTables;r++){if(!this.tables[r])continue;o.setAt(u++,r),c=this.tables[r].length,o.setAt(u++,c);for(h=0;h<c;h++)o.setAt(u++,TssCompiler._toUint8(this.tables[r][h]))}return s.buffer},TssCompiler.prototype._compile=function(){try{return this._parseLines(),this._parseDirectives(),this._parseChannels(),this._generateTsd()}catch(e){return Log.getLog().error(e.stack),Log.getLog().error(e.toString()),null}},TssCompiler.prototype.compile=function(e){return typeof e=="string"?this.source=TString.createFromString(e):this.source=TString.createFromUint8Array(new Uint8Array(e)),this._compile()};var MMLParser=function(){this.macro={},this.endParse=!1,this.expandMode=!0,this.noteShift=0,this.dumpString="",this.channel=0,this.fmchannel=0,this.asciiA="A".charCodeAt(0),this.commentMode=!1,this.FmNode=[],this.FmPipe=-1,this.FmOps=0,this.FmMode=!1,this.FmCount=0,this.number2name=["a","a+","b","c","c+","d","d+","e","f","f+","g","g+"],this.name2number={a:0,"a+":1,"b-":1,b:2,c:3,"c+":4,"d-":4,d:5,"d+":6,"e-":6,e:7,f:8,"f+":9,"g-":9,g:10,"g+":11,"a-":11}};MMLParser.prototype.initialize=function(){this.macro={},this.endParse=!1,this.expandMode=!0,this.noteShift=0,this.dumpString="",this.channel=0,this.fmchannel=0,this.asciiA="A".charCodeAt(0),this.commentMode=!1,this.FmNode=[],this.FmPipe=-1,this.FmOps=0,this.FmMode=!1,this.FmCount=0,this.resetChannelString()},MMLParser.prototype.isString=function(e){return typeof e=="string"||e instanceof String},MMLParser.prototype.repeat=function(e,t){var n="";for(var r=0;r<t;r++)n+=e;return n},MMLParser.prototype.getChannelString=function(){var e,t=this.channel%26,n=Math.floor(this.channel/26)-1;return n<0?e="#"+String.fromCharCode(this.asciiA+t):e="#"+String.fromCharCode(this.asciiA+n)+String.fromCharCode(this.asciiA+t),this.channel++,e},MMLParser.prototype.resetChannelString=function(){this.channel=0},MMLParser.prototype.expandWAVB=function(e){var t="";e.length%2==1&&(e+="0");for(var n=0;n<e.length;n+=2){n>0&&(t+=",");var r=e.substring(n,n+2),i=parseInt(r,16)-128;t+=i.toString(10)}return"<"+t+">"},MMLParser.prototype.parse=function(e){this.initialize();var t=[];e=e.replace(/\n/g,"");var n=e.split(";");for(var r=0;r<n.length;r++){var i=n[r];this.noteShift=0;var s=this.parseLine(n[r]);s.length>0&&t.push(s);if(this.endParse)break}return t},MMLParser.prototype.expandMacro=function(e){if(this.commentMode)return e;e=e.replace(/{[^}]*}/g,""),e=e.replace(/{[^}]*$/,"{");if(e.match(/^ *#/))return e;var t=0,n=e.match(/([A-Z])(\([+\-]?[0-9]+\))?/);while(n){var r="",i="";if(RegExp.$2!==""){var s=parseInt(RegExp.$2.replace("(","").replace(")",""),10);r="@ns"+String(s),i="@ns"+String(-s)}e=e.substring(0,n.index)+r+this.macro[RegExp.$1]+i+e.substring(n.index+n[0].length),n=e.match(/([A-Z])(\([+\-]?[0-9]+\))?/),t++;if(t>100)break}return e},MMLParser.prototype.parseLine=function(e){var t=e;this.endParse=!1;var n=[];e=this.expandMacro(e),e.match(/#TITLE/)?e=e.replace(/^.*#TITLE/g,"#TITLE"):e=e.replace(/ /g,"");if(this.commentMode){if(!e.match(/^[^}]*}/))return[];e=e.replace(/^[^}]*}/,""),this.commentMode=!1}var r=0;for(;;){r++;var i=e;if(e.match(/^(mp)([+\-]?[0-9]+)?(,[+\-]?[0-9]+)?(,[+\-]?[0-9]+)?(,[+\-]?[0-9]+)?(,[+\-]?[0-9]+)?/))e=e.replace(/^(mp)([+\-]?[0-9]+)?(,[+\-]?[0-9]+)?(,[+\-]?[0-9]+)?(,[+\-]?[0-9]+)?(,[+\-]?[0-9]+)?/,""),n.push(["mml",RegExp.$1,RegExp.$2,RegExp.$3,RegExp.$4,RegExp.$5,RegExp.$6]);else if(e.match(/^(na|nt)([+\-]?[0-9]+)?(,[+\-]?[0-9]+)?/))e=e.replace(/^(na|nt)([+\-]?[0-9]+)?(,[+\-]?[0-9]+)?/,""),n.push(["mml",RegExp.$1,RegExp.$2,RegExp.$3]);else if(e.match(/^(ns)([+\-]?[0-9]+)/))e=e.replace(/^(ns)([+\-]?[0-9]+)/,""),this.expandMode||n.push(["exmml",RegExp.$1,RegExp.$2]),this.noteShift=parseInt(RegExp.$2,10);else if(e.match(/^(ml|ph)([+\-]?[0-9]+)/))e=e.replace(/^(ml|ph)([+\-]?[0-9]+)/,""),this.expandMode||n.push(["exmml(unsupported)",RegExp.$1,RegExp.$2]);else if(e.match(/^([l])([+\-]?[0-9]+)/))e=e.replace(/^([l])([+\-]?[0-9]+)/,""),n.push(["mml",RegExp.$1,RegExp.$2]);else if(e.match(/^([svx])([+\-]?[0-9]+)?(,[+\-]?[0-9]+)?/))e=e.replace(/^([svx])([+\-]?[0-9]+)?(,[+\-]?[0-9]+)?/,""),n.push(["mml",RegExp.$1,RegExp.$2,RegExp.$3]);else if(e.match(/^([hijkmnopqrtuwxyz])([+\-]?[0-9]+)?/))e=e.replace(/^([hijkmnopqrstuvwxyz])([+\-]?[0-9]+)?/,""),n.push(["mml",RegExp.$1,RegExp.$2]);else if(e.match(/^([abcdefg][+\-]?)([0-9]+)?/)){e=e.replace(/^([abcdefg][+\-]?)([0-9]+)?/,"");var s=this.name2number[RegExp.$1];s=(s+this.noteShift+24)%12,n.push(["mml",this.number2name[s],RegExp.$2])}else if(e.match(/^([r])([0-9]*)/))e=e.replace(/^([r])([0-9]*)/,""),n.push(["mml",RegExp.$1,RegExp.$2]);else if(e.match(/^(\^)([0-9]*)/))e=e.replace(/^(\^)([0-9]*)/,""),n.push(["mml",RegExp.$1,RegExp.$2]);else if(e.match(/^(\/:)([0-9]*)/))e=e.replace(/^(\/:)([0-9]*)/,""),n.push(["mml",RegExp.$1,RegExp.$2]);else if(e.match(/^(:\/)/))e=e.replace(/^(:\/)/,""),n.push(["mml",RegExp.$1]);else if(e.match(/^(\[)([0-9]*)/))e=e.replace(/^(\[)([0-9]*)/,""),n.push(["mml",RegExp.$1,RegExp.$2]);else if(e.match(/^(\])/))e=e.replace(/^(\])/,""),n.push(["mml",RegExp.$1]);else if(e.match(/^([,.|$^()<>\/])/))e=e.replace(/^([,.|$^()<>\/])/,""),n.push(["mml",RegExp.$1]);else if(e.match(/^(@kr|@ks|@ml|@apn)([+\-]?[0-9]+)?(,[+\-]?[0-9]+)?/))e=e.replace(/^(@kr|@ks|@ml|@apn)([+\-]?[0-9]+)?(,[+\-]?[0-9]+)?/,""),n.push(["exmml(unsupported)",RegExp.$1,RegExp.$2,RegExp.$3]);else if(e.match(/^(@ns)([+\-]?[0-9]+)/))e=e.replace(/^(@ns)([+\-]?[0-9]+)/,""),this.expandMode||n.push(["exmml",RegExp.$1,RegExp.$2]),this.noteShift+=parseInt(RegExp.$2,10);else if(e.match(/^(@[vio])([+\-]?[0-9]+)?,([+\-]?[0-9]+)/))e=e.replace(/^(@[vio])([+\-]?[0-9]+)?,([+\-]?[0-9]+)/,""),n.push(["mml",RegExp.$1,RegExp.$2,RegExp.$3]);else if(e.match(/^(@[v])([+\-]?[0-9]+)?/))e=e.replace(/^(@[v])([+\-]?[0-9]+)?/,""),n.push(["mml",RegExp.$1,RegExp.$2]);else if(e.match(/^(@[a-z])([+\-]?[0-9]+)?(,[+\-]?[0-9]+)?(,[+\-]?[0-9]+)?(,[+\-]?[0-9]+)?/))e=e.replace(/^(@[a-z])([+\-]?[0-9]+)?(,[+\-]?[0-9]+)?(,[+\-]?[0-9]+)?(,[+\-]?[0-9]+)?/,""),n.push(["exmml(unsupported)",RegExp.$1,RegExp.$2,RegExp.$3]);else if(e.match(/^([&*])/))e=e.replace(/^([&*])/,""),n.push(["exmml(unsupported)",RegExp.$1]);else if(e.match(/^(%)([0-9]+)/))e=e.replace(/^(%)([0-9]+)/,""),n.push(["mml",RegExp.$1,RegExp.$2+" "]);else if(e.match(/^([@])([0-9]+)/))e=e.replace(/^([@])([0-9]+)/,""),n.push(["mml",RegExp.$1,RegExp.$2]);else if(e.match(/^([~_])([0-9]+)?/))e=e.replace(/^([~_])([0-9]+)?/,""),n.push(["exmml(unsupported)",RegExp.$1,RegExp.$2]);else if(e.match(/^{[^}]*}/))e=e.replace(/^{[^}]*}/,"");else if(e.match(/^{[^}]*$/))e=e.replace(/^{[^}]*$/,""),this.commentMode=!0;else if(e.match(/^(#OCTAVE|#VOLUME)(REVERSE|NORMAL)/))e=e.replace(/^(#OCTAVE|#VOLUME)(REVERSE|NORMAL)/,""),n.push(["directive",RegExp.$1,RegExp.$2]);else if(e.match(/^(#TABLE)([0-9]+),?(<[^>]*>)/))e=e.replace(/^(#TABLE)([0-9]+),?(<[^>]*>)/,""),n.push(["directive",RegExp.$1,RegExp.$2,RegExp.$3]);else if(e.match(/^(#WAV)([0-9]+),?(<[^>]*>)/))e=e.replace(/^(#WAV)([0-9]+),?(<[^>]*>)/,""),n.push(["directive",RegExp.$1,RegExp.$2,RegExp.$3]);else if(e.match(/^(#WAVB)([0-9]+),?([0-9a-fA-F]+)/))e=e.replace(/^(#WAVB)([0-9]+),?([0-9a-fA-F]+)/,""),n.push(["directive","#WAV",RegExp.$2,this.expandWAVB(RegExp.$3)]);else if(e.match(/^(#FINENESS)([0-9]+)/))e=e.replace(/^(#FINENESS)([0-9]+)/,""),n.push(["directive",RegExp.$1,RegExp.$2,RegExp.$3]);else if(e.match(/^(#TITLE) *(<[^>]*>)/))e=e.replace(/^(#TITLE) *(<[^>]*>)/,""),n.push(["directive",RegExp.$1,RegExp.$2]);else if(e.match(/^(#CHANNEL)([0-9]+)/))e=e.replace(/^(#CHANNEL)([0-9]+)/,"");else if(e.match(/^(#PRAGMA)(FAMICOM|GAMEBOY)/))e=e.replace(/^(#PRAGMA)(FAMICOM|GAMEBOY)/,""),n.push(["directive",RegExp.$1,RegExp.$2]);else if(e.match(/^(#MML)/))e=e.replace(/^(#MML)/,"");else{if(e.match(/^(#END)/)){e="",this.endParse=!0;break}if(e.match(/^(#FM)(.*)/))e=e.replace(/^(#FM)(.*)/,""),n.push(["directive",RegExp.$1,RegExp.$2]);else if(e.match(/^#([A-Z])=(.*)/))e=e.replace(/^#([A-Z])=(.*)/,""),this.expandMode||n.push(["def",RegExp.$1,RegExp.$2]),this.macro[RegExp.$1]=RegExp.$2;else if(e.match(/^(#FILTER)([0-9]+),?(<[^>]*>)/))e=e.replace(/^(#FILTER)([0-9]+),?(<[^>]*>)/,""),n.push(["exmml(unsupported)",RegExp.$1,RegExp.$2]);else{if(!e.match(/^(#[A-Z]+)/)){if(e!=="")throw console.log("parse error:["+e+"]"),console.log("      >>> "+t),console.log("      >>> "+i),new Error("parse error");break}e=e.replace(/^(#[A-Z]+)/,""),n.push(["exmml(unsupported)",RegExp.$1])}}}return n},MMLParser.prototype.parseFmMacro=function(e){var t=0,n=[],r="",i,s,o=e;while(e.length>0)if(t===0)if(e.match(/^ +/))e=e.replace(/^ +/,"");else if(e.match(/^([A-Z])([0-8])?\(/))r="",i=RegExp.$1,RegExp.$2!==""?s=RegExp.$2:s="3",t++,e=e.replace(/^([A-Z])([0-8])?\(/,"");else if(e.match(/^([A-Z])([0-8])?/))n.push([RegExp.$1,"0",""]),e=e.replace(/^([A-Z])([0-8])?/,"");else{if(!e.match(/^\+/)){e!==""&&(console.log("FM macro parse error:["+e+"]"),console.log("      >>> "+o));break}n.push("+"),e=e.replace(/^\+/,"")}else e.match(/^\)/)?(t--,t===0?(n.push([i,s,this.parseFmMacro(r)]),e=e.substring(1)):(r+=e.charAt(0),e=e.substring(1))):e.match(/^\(/)?(t++,r+=e.charAt(0),e=e.substring(1)):(r+=e.charAt(0),e=e.substring(1));return n},MMLParser.prototype.evalFmMacro=function(e){this.FmNode=new Array(26),this.FmPipe=-1,this.FmOps=0;var t=this.parseFmMacro(e);this.evalFmMacroSub(t,0,1),this.FmMode=!0,this.FmCount=0},MMLParser.prototype.evalFmMacroSub=function(e,t,n){var r=1;for(var i=0;i<e.length;i++)if(this.isString(e[i]))if(e[i].match(/[A-Z]/)){this.FmOps++;var s=e[i].charCodeAt(0)-this.asciiA;this.FmNode[s]=[],node=this.FmNode[s],e[i+1]==="0"?(node[0]=0,node[1]=0,node[3]=this.FmPipe):(this.FmPipe++,node[0]=parseInt(e[i+1],10),node[1]=this.FmPipe,node[3]=this.FmPipe-1),t===1?(node[2]=0,node[3]=0):(node[2]=n,this.fmchannel++),i++}else e[i]==="+"&&(r=2);else this.evalFmMacroSub(e[i],t+1,r)},MMLParser.prototype.dumpFmMacro=function(e){var t=this.parseFmMacro(e);return this.dumpString="",this.dumpFmMacroSub(t,0),this.dumpString},MMLParser.prototype.dumpFmMacroSub=function(e,t){for(var n=0;n<e.length;n++)this.isString(e[n])?e[n].match(/[A-Z]/)&&(this.dumpString+=this.repeat(" ",t*4)+e[n]+"<--"+e[n+1]+"--\n",n++):this.dumpFmMacroSub(e[n],t+1)},MMLParser.prototype.compile=function(e,t){t===undefined&&(t=!0);var n=this.parse(e),r="<>",i="";for(var s=0;s<n.length;s++)if(n[s][0][0]==="directive"){var o=n[s][0][1];o==="#TITLE"?r=n[s][0][2]:o==="#TABLE"||o==="#WAV"?i+=n[s][0][1]+" "+n[s][0][2]+","+n[s][0][3]+"\n":o!=="#FM"&&(i+=n[s][0][1]+" "+n[s][0][2]+"\n")}for(var s=0;s<n.length;s++){if(n[s][0][0]==="directive"){var o=n[s][0][1];o==="#FM"&&this.evalFmMacro(n[s][0][2]);continue}t&&(i+=this.getChannelString()+"\n");var u=0;n[s][u][1]=="%"&&(i+=n[s][u][1]+n[s][u][2],u++);if(t&&this.FmMode){var a=this.FmNode[this.FmCount];i+="@i"+a[0]+","+a[1]+"@o"+a[2]+","+a[3],this.FmCount++,this.FmCount>=this.FmOps&&(this.FmMode=!1)}for(;u<n[s].length;u++)for(var f=1;f<n[s][u].length;f++){if(n[s][u][0]==="exmml(unsupported)")continue;i+=n[s][u][f]}i+="\n"}var l="";return t&&(l+="#TITLE "+r+"\n",l+="#CHANNEL "+Math.min(this.channel-this.fmchannel,26)+"\n"),l+=i,l},MMLParser.prototype.dump=function(e){var t=this.expandMode;this.expandMode=!1;var n=this.parse(e);this.expandMode=t,console.log("=========================");for(var r=0;r<n.length;r++){for(var i=0;i<n[r].length;i++){var s="";for(var o=0;o<n[r][i].length;o++)s+=n[r][i][o]+" ";console.log(s)}console.log("-------")}console.log("=========================")},typeof module!="undefined"&&(module.exports=MMLParser),function(){var e=new MMLParser,t=new AudioLooper(2048),n=new MasterChannel;n.setVolume(1);var r=new TsdPlayer;r.device=new TssChannel,r.device.setPlayer(r),n.addChannel(r.device),r.setMasterChannel(n);var i="";document.onkeydown=function(s){var o=s.ctrlKey||s.metaKey;if(o&&s.keyCode===67){var u=String(document.getSelection());if(t.channel){t.setChannel(null);if(u===i)return}i=u;var a=new TssCompiler,f=e.compile(u);s.shiftKey&&console.log(f);var l=a.compile(f);l===null?console.log("MML compile error"):(t.setChannel(n),r.play(l))}}}();