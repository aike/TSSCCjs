if(!window["exports"])window["exports"]={};if(!window["Log"]){window["Log"]={enabled:false,log:[],on:function(){Log.enabled=true},off:function(){Log.enabled=false},flush:function(){var d=Log.log.join("\n");Log.log=[];return d},getLog:function(){return Log},info:function(m){},warn:function(m){},error:function(m){console.error(m);if(Log.enabled)Log.log.push(m)},fatal:function(m){console.fatal(m);if(Log.enabled)Log.log.push(m)}}}var AudioLooper=function(bufferSize){this.bufferSize=4096;if(bufferSize!==undefined)this.bufferSize=bufferSize;this.channel=null;this.initialized=true;this.firstAudioEvent=null;this.sampleRate=44100;if(window["AudioContext"]){Log.getLog().info("AudioLooper: detect Web Audio API");this.audioContext=new AudioContext;if(this.audioContext==null){Log.getLog().fatal("AudioLooper: could not create AudioContext");this.initialized=false;return}this.sampleRate=this.audioContext.sampleRate;Log.getLog().info("AudioLooper: sample rate is "+this.sampleRate);this.bufferSource=this.audioContext["createBufferSource"]();this.jsNode=this.audioContext["createScriptProcessor"](this.bufferSize,2,2);this.jsNode["onaudioprocess"]=function(event){this.onAudioProcess(event)}.bind(this);if(this.bufferSource["noteOn"])this.bufferSource["noteOn"](0);this.bufferSource["connect"](this.jsNode);this.jsNode["connect"](this.audioContext["destination"]);return}if(window["Audio"]){Log.getLog().info("AudioLooper: detect Audio Data API");this.audio=new Audio;if(this.audio==null||this.audio["mozSetup"]==undefined){Log.getLog().fatal("AudioLooper: could not use Audio Data API");this.initialized=false;return}this.audioChannel=2;this.audioFrequency=44100;this.audio["mozSetup"](this.audioChannel,this.audioFrequency);this.bufferId=0;this.bufferPage=4;this.bufferWritten=0;this.buffer=new Array(this.bufferPage);var arraySize=this.bufferSize*this.audioChannel;for(var i=0;i<this.bufferPage;i++){this.buffer[i]=new Float32Array(arraySize);this.bufferWritten+=this.audio["mozWriteAudio"](this.buffer[i])}this.audio.owner=this;var interval=this.bufferSize*1e3/44100/2;setInterval(function(object){object.onAudioInterval()},interval,this);return}Log.getLog().error("AudioLooper: no known Audio API are available");this.initialized=false};AudioLooper.prototype.getSampleRate=function(){return this.sampleRate};AudioLooper.prototype.setChannel=function(newChannel){if(null!=newChannel){newChannel.setBufferLength(this.bufferSize*2);newChannel.setSampleRate(this.sampleRate)}this.channel=newChannel};AudioLooper.prototype.onAudioProcess=function(event){if(null==this.firstAudioEvent){this.firstAudioEvent=true;Log.getLog().info(event)}var lOut=event["outputBuffer"]["getChannelData"](0);var rOut=event["outputBuffer"]["getChannelData"](1);var i;if(null==this.channel){for(i=0;i<this.bufferSize;i++){lOut[i]=0;rOut[i]=0}return}this.channel.generate(this.bufferSize*2);var lrIn=this.channel.getBuffer();for(i=0;i<this.bufferSize;i++){lOut[i]=lrIn[i*2+0]/32768;rOut[i]=lrIn[i*2+1]/32768}};AudioLooper.prototype.onAudioInterval=function(){if(null==this.firstAudioEvent){this.firstAudioEvent=true;Log.getLog().info("onAudioInterval");Log.getLog().info(this)}var audioRead=this.audio["mozCurrentSampleOffset"]();var pageSize=this.bufferSize*this.audioChannel;var pageOffset=audioRead%(pageSize*this.bufferPage);var playingPage=~~(pageOffset/pageSize);if(this.bufferId==playingPage&&this.bufferWritten!=audioRead){return}var lrOut=this.buffer[this.bufferId];this.bufferId=(this.bufferId+1)%this.bufferPage;var i;if(null==this.channel){for(i=0;i<this.bufferSize;i++){lrOut[i*2+0]=0;lrOut[i*2+1]=0}}else{this.channel.generate(this.bufferSize*this.audioChannel);var lrIn=this.channel.getBuffer();for(i=0;i<this.bufferSize;i++){lrOut[i*2+0]=lrIn[i*2+0]/32768;lrOut[i*2+1]=lrIn[i*2+1]/32768}}this.bufferWritten+=this.audio["mozWriteAudio"](lrOut)};AudioLooper.prototype.isActive=function(){if(this.audioContext&&this.audioContext["currentTime"]==0)return false;return true};AudioLooper.prototype.activate=function(){if(this.isActive())return;this.bufferSource["noteOn"](0)};var MasterChannel=function(){this.channels=new Array;this.buffers=null;this.buffer=null;this.bufferLength=0;this.player=null;this.intervalMsec=0;this.intervalLength=0;this.intervalRestLength=0;this.volume=MasterChannel.DEFAULT_VOLUME;this.sampleRate=MasterChannel.DEFAULT_SAMPLE_FREQUENCY};MasterChannel.DEFAULT_SAMPLE_FREQUENCY=44100;MasterChannel.MAX_WAVE_VALUE=32767;MasterChannel.MIN_WAVE_VALUE=-32767;MasterChannel.MSEC_PER_SEC=1e3;MasterChannel.DEFAULT_VOLUME=8;MasterChannel.prototype.reconstructBuffers=function(){var newBuffers=new Array(this.channels.length);for(var i=0;i<this.channels.length;i++)newBuffers[i]=this.channels[i].getBuffer();this.buffers=newBuffers};MasterChannel.prototype.setVolume=function(newVolume){this.volume=newVolume};MasterChannel.prototype.addChannel=function(channel){var result=this.channels.push(channel);channel.setSampleRate(this.sampleRate);if(0!=this.bufferLength){channel.setBufferLength(this.bufferLength);this.reconstructBuffers()}return result};MasterChannel.prototype.removeChannel=function(channel){for(var i=0;i<this.channels.length;i++)if(channel==this.channels[i]){this.buffers=null;this.channels.splice(i,1);this.reconstructBuffers();return true}return false};MasterChannel.prototype.clearChannel=function(){this.buffers=null;this.channels=new Array;this.reconstructBuffers()};MasterChannel.prototype.setPlayer=function(newPlayer){this.player=newPlayer};MasterChannel.prototype.setPlayerInterval=function(msec){this.intervalMsec=msec;this.intervalLength=2*this.sampleRate*msec/MasterChannel.MSEC_PER_SEC;this.intervalLength&=~1;this.intervalRestLength=this.intervalLength};MasterChannel.prototype._generate=function(base,length){var channels=this.channels.length;var ch;for(ch=0;ch<channels;ch++)this.channels[ch].generate(length);for(var offset=0;offset<length;offset++){var value=0;for(ch=0;ch<channels;ch++)value+=this.buffers[ch][offset];value*=this.volume;if(value>MasterChannel.MAX_WAVE_VALUE)value=MasterChannel.MAX_WAVE_VALUE;else if(value<MasterChannel.MIN_WAVE_VALUE)value=MasterChannel.MIN_WAVE_VALUE;this.buffer[base+offset]=value}};MasterChannel.prototype.setBufferLength=function(length){this.buffers=null;this.buffer=new Int32Array(length);this.bufferLength=length;for(var i=0;i<this.channels.length;i++)this.channels[i].setBufferLength(length);this.reconstructBuffers()};MasterChannel.prototype.setSampleRate=function(rate){this.sampleRate=rate;for(var i=0;i<this.channels.length;i++)this.channels[i].setSampleRate(rate);this.setPlayerInterval(this.intervalMsec)};MasterChannel.prototype.getBuffer=function(){return this.buffer};MasterChannel.prototype.generate=function(length){if(null==this.buffers)return;if(null==this.player||0==this.intervalLength){this._generate(0,length)}else{var restLength=length;var offset=0;while(restLength>this.intervalRestLength){this._generate(offset,this.intervalRestLength);restLength-=this.intervalRestLength;offset+=this.intervalRestLength;this.intervalRestLength=this.intervalLength;this.player.updateDevice()}if(0!=restLength){this._generate(offset,restLength);this.intervalRestLength-=restLength}}};var TssChannel=function(){this.sampleRate=MasterChannel.DEFAULT_SAMPLE_FREQUENCY;this.buffer=null;this.fmBuffer=[null,null,null,null];this.player=null;this.module=[];this.midi=new Array(TssChannel.MAX_MIDI_PORT);for(var i=0;i<TssChannel.MAX_MIDI_PORT;++i)this.midi[i]=new TssChannel.MIDI;this.timer=[{enable:false,timer:0,count:0,base:0,self:null,callback:null},{enable:false,timer:0,count:0,base:0,self:null,callback:null}];this.maxChannel=0;this.wave=[]};TssChannel.MAX_MIDI_PORT=4;TssChannel.MODULE_CHANNEL_L=0;TssChannel.MODULE_CHANNEL_R=1;TssChannel.MODULE_CHANNEL_C=2;TssChannel.FM_OUT_MODE_OFF=0;TssChannel.FM_OUT_MODE_NEW=1;TssChannel.FM_OUT_MODE_ADD=2;TssChannel._RND_TABLE=new Int8Array(4096);TssChannel._SIN_TABLE=new Int8Array(256);(function(){var i;for(i=0;i<4096;i++){var u8=~~(Math.random()*2147483647)>>8&255;if(u8>=128)u8=u8-256;TssChannel._RND_TABLE[i]=u8}for(i=0;i<256;i++)TssChannel._SIN_TABLE[i]=~~(Math.sin(Math.PI*i/128)*64+.5)})();TssChannel.prototype.setBufferLength=function(length){this.buffer=new Int32Array(length);for(var i=0;i<4;i++){this.fmBuffer[i]=new Int32Array(length)}for(var port=0;port<TssChannel.MAX_MIDI_PORT;++port){if(this.midi[port])this.midi[port].setBufferLength(length)}};TssChannel.prototype.setSampleRate=function(rate){this.sampleRate=rate;for(var id=0;id<2;++id){var biasedCount=this.timer[id].base*rate/44100|0;this.timer[id].timer=biasedCount;this.timer[id].count=biasedCount}};TssChannel.prototype.getBuffer=function(){return this.buffer};TssChannel.prototype.setPlayer=function(newPlayer){this.player=newPlayer};TssChannel.prototype.generate=function(length){var offset=0;while(offset<length){var timerCount=length-offset>>2;var timerId;for(timerId=0;timerId<2;timerId++){if(this.timer[timerId].enable&&this.timer[timerId].count<timerCount)timerCount=this.timer[timerId].count}var generateCount=timerCount<<2;this._generateInternal(offset,generateCount);offset+=generateCount;for(timerId=0;timerId<2;timerId++){if(!this.timer[timerId].enable)continue;this.timer[timerId].count-=timerCount;if(0!=this.timer[timerId].count)continue;this.timer[timerId].count=this.timer[timerId].timer;this.timer[timerId].callback.apply(this.timer[timerId].self)}}};TssChannel.prototype.reset=function(){for(var i=0;i<TssChannel.MAX_MIDI_PORT;++i)if(this.midi[i].device)this.midi[i].device.processSystemReset()};TssChannel.prototype.setVirtualDevices=function(devices){for(var i=0;i<TssChannel.MAX_MIDI_PORT;++i)this.midi[i].setDevice(devices[i])};TssChannel.prototype._CheckId=function(id){if(typeof id=="undefined"||id>this.maxChannel)throw new RangeError("TSC: Invalid module channel: "+id)};TssChannel.prototype.setMaxChannel=function(maxChannel){this.maxChannel=maxChannel;for(var ch=0;ch<maxChannel;ch++)this.module[ch]=new TssChannel.Module(this,ch)};TssChannel.prototype.setWave=function(id,wave){Log.getLog().info("TSC: Set wave table "+id);Log.getLog().info(wave);this.wave[id]=wave};TssChannel.prototype.setTimerCallback=function(id,count,self,callback){if(id>2)return;if(null!=callback&&count<=0)return;var biasedCount=count*this.sampleRate/44100|0;this.timer[id]={enable:null!=callback,timer:biasedCount,count:biasedCount,base:count,self:self,callback:callback}};TssChannel.prototype.setModuleFrequency=function(id,frequency){this._CheckId(id);this.module[id].frequency=frequency};TssChannel.prototype.setModuleMultiple=function(id,multiple){this._CheckId(id);this.module[id].multiple=multiple};TssChannel.prototype.setModuleVolume=function(id,ch,volume){this._CheckId(id);if(ch==TssChannel.MODULE_CHANNEL_L)this.module[id].volume.l=volume;else if(ch==TssChannel.MODULE_CHANNEL_R)this.module[id].volume.r=volume;else if(ch==TssChannel.MODULE_CHANNEL_C)this.module[id].volume.c=volume;else Log.getLog().error("TSC: Invalid volume channel: "+ch)};TssChannel.prototype.getModuleVolume=function(id,ch){this._CheckId(id);if(ch==TssChannel.MODULE_CHANNEL_L)return this.module[id].volume.l;else if(ch==TssChannel.MODULE_CHANNEL_R)return this.module[id].volume.r;throw new RangeError("TSC: Invalid volume channel: "+id)};TssChannel.prototype.setModuleType=function(id,type){this._CheckId(id);this.module[id].setType(type);if(TssChannel.Module.TYPE_SCC==type){if(!this.wave[0])Log.getLog().warn("TSC: wave table 0 not found")}};TssChannel.prototype.getModuleType=function(id){this._CheckId(id);return this.module[id].type};TssChannel.prototype.setModulePort=function(id,port,channel){this._CheckId(id);var type=this.getModuleType(id);if(TssChannel.Module.TYPE_MIDI!=type)return;this.derefMidi(this.module[id].mid);this.addrefMidi(port);this.module[id].mid=port;this.module[id].mch=channel};TssChannel.prototype.setModuleVoice=function(id,voice){this._CheckId(id);var type=this.getModuleType(id);if(TssChannel.Module.TYPE_SCC==type){if(!this.wave[voice])Log.getLog().warn("TSC: wave table "+voice+" not found")}else if(TssChannel.Module.TYPE_MIDI==type){var device=this.midi[this.module[id].mid].device;if(device)device.processProgramChange(this.module[id].mch,voice)}this.module[id].voice=voice};TssChannel.prototype.setModuleFmInPipe=function(id,rate,pipe){this._CheckId(id);this.module[id].setFmInPipe(rate,pipe)};TssChannel.prototype.setModuleFmOutPipe=function(id,mode,pipe){this._CheckId(id);this.module[id].setFmOutPipe(mode,pipe)};TssChannel.prototype.setModulePhase=function(id,phase){this._CheckId(id);this.module[id].phase=phase};TssChannel.prototype.keyOn=function(id,note){this._CheckId(id);var type=this.getModuleType(id);if(TssChannel.Module.TYPE_MIDI!=type)return;this.module[id].note=note;var device=this.midi[this.module[id].mid].device;if(device){device.processNoteOn(this.module[id].mch,note,this.module[id].volume.c>>1)}};TssChannel.prototype.keyOff=function(id){this._CheckId(id);var type=this.getModuleType(id);if(TssChannel.Module.TYPE_MIDI!=type)return;var device=this.midi[this.module[id].mid].device;if(device)device.processNoteOff(this.module[id].mch,this.module[id].note,0)};TssChannel.prototype.pitchBend=function(id,bend){this._CheckId(id);var type=this.getModuleType(id);if(TssChannel.Module.TYPE_MIDI!=type)return;var device=this.midi[this.module[id].mid].device;if(device)device.processPitchBend(this.module[id].mch,bend)};TssChannel.prototype.panpot=function(id,panpot){this._CheckId(id);var type=this.getModuleType(id);if(TssChannel.Module.TYPE_MIDI!=type)return;var device=this.midi[this.module[id].mid].device;if(device)device.processControlChange(this.module[id].mch,10,panpot)};TssChannel.prototype._generateInternal=function(offset,count){var buffer=this.buffer.subarray(offset,offset+count);var fmBuffer=[this.fmBuffer[0].subarray(offset,offset+count),this.fmBuffer[1].subarray(offset,offset+count),this.fmBuffer[2].subarray(offset,offset+count),this.fmBuffer[3].subarray(offset,offset+count)];for(var i=0;i<count;i++)buffer[i]=0;for(var ch=0;ch<this.maxChannel;ch++)this.module[ch].generate(buffer,fmBuffer);for(var port=0;port<TssChannel.MAX_MIDI_PORT;++port){if(!this.midi[port].device||this.midi[port].reference==0)continue;this.midi[port].device.generate(count);var inBuffer=this.midi[port].inBuffer;for(var n=0;n<count;++n)buffer[n]+=inBuffer[n]}};TssChannel.prototype.addrefMidi=function(port){if(TssChannel.MAX_MIDI_PORT<=port)return;this.midi[port].reference++};TssChannel.prototype.derefMidi=function(port){if(TssChannel.MAX_MIDI_PORT<=port)return;this.midi[port].reference--};TssChannel.Module=function(channel,ch){this.id=ch;this.channel=channel;this.volume={l:0,r:0,c:0};this.frequency=0;this.fm={inRate:0,inPipe:0,outMode:0,outPipe:0};this.multiple=1;this.note=0;this.setType(TssChannel.Module.TYPE_PSG)};TssChannel.Module.TYPE_INVALID=-1;TssChannel.Module.TYPE_PSG=0;TssChannel.Module.TYPE_FC=1;TssChannel.Module.TYPE_NOISE=2;TssChannel.Module.TYPE_SIN=3;TssChannel.Module.TYPE_SCC=4;TssChannel.Module.TYPE_OSC=5;TssChannel.Module.TYPE_GB_SQUARE=13;TssChannel.Module.TYPE_GB_WAVE=14;TssChannel.Module.TYPE_MIDI=15;TssChannel.Module.prototype.setType=function(type){if(this.type==TssChannel.Module.TYPE_MIDI)this.channel.derefMidi(this.mid);this.type=type;this.count=0;this.phase=0;this.voice=0;this.mid=0;this.mch=0;switch(type){case TssChannel.Module.TYPE_PSG:this.generate=this.generatePsg;break;case TssChannel.Module.TYPE_FC:this.generate=this.generateFc;this.voice=3;break;case TssChannel.Module.TYPE_NOISE:this.generate=this.generateNoise;break;case TssChannel.Module.TYPE_SCC:this.generate=this.generateScc;break;case TssChannel.Module.TYPE_SIN:this.generate=this.generateSin;break;case TssChannel.Module.TYPE_MIDI:this.generate=this.generateNothing;this.channel.addrefMidi(this.mid);break;default:Log.getLog().warn("TSC: unknown device type "+type);this.generate=this.generateNothing;break}};TssChannel.Module.prototype.setFmInPipe=function(rate,pipe){this.fm.inRate=rate;this.fm.inPipe=pipe};TssChannel.Module.prototype.setFmOutPipe=function(mode,pipe){this.fm.outMode=mode;this.fm.outPipe=pipe};TssChannel.Module.prototype.generatePsg=function(buffer,fmBuffer){var volumeL=this.volume.l<<4;var volumeR=this.volume.r<<4;var length=buffer.length;var plus=this.frequency*2*this.multiple;var count=this.count;var phase=this.phase;if(0==phase){volumeL=-volumeL;volumeR=-volumeR}for(var i=0;i<length;i+=2){buffer[i+0]+=volumeL;buffer[i+1]+=volumeR;count+=plus;while(count>this.channel.sampleRate){volumeL=-volumeL;volumeR=-volumeR;count-=this.channel.sampleRate;phase++;phase&=1}}this.count=count;this.phase=phase};TssChannel.Module.prototype.generateFc=function(buffer,fmBuffer){var volumeL=this.volume.l<<4;var volumeR=this.volume.r<<4;var length=buffer.length;var plus=this.frequency*8*this.multiple;var count=this.count;var phase=this.phase;var voice=this.voice;if(phase<voice){volumeL=-volumeL;volumeR=-volumeR}for(var i=0;i<length;i+=2){buffer[i+0]+=volumeL;buffer[i+1]+=volumeR;count+=plus;while(count>this.channel.sampleRate){count-=this.channel.sampleRate;phase++;phase&=7;if(phase==0||phase==voice){volumeL=-volumeL;volumeR=-volumeR}}}this.count=count;this.phase=phase};TssChannel.Module.prototype.generateNoise=function(buffer,fmBuffer){var volumeL=this.volume.l>>2;var volumeR=this.volume.r>>2;var length=buffer.length;var plus=this.frequency*this.multiple;var count=this.count;var phase=this.phase;for(var i=0;i<length;i+=2){var rnd=TssChannel._RND_TABLE[phase];buffer[i+0]+=rnd*volumeL;buffer[i+1]+=rnd*volumeR;count+=plus;while(count>0){phase++;phase&=4095;count-=880}}this.count=count;this.phase=phase};TssChannel.Module.prototype.generateScc=function(buffer,fmBuffer){var wave=this.channel.wave[this.voice];if(!wave)return;var out=buffer;if(TssChannel.FM_OUT_MODE_OFF!=this.fm.outMode)out=fmBuffer[this.fm.outPipe];var volumeL=this.volume.l>>2;var volumeR=this.volume.r>>2;var length=buffer.length;var plus=this.frequency*32*this.multiple;var count=this.count;var phase=this.phase;var i;if(0==this.fm.inRate){if(TssChannel.FM_OUT_MODE_NEW==this.fm.outMode){for(i=0;i<length;i+=2){out[i+0]=wave[phase]*volumeL;out[i+1]=wave[phase]*volumeR;count+=plus;while(count>this.channel.sampleRate){count-=this.channel.sampleRate;phase++;phase&=31}}}else{for(i=0;i<length;i+=2){out[i+0]+=wave[phase]*volumeL;out[i+1]+=wave[phase]*volumeR;count+=plus;while(count>this.channel.sampleRate){count-=this.channel.sampleRate;phase++;phase&=31}}}}else{var fm=fmBuffer[this.fm.inPipe];var inRate=this.fm.inRate<<3;var fmPhaseL;var fmPhaseR;if(TssChannel.FM_OUT_MODE_NEW==this.fm.outMode){for(i=0;i<length;i+=2){fmPhaseL=phase+(fm[i+0]>>inRate)&31;fmPhaseR=phase+(fm[i+1]>>inRate)&31;out[i+0]=wave[fmPhaseL]*volumeL;out[i+1]=wave[fmPhaseR]*volumeR;count+=plus;while(count>this.channel.sampleRate){count-=this.channel.sampleRate;phase++;phase&=31}}}else{for(i=0;i<length;i+=2){fmPhaseL=phase+(fm[i+0]>>inRate)&31;fmPhaseR=phase+(fm[i+1]>>inRate)&31;out[i+0]+=wave[fmPhaseL]*volumeL;out[i+1]+=wave[fmPhaseR]*volumeR;count+=plus;while(count>this.channel.sampleRate){count-=this.channel.sampleRate;phase++;phase&=31}}}}this.count=count;this.phase=phase};TssChannel.Module.prototype.generateSin=function(buffer,fmBuffer){var out=buffer;if(TssChannel.FM_OUT_MODE_OFF!=this.fm.outMode)out=fmBuffer[this.fm.outPipe];var volumeL=this.volume.l>>1;var volumeR=this.volume.r>>1;var length=buffer.length;var plus=this.frequency*256*this.multiple;var count=this.count;var phase=this.phase;var i;if(0==this.fm.inRate){if(TssChannel.FM_OUT_MODE_NEW==this.fm.outMode){for(i=0;i<length;i+=2){out[i+0]=TssChannel._SIN_TABLE[phase]*volumeL;out[i+1]=TssChannel._SIN_TABLE[phase]*volumeR;count+=plus;while(count>this.channel.sampleRate){count-=this.channel.sampleRate;phase++;phase&=255}}}else{for(i=0;i<length;i+=2){out[i+0]+=TssChannel._SIN_TABLE[phase]*volumeL;out[i+1]+=TssChannel._SIN_TABLE[phase]*volumeR;count+=plus;while(count>this.channel.sampleRate){count-=this.channel.sampleRate;phase++;phase&=255}}}}else{var fm=fmBuffer[this.fm.inPipe];var inRate=this.fm.inRate;var fmPhaseL;var fmPhaseR;if(TssChannel.FM_OUT_MODE_NEW==this.fm.outMode){for(i=0;i<length;i+=2){fmPhaseL=phase+(fm[i+0]>>inRate)&255;fmPhaseR=phase+(fm[i+1]>>inRate)&255;out[i+0]=TssChannel._SIN_TABLE[fmPhaseL]*volumeL;out[i+1]=TssChannel._SIN_TABLE[fmPhaseR]*volumeR;count+=plus;while(count>this.channel.sampleRate){count-=this.channel.sampleRate;phase++;phase&=255}}}else{for(i=0;i<length;i+=2){fmPhaseL=phase+(fm[i+0]>>inRate)&255;fmPhaseR=phase+(fm[i+1]>>inRate)&255;out[i+0]+=TssChannel._SIN_TABLE[fmPhaseL]*volumeL;out[i+1]+=TssChannel._SIN_TABLE[fmPhaseR]*volumeR;count+=plus;while(count>this.channel.sampleRate){count-=this.channel.sampleRate;phase++;phase&=255}}}}this.count=count;this.phase=phase};TssChannel.Module.prototype.generateNothing=function(buffer,fmBuffer){};TssChannel.MIDI=function(){this.device=null;this.bufferLength=0;this.inBuffer=null;this.reference=0};TssChannel.MIDI.prototype.setDevice=function(device){if(device&&this.bufferLength!=0){device.setBufferLength(length);this.inBuffer=this.device.getBuffer()}this.device=device};TssChannel.MIDI.prototype.setBufferLength=function(length){this.bufferLength=length;if(this.device){this.device.setBufferLength(length);this.inBuffer=this.device.getBuffer()}};var TString=function(){this.object=null};TString.CODE_NUL=0;TString.CODE_HT=9;TString.CODE_LF=10;TString.CODE_CR=13;TString.CODE_SP=32;TString.CODE_0=48;TString.CODE_9=57;TString.CODE_A=65;TString.CODE_Z=90;TString.CODE_a=97;TString.CODE_z=122;TString._isBMP=function(code){if(code<0||65536<=code)return false;if(code<55296)return true;if(code>=57344)return true;return false};TString._isHighSurrogates=function(code){if(55296<=code&&code<56320)return true;return false};TString._isLowSurrogates=function(code){if(56320<=code&&code<57344)return true;return false};TString._decodeSurrogatePair=function(first,second){if(!TString._isHighSurrogates(first)||!TString._isLowSurrogates(second))throw new RangeError("TString: invalid surrogate pair ("+first+", "+second+")");var w=first>>6&15;var u=w+1;var x=(first&63)<<10|second&1023;var i32=(u<<16)+x;if(i32<0)return 4294967296+i32;return i32};TString._bytesInUTF8=function(code){if(code<0)throw new RangeError("TString: invalid UCS-2 code "+code);if(code<128)return 1;if(code<2048)return 2;if(code<65536)return 3;if(code<2097152)return 4;if(code<67108864)return 5;if(code<2147483648)return 6;throw new RangeError("TString: invalid UCS-2 code "+code)};TString._countString=function(string){var length=0;for(var i=0;i<string.length;i++){var code=string.charCodeAt(i);if(!TString._isBMP(code)){if(++i>=string.length)throw new RangeError("TString: invalid surrogate pair");code=TString._decodeSurrogatePair(code,string.charCodeAt(i))}length+=TString._bytesInUTF8(code)}return length};TString._setUcs2=function(array,offset,code){if(code<0)throw new RangeError("TString: invalid UCS-2 code "+code);if(code<128){array[offset]=code;return 1}if(code<2048){array[offset+0]=192|code>>6;array[offset+1]=128|code&63;return 2}if(code<65536){array[offset+0]=224|code>>12;array[offset+1]=128|code>>6&63;array[offset+2]=128|code&63;return 3}if(code<2097152){array[offset+0]=240|code>>18;array[offset+1]=128|code>>12&63;array[offset+2]=128|code>>6&63;array[offset+3]=128|code&63;return 4}if(code<67108864){array[offset+0]=248|code>>24;array[offset+1]=128|code>>18&63;array[offset+2]=128|code>>12&63;array[offset+3]=128|code>>6&63;array[offset+4]=128|code&63;return 5}if(code<2147483648){array[offset+0]=252|code>>30;array[offset+1]=128|code>>24&63;array[offset+2]=128|code>>18&63;array[offset+3]=128|code>>12&63;array[offset+4]=128|code>>6&63;array[offset+5]=128|code&63;return 6}throw new RangeError("TString: invalid UCS-2 code "+code)};TString._buildUint8ArrayString=function(string){var size=TString._countString(string);var array=new Uint8Array(size);var offset=0;for(var i=0;i<string.length;i++){var code=string.charCodeAt(i);if(!TString._isBMP(code)){if(++i>=string.length)throw new RangeError("TString: invalid surrogate pair");code=TString._decodeSurrogatePair(code,string.charCodeAt(i))}offset+=TString._setUcs2(array,offset,code)}return array};TString.createFromString=function(string){var s=new TString;s._fromString(string);return s};TString.createFromUint8Array=function(array){var s=new TString;s._fromUint8Array(array);return s};TString.prototype._fromString=function(string){this.object=TString._buildUint8ArrayString(string)};TString.prototype._fromUint8Array=function(array){this.object=array};TString.prototype.at=function(offset){if(offset>=this.object.byteLength)throw new RangeError("TString: offset is out of range");return this.object[offset]};TString.prototype.charAt=function(offset){return String.fromCharCode(this.at(offset))};TString.prototype.lowerCharAt=function(offset){var code=this.at(offset);if(TString.CODE_A<=code&&code<=TString.CODE_Z)code|=32;return String.fromCharCode(code)};TString.prototype.numberAt=function(offset){if(!this.isNumber(offset))return-1;return this.object[offset]-TString.CODE_0};TString.prototype.setAt=function(offset,code){if(offset>=this.object.byteLength)throw new RangeError("TString: offset is out of range");this.object[offset]=code};TString.prototype.setCharAt=function(offset,ch){this.setAt(offset,ch.charCodeAt(0))};TString.prototype.setASCII=function(offset,string){for(var i=0;i<string.length;i++)this.setAt(offset+i,string.charCodeAt(i));this.setAt(offset+string.length,0);return offset+string.length+1};TString.prototype.setTString=function(offset,string){for(var i=0;i<string.byteLength();i++)this.setAt(offset+i,string.at(i));this.setAt(offset+string.byteLength(),0);return offset+string.byteLength()+1};TString.prototype.setUint16=function(offset,n){this.setAt(offset,n>>8);this.setAt(offset+1,n&255);return offset+2};TString.prototype.setUint32=function(offset,n){this.setAt(offset,n>>24);this.setAt(offset+1,n>>16&255);this.setAt(offset+2,n>>8&255);this.setAt(offset+3,n&255);return offset+4};TString.prototype.byteLength=function(){return this.object.length};TString.prototype.slice=function(begin,end){return TString.createFromUint8Array(this.object.subarray(begin,end))};TString.prototype.containString=function(offset,string){var t=TString.createFromString(string);return this.containUint8Array(offset,t.object)};TString.prototype.containUint8Array=function(offset,array){for(var i=0;i<array.length;i++)if(this.object[offset+i]!=array[i])return false;return true};TString.prototype.containASCII=function(offset,ascii){for(var i=0;i<ascii.length;i++)if(this.object[offset+i]!=ascii.charCodeAt(i))return false;return true};TString.prototype.countLine=function(offset){var count=0;for(var i=offset;i<this.object.length;i++){var c=this.object[i];if(TString.CODE_CR==c||TString.CODE_LF==c)break;count++}return count};TString.prototype.countLineDelimiter=function(offset){if(offset>=this.object.length)return 0;var count=0;var c=this.object[offset++];if(TString.CODE_CR==c){if(offset==this.object.length)return 1;count++;c=this.object[offset]}if(TString.CODE_LF==c)count++;return count};TString.prototype.countSpaces=function(offset){var n=0;for(var i=offset;i<this.object.length;i++){var c=this.object[i];if(TString.CODE_NUL!=c&&TString.CODE_HT!=c&&TString.CODE_SP!=c)break;n++}return n};TString.prototype.alphabetIndex=function(offset){var c=this.object[offset];if(TString.CODE_A<=c&&c<=TString.CODE_Z)return c-TString.CODE_A;else if(TString.CODE_a<=c&&c<=TString.CODE_z)return c-TString.CODE_a;return-1};TString.prototype.isNumber=function(offset){if(offset>=this.object.byteLength)return false;var c=this.object[offset];if(c<TString.CODE_0||TString.CODE_9<c)return false;return true};TString.prototype.find=function(offset,code){for(var i=offset;i<this.object.length;i++)if(this.object[i]==code)return i;return-1};TString.prototype.toString=function(offset,size){if(arguments.length<1)offset=0;if(arguments.length<2)size=this.byteLength()-offset;var result="";var first=true;var length=1;var value=0;for(var i=0;i<size&&i<this.object.length;i++){var c=this.object[offset+i];if(first){if(0==c)break;if(c<128){result+=String.fromCharCode(c);continue}first=false;if(c<194){throw new TypeError("TString: invalid UTF-8")}else if(c<224){length=2;value=c&31}else if(c<240){length=3;value=c&15}else if(c<248){length=4;value=c&7}else if(c<252){length=5;value=c&3}else if(c<254){length=6;value=c&1}else{throw new TypeError("TString: invalid UTF-8")}length--}else{if(c<128||191<c){throw new TypeError("TString: invalid UTF-8")}value=value<<6|c&63;length--;if(0==length){first=true;if(value<55296||57344<=value){result+=String.fromCharCode(value)}else{var u=value>>16&31;var w=u-1;var x=value&65535;result+=String.fromCharCode(55296+(w<<6)+(x>>10));result+=String.fromCharCode(56320+(x&1023))}}}}if(!first)throw new TypeError("TString: invalid UTF-8");return result};exports.TString=TString;var TsdPlayer=function(){this.device=null;this.input=null;this.header=null;this.channel=null;this.activeChannel=0;this.midi=new Array(TsdPlayer.MAX_MIDI_PORT);this.table=[];for(var i=0;i<256;i++)this.table[i]=new Uint8Array(0)};TsdPlayer.VERSION=.94;TsdPlayer.MAX_MIDI_PORT=TssChannel.MAX_MIDI_PORT;TsdPlayer.CMD_LAST_NOTE=127;TsdPlayer.CMD_NOTE_OFF=128;TsdPlayer.CMD_VOLUME_MONO=129;TsdPlayer.CMD_SUSTAIN_MODE=130;TsdPlayer.CMD_DETUNE=131;TsdPlayer.CMD_PORTAMENT=132;TsdPlayer.CMD_VOLUME_LEFT=133;TsdPlayer.CMD_VOLUME_RIGHT=134;TsdPlayer.CMD_PANPOT=135;TsdPlayer.CMD_RELATIVE_VOLUME_UP=136;TsdPlayer.CMD_RELATIVE_VOLUME_DOWN=137;TsdPlayer.CMD_TEMPO=144;TsdPlayer.CMD_FINENESS=145;TsdPlayer.CMD_KEY_ON_PHASE=146;TsdPlayer.CMD_MULTIPLE=147;TsdPlayer.CMD_PITCH_MODULATION_DELAY=160;TsdPlayer.CMD_PITCH_MODULATION_DEPTH=161;TsdPlayer.CMD_PITCH_MODULATION_WIDTH=162;TsdPlayer.CMD_PITCH_MODULATION_HEIGHT=163;TsdPlayer.CMD_PITCH_MODULATION_DELTA=164;TsdPlayer.CMD_AMP_EMVELOPE=184;TsdPlayer.CMD_NOTE_EMVELOPE=200;TsdPlayer.CMD_ENDLESS_LOOP_POINT=224;TsdPlayer.CMD_LOCAL_LOOP_START=225;TsdPlayer.CMD_LOCAL_LOOP_BREAK=226;TsdPlayer.CMD_LOCAL_LOOP_END=227;TsdPlayer.CMD_FREQUENCY_MODE_CHANGE=240;TsdPlayer.CMD_VOLUME_MODE_CHANGE=241;TsdPlayer.CMD_FM_IN=248;TsdPlayer.CMD_FM_OUT=249;TsdPlayer.CMD_CONTROL_CHANGE=251;TsdPlayer.CMD_PORT_CHANGE=252;TsdPlayer.CMD_VOICE_CHANGE=253;TsdPlayer.CMD_MODULE_CHANGE=254;TsdPlayer.CMD_END=255;TsdPlayer._DEFAULT_TIMER_COUNT=368;TsdPlayer._TIMER_AUTOMATION=0;TsdPlayer._TIMER_SEQUENCER=1;TsdPlayer._CH_L=TssChannel.MODULE_CHANNEL_L;TsdPlayer._CH_R=TssChannel.MODULE_CHANNEL_R;TsdPlayer._CH_C=TssChannel.MODULE_CHANNEL_C;TsdPlayer._PAN_L=1;TsdPlayer._PAN_R=2;TsdPlayer._PAN_C=TsdPlayer._PAN_L|TsdPlayer._PAN_R;TsdPlayer._FREQUENCY_TYPE_NORMAL=0;TsdPlayer._FREQUENCY_TYPE_MSX=1;TsdPlayer._FREQUENCY_TYPE_FM=2;TsdPlayer._FREQUENCY_TYPE_GB_SQUARE=3;TsdPlayer._VOLUME_TYPE_NORMAL=0;TsdPlayer._VOLUME_TYPE_FM=1;TsdPlayer._NOTE_FREQUENCY_TABLE=[null,null,null,null];TsdPlayer._NOTE_PARAMETER_TABLE=[null,null,null,null];TsdPlayer._PARAMETER_FREQUENCY_TABLE=[null,null,null,null];TsdPlayer._FM_VOLUME_TABLE=null;TsdPlayer._MSX_PARAMETER_TABLE=[3421,3228,3047,2876,2715,2562,2419,2283,2155,2034,1920,1812,1711,1614,1524,1438,1358,1281,1210,1142,1078,1017,960,906,855,807,762,719,679,641,605,571,539,509,480,453,428,404,381,360,339,320,302,285,269,254,240,227,214,202,190,180,170,160,151,143,135,127,120,113,107,101,95,90,85,80,76,71,67,64,60,57,53,50,48,45,42,40,38,36,34,32,30,28,27,25,24,22,21,20,19,18,17,16,15,14];(function(){var i;var table=new Uint16Array(128);TsdPlayer._NOTE_FREQUENCY_TABLE[TsdPlayer._FREQUENCY_TYPE_NORMAL]=table;for(i=0;i<128;i++)table[i]=~~(440*Math.pow(2,(i-69)/12)+.5);table=new Uint16Array(128);TsdPlayer._NOTE_FREQUENCY_TABLE[TsdPlayer._FREQUENCY_TYPE_GB_SQUARE]=table;for(i=0;i<128;i++){var frequency=440*Math.pow(2,(i-69)/12);var param=2048-131072/frequency+.5;if(param<0)param=0;table[i]=param}table=new Uint16Array(128);TsdPlayer._NOTE_PARAMETER_TABLE[TsdPlayer._FREQUENCY_TYPE_MSX]=table;for(i=0;i<12;i++)table[i]=0;for(i=12;i<108;i++)table[i]=TsdPlayer._MSX_PARAMETER_TABLE[i-12];for(i=108;i<128;i++)table[i]=0;table=new Uint16Array(4096);TsdPlayer._PARAMETER_FREQUENCY_TABLE[TsdPlayer._FREQUENCY_TYPE_MSX]=table;table[0]=0;for(i=1;i<4096;i++)table[i]=~~(1789772.5/16/i/2+.5);table=new Uint16Array(8192);TsdPlayer._PARAMETER_FREQUENCY_TABLE[TsdPlayer._FREQUENCY_TYPE_FM]=table;for(i=0;i<8192;i++){var tone=i>>6;var fine=i&63;var power=(tone-69+fine/64)/12;table[i]=~~(440*Math.pow(2,power)+.5)}table=new Uint8Array(256);TsdPlayer._FM_VOLUME_TABLE=table;for(i=0;i<256;i++)table[i]=~~(255*Math.pow(10,-.75*(255-i)/2/20)+.5)})();TsdPlayer.prototype.setMasterChannel=function(channel){this.device=new TssChannel;this.device.setPlayer(this);this.device.setVirtualDevices(this.midi);channel.clearChannel();channel.addChannel(this.device)};TsdPlayer.prototype.setMIDI=function(port,midi){if(port>=TsdPlayer.MAX_MIDI_PORT)return false;this.midi[port]=midi;if(this.device)this.device.setVirtualDevices(this.midi);return true};TsdPlayer.prototype._readI8=function(offset){var data=this.input[offset];if(data>=128)data=data-256;return data};TsdPlayer.prototype._readU16=function(offset){return this.input[offset]<<8|this.input[offset+1]};TsdPlayer.prototype._readU32=function(offset){var i32=this.input[offset]<<24|this.input[offset+1]<<16|this.input[offset+2]<<8|this.input[offset+3];if(i32<0)return 4294967296+i32;return i32};TsdPlayer.prototype._clamp=function(value,min,max){if(value<min)return min;if(value>max)return max;return value};TsdPlayer.prototype._setTable=function(id,table){Log.getLog().info("TSD: Set envelope table "+id);Log.getLog().info(table);this.table[id]=table};TsdPlayer.prototype.play=function(newInput){try{this.input=new Uint8Array(newInput);var tstring=TString.createFromUint8Array(this.input);if(!tstring.containASCII(0,"T'SoundSystem")){Log.getLog().warn("TSD: magic T'SoundSystem not found.");return false}var header={};header.majorVersion=this.input[14];header.minorVersion=this.input[15];header.fullVersion=header.majorVersion+header.minorVersion/100;Log.getLog().info("TSD: version = "+header.fullVersion);if(header.fullVersion<=.6||TsdPlayer.VERSION<header.fullVersion){Log.getLog().warn("TSD: unsupported format");return false}header.titleSize=this._readU16(16);header.title=TString.createFromUint8Array(this.input.subarray(18,18+header.titleSize)).toString();Log.getLog().info("TSD: title = "+header.title);var offset=18+(header.titleSize+1&~1);header.numOfChannel=this._readU16(offset);offset+=2;Log.getLog().info("TSD: channel = "+header.numOfChannel);this.device.reset();this.device.setMaxChannel(header.numOfChannel);this.header=header;this.activeChannel=header.numOfChannel;var channel=[];var i;for(i=0;i<header.numOfChannel;i++){channel[i]={id:i,baseOffset:0,size:0,offset:0,loop:{offset:0,count:0},localLoop:[],wait:1,sustain:0,portament:0,detune:0,keyOn:false,volume:{type:0,l:0,c:0,r:0},pan:TsdPlayer._PAN_C,frequency:{type:0,note:0,param:0,hz:0},tone:0,phase:0,pitchModulation:{enable:false,base:0,delayCount:0,widthCount:0,deltaCount:0,currentDepth:0,currentHeight:0,currentDiff:0,delay:0,depth:0,width:0,height:0,delta:0},ampEnvelope:{enable:false,id:0,wait:0,state:0,count:0,volume:{l:0,r:0}},nt:{enable:false,id:0,wait:0,state:0,count:0}};for(var n=0;n<16;n++){channel[i].localLoop[n]={offset:0,count:0,end:0}}channel[i].baseOffset=this._readU32(offset);offset+=4;channel[i].size=this._readU32(offset);offset+=4;Log.getLog().info("TSD: ch."+(i+1)+" offset = "+channel[i].baseOffset+", size = "+channel[i].size)}Log.getLog().info(channel);this.channel=channel;var tableOffset=this._readU32(offset);Log.getLog().info("TSD: table offset = "+tableOffset);offset=tableOffset;var numOfWave=this._readU16(offset);Log.getLog().info("TSD: found "+numOfWave+" wave table(s)");offset+=2;for(i=0;i<numOfWave;i++){if(32!=this.input[offset+1]){Log.getLog().error("TSD: invalid WAVE size");return false}this.device.setWave(this.input[offset],new Int8Array(newInput,offset+2,32));offset+=2+32}var numOfTable=this._readU16(offset);Log.getLog().info("TSD: found "+numOfTable+" envelope table(s)");offset+=2;for(i=0;i<numOfTable;i++){var tableSize=this.input[offset+1];this._setTable(this.input[offset],new Int8Array(newInput,offset+2,tableSize));offset+=2+tableSize}this.device.setTimerCallback(TsdPlayer._TIMER_AUTOMATION,TsdPlayer._DEFAULT_TIMER_COUNT,this,this._performAutomation);this.device.setTimerCallback(TsdPlayer._TIMER_SEQUENCER,TsdPlayer._DEFAULT_TIMER_COUNT,this,this._performSequencer)}catch(e){Log.getLog().error("TSD: "+e);return false}return true};TsdPlayer.prototype._performAutomation=function(){for(var i=0;i<this.header.numOfChannel;i++){var ch=this.channel[i];if(!ch.keyOn){if(0!=ch.sustain)this._performSustain(ch);if(0!=ch.portament)this._performPortament(ch)}if(ch.pitchModulation.enable)this._performPitchModulation(ch);if(ch.ampEnvelope.enable)this._performAmpEnvelope(ch)}};TsdPlayer.prototype._performSustain=function(ch){if(ch.ampEnvelope.volume.l>ch.sustain)ch.ampEnvelope.volume.l-=ch.sustain;else ch.ampEnvelope.volume.l=0;if(ch.ampEnvelope.volume.r>ch.sustain)ch.ampEnvelope.volume.r-=ch.sustain;else ch.ampEnvelope.volume.r=0;var pan=ch.pan;ch.pan=TsdPlayer._PAN_C;this._setVolume(ch,TsdPlayer._CH_L,ch.ampEnvelope.volume.l);this._setVolume(ch,TsdPlayer._CH_R,ch.ampEnvelope.volume.r);ch.pan=pan};TsdPlayer.prototype._performPortament=function(ch){var frequency=ch.frequency.hz;switch(ch.frequency.type){case TsdPlayer._FREQUENCY_TYPE_NORMAL:if(ch.frequency.param+ch.portament<1)ch.frequency.param=1;else if(ch.frequency.param+ch.portament>65535)ch.frequency.param=65535;else ch.frequency.param+=ch.portament;frequency=ch.frequency.param;break;case TsdPlayer._FREQUENCY_TYPE_MSX:if(ch.frequency.param-ch.portament<0)ch.frequency.param=0;else if(ch.frequency.param-ch.portament>4095)ch.frequency.param=4095;else ch.frequency.param-=ch.portament;frequency=TsdPlayer._PARAMETER_FREQUENCY_TABLE[TsdPlayer._FREQUENCY_TYPE_MSX][ch.frequency.param];break;case TsdPlayer._FREQUENCY_TYPE_FM:if(ch.frequency.param+ch.portament<0)ch.frequency.param=0;else if(ch.frequency.param+ch.portament>8191)ch.frequency.param=8191;else ch.frequency.param+=ch.portament;frequency=TsdPlayer._PARAMETER_FREQUENCY_TABLE[TsdPlayer._FREQUENCY_TYPE_FM][ch.frequency.param];break;case TsdPlayer._FREQUENCY_TYPE_GB_SQUARE:break}this.device.setModuleFrequency(ch.id,frequency)};TsdPlayer.prototype._performPitchModulation=function(ch){var pm=ch.pitchModulation;if(pm.delayCount<pm.delay){pm.delayCount++;return}else if(pm.delayCount==pm.delay){switch(ch.frequency.type){case TsdPlayer._FREQUENCY_TYPE_NORMAL:pm.base=ch.frequency.hz;break;case TsdPlayer._FREQUENCY_TYPE_MSX:pm.base=ch.frequency.param;break;case TsdPlayer._FREQUENCY_TYPE_FM:pm.base=ch.frequency.param;break;case TsdPlayer._FREQUENCY_TYPE_GB_SQUARE:break}pm.currentDepth=pm.depth;pm.currentHeight=pm.height;pm.currentDiff=0;pm.widthCount=0;pm.deltaCount=0;pm.delayCount++;return}else{if(++pm.widthCount!=pm.width)return;pm.widthCount=0;pm.currentDiff+=pm.currentHeight;if(pm.currentDiff>=pm.currentDepth||pm.currentDiff<=-pm.currentDepth){pm.currentHeight=-pm.currentHeight;pm.deltaCount++;if(pm.deltaCount==pm.delta){pm.deltaCount=0;pm.currentDepth++}}var frequency=ch.frequency.hz;var param;switch(ch.frequency.type){case TsdPlayer._FREQUENCY_TYPE_NORMAL:frequency=pm.base+pm.currentDiff;break;case TsdPlayer._FREQUENCY_TYPE_MSX:param=pm.base+pm.currentDiff;if(param<0)param=0;else if(param>4095)param=4095;frequency=TsdPlayer._PARAMETER_FREQUENCY_TABLE[TsdPlayer._FREQUENCY_TYPE_MSX][param];break;case TsdPlayer._FREQUENCY_TYPE_FM:param=pm.base+pm.currentDiff;if(param<0)param=0;else if(param>8191)param=8191;frequency=TsdPlayer._PARAMETER_FREQUENCY_TABLE[TsdPlayer._FREQUENCY_TYPE_FM][param];break;case TsdPlayer._FREQUENCY_TYPE_GB_SQUARE:break}this.device.setModuleFrequency(ch.id,frequency)}};TsdPlayer.prototype._performAmpEnvelope=function(ch){var ae=ch.ampEnvelope;if(++ae.count!=ae.wait)return;ae.count=0;var diff=this.table[ae.id][ae.state];ae.state++;if(ae.state==this.table[ae.id].length)ae.state--;var volumeL=ae.volume.l+diff;var volumeR=ae.volume.r+diff;if(0!=(ch.pan&TsdPlayer._PAN_L))volumeL=this._clamp(volumeL,0,255);else volumeL=0;if(0!=(ch.pan&TsdPlayer._PAN_R))volumeR=this._clamp(volumeR,0,255);else volumeR=0;this._setVolume(ch,TsdPlayer._CH_L,volumeL);this._setVolume(ch,TsdPlayer._CH_R,volumeR)};TsdPlayer.prototype._performSequencer=function(){for(var i=0;i<this.header.numOfChannel;i++){var ch=this.channel[i];if(0==ch.wait)continue;if(0!=--ch.wait)continue;for(;;){var cmd=this.input[ch.baseOffset+ch.offset++];var dt;var dt2;if(cmd<=TsdPlayer.CMD_LAST_NOTE){this._noteOn(ch,cmd);ch.wait=this.input[ch.baseOffset+ch.offset++];if(255==ch.wait){ch.wait=this._readU16(ch.baseOffset+ch.offset);ch.offset+=2}if(0!=ch.wait)break}else if(cmd==TsdPlayer.CMD_NOTE_OFF){this._noteOff(ch);ch.wait=this.input[ch.baseOffset+ch.offset++];if(255==ch.wait){ch.wait=this._readU16(ch.baseOffset+ch.offset);ch.offset+=2}if(0!=ch.wait)break}else if(cmd==TsdPlayer.CMD_VOLUME_MONO){dt=this.input[ch.baseOffset+ch.offset++];ch.volume.c=dt;if(ch.pan&TsdPlayer._PAN_L)ch.volume.l=dt;if(ch.pan&TsdPlayer._PAN_R)ch.volume.r=dt}else if(cmd==TsdPlayer.CMD_SUSTAIN_MODE){ch.sustain=this.input[ch.baseOffset+ch.offset++]}else if(cmd==TsdPlayer.CMD_DETUNE){ch.detune=this._readI8(ch.baseOffset+ch.offset);ch.offset++;this.device.pitchBend(ch.id,ch.detune*128)}else if(cmd==TsdPlayer.CMD_PORTAMENT){ch.portament=this._readI8(ch.baseOffset+ch.offset);ch.offset++;ch.pitchModulation.enable=false}else if(cmd==TsdPlayer.CMD_VOLUME_LEFT){ch.offset++;Log.getLog().info("TSD: volume left")}else if(cmd==TsdPlayer.CMD_VOLUME_RIGHT){ch.offset++;Log.getLog().info("TSD: volume right")}else if(cmd==TsdPlayer.CMD_PANPOT){ch.pan=this.input[ch.baseOffset+ch.offset++];if(ch.pan!=0){var pan=ch.pan==1?0:ch.pan==2?127:64;this.device.panpot(ch.id,pan)}}else if(cmd==TsdPlayer.CMD_RELATIVE_VOLUME_UP){ch.offset++;Log.getLog().info("TSD: volume up")}else if(cmd==TsdPlayer.CMD_RELATIVE_VOLUME_DOWN){ch.offset++;Log.getLog().info("TSD: volume down")}else if(cmd==TsdPlayer.CMD_TEMPO){dt=this._readU16(ch.baseOffset+ch.offset);ch.offset+=2;this._setSequencerFineness(dt)}else if(cmd==TsdPlayer.CMD_FINENESS){dt=this._readU16(ch.baseOffset+ch.offset);ch.offset+=2;this._setAutomationFineness(dt)}else if(cmd==TsdPlayer.CMD_KEY_ON_PHASE){ch.offset++;Log.getLog().info("TSD: key on phase")}else if(cmd==TsdPlayer.CMD_MULTIPLE){dt=this.input[ch.baseOffset+ch.offset++];this._setMultiple(ch,dt)}else if(cmd==TsdPlayer.CMD_PITCH_MODULATION_DELAY){dt=this._readU16(ch.baseOffset+ch.offset);ch.offset+=2;ch.pitchModulation.delay=dt;ch.pitchModulation.enable=0!=dt;ch.portament=0}else if(cmd==TsdPlayer.CMD_PITCH_MODULATION_DEPTH){dt=this.input[ch.baseOffset+ch.offset++];ch.pitchModulation.depth=dt}else if(cmd==TsdPlayer.CMD_PITCH_MODULATION_WIDTH){dt=this.input[ch.baseOffset+ch.offset++];ch.pitchModulation.width=dt}else if(cmd==TsdPlayer.CMD_PITCH_MODULATION_HEIGHT){dt=this._readI8(ch.baseOffset+ch.offset);ch.offset++;ch.pitchModulation.height=dt}else if(cmd==TsdPlayer.CMD_PITCH_MODULATION_DELTA){dt=this.input[ch.baseOffset+ch.offset++];ch.pitchModulation.delta=dt}else if(cmd==TsdPlayer.CMD_AMP_EMVELOPE){dt=this.input[ch.baseOffset+ch.offset++];ch.ampEnvelope.id=dt;dt=this.input[ch.baseOffset+ch.offset++];ch.ampEnvelope.wait=dt;ch.ampEnvelope.enable=0!=dt}else if(cmd==TsdPlayer.CMD_ENDLESS_LOOP_POINT){ch.loop.offset=ch.offset}else if(cmd==TsdPlayer.CMD_LOCAL_LOOP_START){dt=this.input[ch.baseOffset+ch.offset++];ch.localLoop[dt].count=this.input[ch.baseOffset+ch.offset++];ch.localLoop[dt].offset=ch.offset}else if(cmd==TsdPlayer.CMD_LOCAL_LOOP_BREAK){dt=this.input[ch.baseOffset+ch.offset++];if(ch.localLoop[dt].count==1)ch.offset=ch.localLoop[dt].end}else if(cmd==TsdPlayer.CMD_LOCAL_LOOP_END){dt=this.input[ch.baseOffset+ch.offset++];ch.localLoop[dt].end=ch.offset;if(0!=--ch.localLoop[dt].count)ch.offset=ch.localLoop[dt].offset}else if(cmd==TsdPlayer.CMD_FREQUENCY_MODE_CHANGE){ch.frequency.type=this.input[ch.baseOffset+ch.offset++]}else if(cmd==TsdPlayer.CMD_VOLUME_MODE_CHANGE){ch.volume.type=this.input[ch.baseOffset+ch.offset++]}else if(cmd==TsdPlayer.CMD_FM_IN){dt=this.input[ch.baseOffset+ch.offset++];this._setFmInPipe(ch,dt>>4,dt&15)}else if(cmd==TsdPlayer.CMD_FM_OUT){dt=this.input[ch.baseOffset+ch.offset++];this._setFmOutPipe(ch,dt>>4,dt&15)}else if(cmd==TsdPlayer.CMD_CONTROL_CHANGE){Log.getLog().error("TSD: control change is not implemented.")}else if(cmd==TsdPlayer.CMD_PORT_CHANGE){dt=this.input[ch.baseOffset+ch.offset++];dt2=this.input[ch.baseOffset+ch.offset++];this._setPort(ch,dt,dt2)}else if(cmd==TsdPlayer.CMD_VOICE_CHANGE){dt=this.input[ch.baseOffset+ch.offset++];this._setVoice(ch,dt)}else if(cmd==TsdPlayer.CMD_MODULE_CHANGE){dt=this.input[ch.baseOffset+ch.offset++];this._setModule(ch,dt)}else if(cmd==TsdPlayer.CMD_END){if(0!=ch.loop.offset){ch.offset=ch.loop.offset;ch.loop.count++}else{this._noteOff(ch);this.activeChannel--;break}}else{Log.getLog().error("TSD: unsupported cmd "+cmd.toString(16));Log.getLog().info(this);break}}}};TsdPlayer.prototype._noteOn=function(ch,note){var type=ch.frequency.type;var param;var hz;switch(type){case TsdPlayer._FREQUENCY_TYPE_NORMAL:param=ch.detune+TsdPlayer._NOTE_FREQUENCY_TABLE[type][note];hz=param;break;case TsdPlayer._FREQUENCY_TYPE_MSX:param=ch.detune+TsdPlayer._NOTE_PARAMETER_TABLE[type][note];hz=TsdPlayer._PARAMETER_FREQUENCY_TABLE[type][param];break;case TsdPlayer._FREQUENCY_TYPE_FM:param=ch.detune+note<<6;hz=TsdPlayer._PARAMETER_FREQUENCY_TABLE[type][param];break;case TsdPlayer._FREQUENCY_TYPE_GB_SQUARE:param=ch.detune+TsdPlayer._NOTE_FREQUENCY_TABLE[type][note];hz=param;break}this.device.setModuleFrequency(ch.id,hz);ch.frequency.note=note;ch.frequency.param=param;ch.frequency.hz=hz;this._setVolume(ch,TsdPlayer._CH_L,ch.volume.l);this._setVolume(ch,TsdPlayer._CH_R,ch.volume.r);this._setVolume(ch,TsdPlayer._CH_C,ch.volume.c);if(ch.keyOn)this.device.keyOff(ch.id);ch.keyOn=true;this.device.setModulePhase(ch.id,ch.phase);this.device.keyOn(ch.id,note);ch.ampEnvelope.volume.l=ch.volume.l;ch.ampEnvelope.volume.r=ch.volume.r;ch.ampEnvelope.state=0;ch.ampEnvelope.count=0;ch.pitchModulation.delayCount=0};TsdPlayer.prototype._noteOff=function(ch){if(0==ch.sustain){if(!ch.ampEnvelope.enable){this.device.setModuleVolume(ch.id,TsdPlayer._CH_L,0);this.device.setModuleVolume(ch.id,TsdPlayer._CH_R,0)}else{ch.ampEnvelope.volume.l=this.device.getModuleVolume(ch.id,TsdPlayer._CH_L);ch.ampEnvelope.volume.r=this.device.getModuleVolume(ch.id,TsdPlayer._CH_R)}}ch.keyOn=false;this.device.keyOff(ch.id)};TsdPlayer.prototype._setVolume=function(ch,lrc,volume){var data=volume;if(TsdPlayer._CH_L==lrc&&0==(ch.pan&TsdPlayer._PAN_L))data=0;else if(TsdPlayer._CH_R==lrc&&0==(ch.pan&TsdPlayer._PAN_R))data=0;else if(TsdPlayer._VOLUME_TYPE_FM==ch.volume.type)data=TsdPlayer._FM_VOLUME_TABLE[data];this.device.setModuleVolume(ch.id,lrc,data)};TsdPlayer.prototype._setSequencerFineness=function(fineness){this.device.setTimerCallback(TsdPlayer._TIMER_SEQUENCER,fineness,this,this._performSequencer)};TsdPlayer.prototype._setAutomationFineness=function(fineness){this.device.setTimerCallback(TsdPlayer._TIMER_AUTOMATION,fineness,this,this._performAutomation)};TsdPlayer.prototype._setFmInPipe=function(ch,rate,pipe){var param=rate;if(0!=param)param=9-param;this.device.setModuleFmInPipe(ch.id,param,pipe)};TsdPlayer.prototype._setFmOutPipe=function(ch,mode,pipe){this.device.setModuleFmOutPipe(ch.id,mode,pipe)};TsdPlayer.prototype._setMultiple=function(ch,multiple){this.device.setModuleMultiple(ch.id,multiple)};TsdPlayer.prototype._setPort=function(ch,id,mch){this.device.setModulePort(ch.id,id,mch)};TsdPlayer.prototype._setVoice=function(ch,voice){this.device.setModuleVoice(ch.id,voice);if(TssChannel.Module.TYPE_SIN!=this.device.getModuleType(ch.id))return;var fmIn=voice>>4;var fmOut=voice&15;if(0!=fmIn)this._setFmInPipe(ch,5,fmIn%5-1);else this._setFmInPipe(ch,0,0);if(0!=fmOut)this._setFmOutPipe(ch,1,fmOut%5-1);else this._setFmOutPipe(ch,0,0)};TsdPlayer.prototype._setModule=function(ch,module){this.device.setModuleType(ch.id,module&15);if(0!=(module&128))ch.frequency.type=module>>7;else ch.frequency.type=module>>4};var TssCompiler=function(){this.logMmlCompile=false;this.source=null;this.directives=[];this.channels=[];this.validWaves=0;this.waves=[];this.validTables=0;this.tables=[];this.tags={title:null,channels:0,fineness:TssCompiler._DEFAULT_FINENESS};this.modes={hardware:TssCompiler.HARDWARE_MODE_NORMAL,octave:TssCompiler.OCTAVE_MODE_NORMAL,volumeRelative:TssCompiler.VOLUME_RELATIVE_MODE_NORMAL};this.channelData=[]};TssCompiler.VERSION=.94;TssCompiler.HARDWARE_MODE_NORMAL=0;TssCompiler.HARDWARE_MODE_FAMICOM=1;TssCompiler.HARDWARE_MODE_GAMEBOY=2;TssCompiler.VOLUME_RANGE_MODE_NORMAL=0;TssCompiler.VOLUME_RANGE_MODE_UPPER=1;TssCompiler.VOLUME_RELATIVE_MODE_NORMAL=0;TssCompiler.VOLUME_RELATIVE_MODE_REVERSE=1;TssCompiler.OCTAVE_MODE_NORMAL=0;TssCompiler.OCTAVE_MODE_REVERSE=1;TssCompiler._DEFAULT_FINENESS=368;TssCompiler._ALPHABET_COUNT="z".charCodeAt(0)-"a".charCodeAt(0)+1;TssCompiler._CODE_ESCAPE="\\".charCodeAt(0);TssCompiler._CODE_SHARP="#".charCodeAt(0);TssCompiler._CODE_GT=">".charCodeAt(0);TssCompiler._TONE_TABLE={c:0,d:2,e:4,f:5,g:7,a:9,b:11};TssCompiler._TRIANGLE_TABLE=[0,16,32,48,64,80,96,112,127,112,96,80,64,48,32,16,0,-16,-32,-48,-64,-80,-96,-112,-128,-112,-96,-80,-64,-48,-32,-16];TssCompiler.CompileError=function(line,offset,message){this.line=line;this.offset=offset;this.message=message};TssCompiler.CompileError.prototype.toString=function(){var n=0;var c;var i;var data=this.line.data;for(i=0;i<=this.offset;i++){c=data.at(i);if(0==c||TssCompiler._CODE_ESCAPE==c)continue;n++}var hintArray=new Uint8Array(n--);for(i=0;i<n;i++)hintArray[i]=32;hintArray[i]="^".charCodeAt(0);var hint=TString.createFromUint8Array(hintArray).toString();return"TSS: { line: "+this.line.line+", offset: "+this.offset+" } "+this.message+"\n"+data.toString()+"\n"+hint};TssCompiler._toUint8=function(n){if(n<-128||127<n)throw new RangeError("unsupported range");if(n<0)n=256+n;return n&255};TssCompiler._getBracedParameter=function(line,offset){var data=line.data;var length=data.byteLength();var begin=offset+data.countSpaces(offset);if(begin>=length||"<"!=data.charAt(begin))return{begin:begin,end:begin,parameter:undefined};begin++;var n=0;var c=0;for(var i=begin;i<length;i++){c=data.at(i);if(0==c||TssCompiler._CODE_ESCAPE==c)continue;if(TssCompiler._CODE_GT==c)break;n++}var end=begin+n-1;var param=TString.createFromUint8Array(new Uint8Array(n));n=0;for(i=begin;i<=end;i++){c=data.at(i);if(0==c||TssCompiler._CODE_ESCAPE==c)continue;param.setAt(n++,c)}return{begin:begin-1,end:end+1,parameter:param}};TssCompiler._getNumberParameter=function(line,offset){var data=line.data;var begin=offset+data.countSpaces(offset);var length=data.byteLength();if(begin>=length)return{begin:begin,end:begin,parameter:undefined};var sign=1;if("-"==data.charAt(begin)){begin++;begin+=data.countSpaces(begin);sign=-1}var n=data.numberAt(begin);if(n<0)return{begin:begin,end:begin,parameter:undefined};var c=0;for(var i=begin+1;i<length;i++){c=data.at(i);if(0==c||TssCompiler._CODE_ESCAPE==c)continue;var result=data.numberAt(i);if(result<0)return{begin:begin,end:i-1,parameter:sign*n};n=n*10+result}return{begin:begin,end:i-1,parameter:sign*n}};TssCompiler._getStringParameter=function(line,offset){var data=line.data;var begin=offset+data.countSpaces(offset);var length=data.byteLength();var n=0;var c=0;for(var i=begin;i<length;i++){c=data.at(i);if(0==c||TssCompiler._CODE_ESCAPE==c)continue;n++}var end=begin+n-1;var param=TString.createFromUint8Array(new Uint8Array(n));n=0;for(i=begin;i<=end;i++){c=data.at(i);if(0==c||TssCompiler._CODE_ESCAPE==c)continue;param.setAt(n++,c)}return{begin:begin,end:end,parameter:param}};TssCompiler._getTableParameter=function(_lines,_offset){var work={lines:_lines,line:0,offset:_offset};var table=[];var begin=work.offset;var directive=work.lines[0].directive;var n=TssCompiler._getNumberParameter(work.lines[work.line],work.offset);if(typeof n.parameter=="undefined")throw new TssCompiler.CompileError(work.lines[work.line],n.begin,"id number not found in #"+directive);var id=n.parameter;if(id<0||255<id)throw new TssCompiler.CompileError(work.lines[work.line],n.begin,"id "+id+" is out or range 0 to 255 in #"+directive);work.offset=n.end+1;TssCompiler._checkCharacter(work,",","',' not found after id number in #"+directive);TssCompiler._checkCharacter(work,"<","'<' not found in #"+directive);for(;;){var ch=TssCompiler._findNextCharacter(work,"incomplete entry in #"+directive);if("("==ch){work.offset++;var firstNumberNotFound="number not found after '(' in #"+directive;TssCompiler._findNextCharacter(work,firstNumberNotFound);n=TssCompiler._getNumberParameter(work.lines[work.line],work.offset);if(typeof n.parameter=="undefined")throw new TssCompiler.CompileError(work.lines[work.line],n.begin,firstNumberNotFound);var x=n.parameter;var numberOutOfRange="number is out of range -128 to 127 in #"+directive;if(x<-128||127<x)throw new TssCompiler.CompileError(work.lines[work.line],n.begin,numberOutOfRange);work.offset=n.end+1;TssCompiler._checkCharacter(work,",","',' not found after the first number after '(' in #"+directive);var secondNumberNotFound="the second number not found after "+"'(' in #"+directive;TssCompiler._findNextCharacter(work,secondNumberNotFound);n=TssCompiler._getNumberParameter(work.lines[work.line],work.offset);if(typeof n.parameter=="undefined")throw new TssCompiler.CompileError(work.lines[work.line],n.begin,secondNumberNotFound);var y=n.parameter;if(y<-128||127<y)throw new TssCompiler.CompileError(work.lines[work.line],n.begin,numberOutOfRange);work.offset=n.end+1;TssCompiler._checkCharacter(work,")","')' not found after the second number in #"+directive);TssCompiler._checkCharacter(work,",","',' not found after '(x,y)' syntax in #"+directive);var lastNumberNotFound="number not found after '(x,y),' "+"syntax in #"+directive;TssCompiler._findNextCharacter(work,lastNumberNotFound);n=TssCompiler._getNumberParameter(work.lines[work.line],work.offset);if(typeof n.parameter=="undefined")throw new TssCompiler.CompileError(work.lines[work.line],n.begin,lastNumberNotFound);var count=n.parameter;work.offset=n.end+1;var expand=[];for(var i=0;i<count;i++){var element=~~(x+(y-x)*i/(count-1));expand.push(element);table.push(element)}Log.getLog().info("TSS: expanding ("+x+","+y+"),"+count+" to "+expand)}else{var numberNotFound="number not found in #"+directive;TssCompiler._findNextCharacter(work,numberNotFound);n=TssCompiler._getNumberParameter(work.lines[work.line],work.offset);if(typeof n.parameter=="undefined")throw new TssCompiler.CompileError(work.lines[work.line],n.begin,numberNotFound);if(n.parameter<-128||127<n.parameter)throw new TssCompiler.CompileError(work.lines[work.line],n.begin,numberOutOfRange);work.offset=n.end+1;table.push(n.parameter)}var delimiterNotFound="',' or '>' not found in #"+directive;ch=TssCompiler._findNextCharacter(work,delimiterNotFound);if(","==ch){work.offset++}else if(">"==ch){work.offset++;break}else{throw new TssCompiler.CompileError(work.lines[work.line],work.offset,delimiterNotFound)}}try{TssCompiler._findNextCharacter(work,"")}catch(e){Log.getLog().info("TSS: table complete "+table);return{begin:begin,end:work.offset,parameter:{id:id,table:table}}}throw new TssCompiler.CompileError(work.lines[work.line],work.offset,"unknown data after table in #"+directive)};TssCompiler._getCharacter=function(line,offset,character){var data=line.data;var position=offset+data.countSpaces(offset);if(position>=data.byteLength())return-1;if(character!=data.charAt(position))return-1;return position};TssCompiler._findNextCharacter=function(work,message){var length=work.lines.length;if(TssCompiler._checkEnd(work.lines[work.line],work.offset)&&work.line+1<length){work.line++;work.offset=0}work.offset+=work.lines[work.line].data.countSpaces(work.offset);if(work.offset==work.lines[work.line].data.byteLength())throw new TssCompiler.CompileError(work.lines[work.line],work.offset,message);return work.lines[work.line].data.charAt(work.offset)};TssCompiler._checkCharacter=function(work,ch,message){TssCompiler._findNextCharacter(work,message);var result=TssCompiler._getCharacter(work.lines[work.line],work.offset,ch);if(result<0)throw new TssCompiler.CompileError(work.lines[work.line],work.offset,message);work.offset=result+1};TssCompiler._checkEnd=function(line,offset){var data=line.data;offset+=data.countSpaces(offset);return offset==data.byteLength()};TssCompiler._checkChannelDirective=function(line){if(2<line.directive.length||0==line.directive.length)return;var n=TString.createFromString(line.directive);var channel=0;var offset=0;var index;if(2==n.byteLength()){index=n.alphabetIndex(offset++);if(index<0)return;channel=(index+1)*TssCompiler._ALPHABET_COUNT}index=n.alphabetIndex(offset);if(index<0)return;channel+=index;line.directive=channel};TssCompiler._checkDirective=function(line){var data=line.data;var length=data.byteLength();var c=0;for(var i=0;i<length;i++){c=data.at(i);if(0==c)continue;if(TssCompiler._CODE_SHARP==c){data.setAt(i++,0);break}line.directive=null;return}for(var start=i;i<length;i++)if(32==data.at(i))break;line.directive=data.slice(start,i).toString();for(var offset=start;offset<i;offset++)data.setAt(offset,0);TssCompiler._checkChannelDirective(line)};TssCompiler.prototype._setWave=function(id,wave){Log.getLog().info("TSC: set wave "+id);if(!this.waves[id])this.validWaves++;this.waves[id]=wave};TssCompiler.prototype._setTable=function(id,table){Log.getLog().info("TSC: set table "+id+"; size = "+table.length);if(!this.tables[id])this.validTables++;this.tables[id]=table};TssCompiler.prototype._preprocessLine=function(context,offset,count){var result={line:context.line,offset:offset,count:count,data:null,empty:true,directive:null,continuation:false};var line=this.source.slice(offset,offset+count);result.data=line;for(var i=0;i<count;i++){var c=line.charAt(i);if(context.commentNest>0){if("\\"==c)line.setAt(i++,0);else if("{"==c)context.commentNest++;else if("}"==c)context.commentNest--;line.setAt(i,0)}else{if("\\"==c){line.setAt(i++,0);result.empty=false}else if("{"==c){context.commentNest++;line.setAt(i,0)}else if("}"==c){context.commentNest--;line.setAt(i,0);if(context.commentNest<0)throw new TssCompiler.CompileError(result,i,"'}' appears without '{'")}else{if("\t"==c)line.setAt(i,32);result.empty=false}}}if(!result.empty)TssCompiler._checkDirective(result);return result};TssCompiler.prototype._parseLines=function(){var context={line:1,commentNest:0};var channel=null;var length=this.source.byteLength();for(var offset=0;offset<length;context.line++){var count=this.source.countLine(offset);var line=this._preprocessLine(context,offset,count);if(!line.empty){if(null==line.directive){if(null==channel)throw new TssCompiler.CompileError(line,0,"invalid line without any directive");line.directive=channel;line.continuation=true}else{channel=line.directive}if(typeof line.directive=="number"){if(undefined==this.channels[line.directive])this.channels[line.directive]=[];this.channels[line.directive].push(line)}else{if("END"==line.directive)break;this.directives.push(line)}}offset+=count;offset+=this.source.countLineDelimiter(offset)}Log.getLog().info("TSS: found "+this.directives.length+" directive(s)");Log.getLog().info("TSS: found "+this.channels.length+" channel(s)");for(var i=0;i<this.channels.length;i++){var n=0;if(undefined!=this.channels[i])n=this.channels[i].length;Log.getLog().info("TSS: channel "+(i+1)+" has "+n+" line(s)")}};TssCompiler.prototype._parseDirectives=function(){for(var i=0;i<this.directives.length;i++){var directive=this.directives[i].directive;var offset=0;var result;if("CHANNEL"==directive){result=TssCompiler._getNumberParameter(this.directives[i],0);if(typeof result.parameter=="undefined")throw new TssCompiler.CompileError(this.directives[i],result.begin,"number not found in #CHANNEL");this.tags.channels=result.parameter;offset=result.end+1;Log.getLog().info("TSS: CHANNEL> "+this.tags.channels)}else if("FINENESS"==directive){result=TssCompiler._getNumberParameter(this.directives[i],0);if(typeof result.parameter=="undefined")throw new TssCompiler.CompileError(this.directives[i],result.begin,"number not found in #FINENESS");this.tags.fineness=result.parameter;offset=result.end+1;Log.getLog().info("TSS: FINENESS> "+this.tags.fineness)}else if("OCTAVE"==directive){result=TssCompiler._getStringParameter(this.directives[i],0);if(!result.parameter)throw new TssCompiler.CompileError(this.directives[i],result.begin,"syntax error in #PRAGMA");var octave=result.parameter.toString();if(octave=="NORMAL")this.modes.octave=TssCompiler.OCTAVE_MODE_NORMAL;else if(octave=="REVERSE")this.modes.octave=TssCompiler.OCTAVE_MODE_REVERSE;else throw new TssCompiler.CompileError(this.directive[i],result.begin,"invalid argument in #OCTAVE");offset=result.end+1}else if("PRAGMA"==directive){result=TssCompiler._getStringParameter(this.directives[i],0);if(!result.parameter)throw new TssCompiler.CompileError(this.directives[i],result.begin,"syntax error in #PRAGMA");var pragma=result.parameter.toString();if(pragma=="FAMICOM"){this.modes.hardware=TssCompiler.HARDWARE_MODE_FAMICOM;this._setWave(0,TssCompiler._TRIANGLE_TABLE)}else if(pragma=="GAMEBOY"){this.modes.hardware=TssCompiler.HARDWARE_MODE_GAMEBOY}else{throw new TssCompiler.CompileError(this.directives[i],result.begin,"unknown pragma parameter "+pragma)}offset=result.end+1;Log.getLog().info("TSS: PRAGMA> "+pragma)}else if("TABLE"==directive){var lines=[];for(;;i++){lines.push(this.directives[i]);if(i+1==this.directives.length)break;if(!this.directives[i+1].continuation)break}result=TssCompiler._getTableParameter(lines,0);this._setTable(result.parameter.id,result.parameter.table);offset=result.end}else if("TITLE"==directive){result=TssCompiler._getBracedParameter(this.directives[i],0);if(!result.parameter)throw new TssCompiler.CompileError(this.directives[i],result.begin,"syntax error in #TITLE");this.tags.title=result.parameter;offset=result.end+1;Log.getLog().info("TSS: TITLE> "+this.tags.title.toString())}else if("VOLUME"==directive){result=TssCompiler._getStringParameter(this.directives[i],0);if(!result.parameter)throw new TssCompiler.CompileError(this.directives[i],result.begin,"syntax error in #VOLUME");var volume=result.parameter.toString();if(volume=="NORMAL")this.modes.volumeRelative=TssCompiler.VOLUME_RELATIVE_MODE_NORMAL;else if(volume=="REVERSE")this.modes.volumeRelative=TssCompiler.VOLUME_RELATIVE_MODE_REVERSE;else throw new TssCompiler.CompileError(this.directive[i],result.begin,"invalid argument in #VOLUME");offset=result.end+1}else if("WAV"==directive){var lines=[];for(;;i++){lines.push(this.directives[i]);if(i+1==this.directives.length)break;if(!this.directives[i+1].continuation)break}result=TssCompiler._getTableParameter(lines,0);if(32!=result.parameter.table.length)throw new TssCompiler.CompileError(this.directive[i],result.begin,"invalid wave table size "+result.parameter.table.length);this._setWave(result.parameter.id,result.parameter.table);offset=result.end}else{throw new TssCompiler.CompileError(this.directives[i],0,"unknown directive: "+directive)}if(!TssCompiler._checkEnd(this.directives[i],offset))throw new TssCompiler.CompileError(this.directives[i],offset,"syntax error after #"+directive)}};TssCompiler.prototype._parseChannels=function(){var maxGate=16;var notImplemented=function(self,work,command,args){throw new TssCompiler.CompileError(work.lineObject,work.offset,"command '"+command+"' not implemented")};var processRelativeVolume=function(self,work,command,args){var max=255;if(work.mode==TssCompiler.HARDWARE_MODE_GAMEBOY)max=16;var upcommand="(";if(work.volumeRelativeMode!=TssCompiler.VOLUME_RELATIVE_MODE_NORMAL)upcommand=")";var stereo=work.currentVolume.r>=0;if(command==upcommand){work.currentVolume.l+=1<<work.volumeShift;if(stereo)work.currentVolume.r+=1<<work.volumeShift}else{work.currentVolume.l-=1<<work.volumeShift;if(stereo)work.currentVolume.r-=1<<work.volumeShift}if(work.currentVolume.l<0||work.currentVolume.l>max||stereo&&work.currentVolume.r<0||stereo&&work.currentVolume.r>max)throw new TssCompiler.CompileError(work.lineObject,work.offset,"commmand '"+command+"' causes volume range error");if(stereo){work.data.push(TsdPlayer.CMD_VOLUME_LEFT);work.data.push(work.currentVolume.l);work.data.push(TsdPlayer.CMD_VOLUME_RIGHT);work.data.push(work.currentVolume.r)}else{work.data.push(TsdPlayer.CMD_VOLUME_MONO);work.data.push(work.currentVolume.l)}};var syntax={$:{args:[],callback:function(self,work,command,args){work.data.push(TsdPlayer.CMD_ENDLESS_LOOP_POINT)}},"%":{args:[{def:0,min:0,max:255}],callback:function(self,work,command,args){if(TssCompiler.HARDWARE_MODE_FAMICOM==work.mode||TssCompiler.HARDWARE_MODE_GAMEBOY==work.mode)throw new TssCompiler.CompileError(work.lineObject,work.offset,"'%' is not supported in NES/GameBoy mode");work.data.push(TsdPlayer.CMD_MODULE_CHANGE);work.data.push(args[0])}},"(":{args:[],callback:processRelativeVolume},")":{args:[],callback:processRelativeVolume},"/":{sequence:":",args:[],callback:function(self,work,command,args){if(work.localLoopId==0)throw new TssCompiler.CompileError(work.lineObject,work.offset,"'/' found without '/:'");work.data.push(TsdPlayer.CMD_LOCAL_LOOP_BREAK);work.data.push(work.localLoopId-1)}},"/:":{args:[{def:2,min:2,max:255}],callback:function(self,work,command,args){if(work.localLoopId>15)throw new TssCompiler.CompileError(work.lineObject,work.offset,"local loop is too deep (>16)");work.data.push(TsdPlayer.CMD_LOCAL_LOOP_START);work.data.push(work.localLoopId++);work.data.push(args[0])}},":":{sequence:"/"},":/":{args:[],callback:function(self,work,command,args){if(work.localLoopId==0)throw new TssCompiler.CompileError(work.lineObject,work.offset,"':/' found without '/:'");work.data.push(TsdPlayer.CMD_LOCAL_LOOP_END);work.data.push(--work.localLoopId)}},"<":{args:[],callback:function(self,work,command,args){if(TssCompiler.OCTAVE_MODE_NORMAL==work.octaveMode)work.currentOctave++;else work.currentOctave--}},">":{args:[],callback:function(self,work,command,args){if(TssCompiler.OCTAVE_MODE_NORMAL==work.octaveMode)work.currentOctave--;else work.currentOctave++}},"@":{sequence:"ciopv",args:[{def:0,min:0,max:255}],callback:function(self,work,command,args){if(TssCompiler.HARDWARE_MODE_FAMICOM==work.mode){if(work.lineObject.directive==2)throw new TssCompiler.CompileError(work.lineObject,work.offset,"'@' is not supported in famicom mode "+"channel 3");else if(2!=args[0]&&4!=args[0]&&6!=args[0]&&7!=args[0])throw new TssCompiler.CompileError(work.lineObject,work.offset,"voice id "+args[0]+" is invalid in famicom mode")}work.data.push(TsdPlayer.CMD_VOICE_CHANGE);work.data.push(args[0])}},"@c":{args:[{def:0,min:0,max:127},{def:0,min:0,max:127}],callback:function(self,work,command,args){work.data.push(TsdPlayer.CMD_CONTROL_CHANGE);work.data.push(args[0]);work.data.push(args[1])}},"@i":{args:[{def:0,min:0,max:8},{def:0,min:0,max:3}],callback:function(self,work,command,args){work.data.push(TsdPlayer.CMD_FM_IN);work.data.push(args[0]<<4|args[1])}},"@o":{args:[{def:0,min:0,max:2},{def:0,min:0,max:3}],callback:function(self,work,command,args){work.data.push(TsdPlayer.CMD_FM_OUT);work.data.push(args[0]<<4|args[1])}},"@p":{args:[{def:0,min:0,max:3},{def:0,min:0,max:127}],callback:function(self,work,command,args){work.data.push(TsdPlayer.CMD_PORT_CHANGE);work.data.push(args[0]);work.data.push(args[1])}},"@v":{args:[{def:10,min:0,max:255},{def:0,min:0,max:255}],callback:function(self,work,command,args){work.volumeShift=0;if(1==args.length){work.currentVolume.l=args[0];work.currentVolume.r=-1;work.data.push(TsdPlayer.CMD_VOLUME_MONO);work.data.push(args[0])}else{work.currentVolume.l=args[0];work.currentVolume.r=args[1];work.data.push(TsdPlayer.CMD_VOLUME_LEFT);work.data.push(args[0]);work.data.push(TsdPlayer.CMD_VOLUME_RIGHT);work.data.push(args[1])}}},"]":{args:[],callback:function(self,work,command,args){if(0==work.loop.count)throw new TssCompiler.CompileError(work.lineObject,work.offset,"']' found without '['");if(--work.loop.count==0)return;work.loop.end.line=work.line;work.loop.end.offset=work.offset;work.line=work.loop.line;work.offset=work.loop.offset;work.lineObject=self.channels[work.lineObject.directive][work.line]}},"[":{args:[{def:2,min:2,max:65535}],callback:function(self,work,command,args){work.loop.count=args[0];work.loop.line=work.line;work.loop.offset=work.offset}},_:{args:[],callback:notImplemented},"|":{args:[],callback:function(self,work,command,args){if(work.loop.count>1)return;work.line=work.loop.end.line;work.offset=work.loop.end.offset;work.lineObject=self.channels[work.lineObject.directive][work.line]}},"~":{args:[],callback:notImplemented},k:{args:[{def:0,min:-128,max:127}],callback:function(self,work,command,args){work.data.push(TsdPlayer.CMD_DETUNE);work.data.push(TssCompiler._toUint8(args[0]))}},l:{args:[{def:4,min:1,max:1024}],callback:function(self,work,command,args){work.defaultLength=args[0];work.defaultDot=0;for(;;){var position=TssCompiler._getCharacter(work.lineObject,work.offset,".");if(position<0)break;work.offset=position+1;work.defaultDot++}}},m:{sequence:"lp"},ml:{args:[{def:1,min:1,max:255}],callback:function(self,work,command,args){work.data.push(TsdPlayer.CMD_MULTIPLE);work.data.push(args[0])}},mp:{args:[{def:undefined,min:0,max:65535},{def:undefined,min:0,max:255},{def:undefined,min:0,max:255},{def:undefined,min:-128,max:127},{def:undefined,min:0,max:255}],callback:function(self,work,command,args){if(typeof args[0]!="undefined"){work.data.push(TsdPlayer.CMD_PITCH_MODULATION_DELAY);work.data.push(args[0]>>8);work.data.push(args[0]&255)}if(args.length<2)return;if(typeof args[1]!="undefined"){work.data.push(TsdPlayer.CMD_PITCH_MODULATION_DEPTH);work.data.push(args[1])}if(args.length<3)return;if(typeof args[2]!="undefined"){work.data.push(TsdPlayer.CMD_PITCH_MODULATION_WIDTH);work.data.push(args[2])}if(args.length<4)return;if(typeof args[3]!="undefined"){work.data.push(TsdPlayer.CMD_PITCH_MODULATION_HEIGHT);work.data.push(TssCompiler._toUint8(args[3]))}if(args.length<5)return;if(typeof args[4]!="undefined"){work.data.push(TsdPlayer.CMD_PITCH_MODULATION_DELTA);work.data.push(args[4])}}},n:{sequence:"ast"},na:{args:[{def:0,min:0,max:255},{def:0,min:0,max:255}],callback:function(self,work,command,args){work.data.push(TsdPlayer.CMD_AMP_EMVELOPE);work.data.push(args[0]);work.data.push(args[1])}},ns:{args:[],callback:notImplemented},nt:{args:[],callback:notImplemented},o:{args:[{def:4,min:0,max:10}],callback:function(self,work,command,args){work.currentOctave=args[0]}},p:{sequence:"h",args:[{def:0,min:0,max:3}],callback:function(self,work,command,args){work.data.push(TsdPlayer.CMD_PANPOT);work.data.push(args[0])}},ph:{args:[],callback:notImplemented},q:{args:[{def:maxGate,min:0,max:maxGate}],callback:function(self,work,command,args){work.currentGate=args[0]}},r:{args:[],callback:function(self,work,command,args){if("r"!=command){if(work.currentOctave<0||10<work.currentOctave)throw new TssCompiler.CompileError(work.lineObject,work.offset,"current octave is out of range")}work.offset+=work.lineObject.data.countSpaces(work.offset);var fine=0;if(work.offset<work.lineObject.data.byteLength()){var c=work.lineObject.data.charAt(work.offset);if("-"==c||"+"==c||"#"==c){work.offset++;if("-"==c)fine=-1;else fine=1}}var totalCount=0;for(;;){var result=TssCompiler._getNumberParameter(work.lineObject,work.offset);var length=0;var dot=0;if(typeof result.parameter=="undefined"){length=work.defaultLength;dot=work.defaultDot}else{length=result.parameter;work.offset=result.end+1}for(;;){var position=TssCompiler._getCharacter(work.lineObject,work.offset,".");if(position<0)break;work.offset=position+1;dot++}if(0!=work.clock%length)Log.getLog().warn("TSS: time resolution is not "+"enough for length "+length);var count=~~(work.clock/length);totalCount+=count;while(dot-- >0){if(0!=count%2)throw new TssCompiler.CompileError(work.lineObject,work.offset,"too many '.' against time"+" resolution");count/=2;totalCount+=count}position=TssCompiler._getCharacter(work.lineObject,work.offset,"^");if(position<0)break;work.offset=position+1}var restCount=0;work.count+=totalCount;if("r"==command){work.data.push(TsdPlayer.CMD_NOTE_OFF)}else{fine+=work.currentOctave*12+TssCompiler._TONE_TABLE[command];if(fine<0){Log.getLog().warn("TSS: too low tone (clamped)");fine=0}else if(fine>127){Log.getLog().warn("TSS: too high tone (clamped)");fine=127}work.data.push(fine);restCount=totalCount;totalCount=~~(totalCount*work.currentGate/work.maxGate);restCount-=totalCount}if(self.logMmlCompile)Log.getLog().info(totalCount+","+restCount);if(totalCount<255){work.data.push(totalCount)}else if(totalCount<65535){work.data.push(255);work.data.push(totalCount>>8);work.data.push(totalCount&255)}else{throw new TssCompiler.CompileError(work.lineObject,work.offset,"note length is too long")}if(restCount>0){work.data.push(TsdPlayer.CMD_NOTE_OFF);if(restCount<255){work.data.push(restCount)}else if(restCount<65535){work.data.push(255);work.data.push(restCount>>8);work.data.push(restCount&255)}else{throw new TssCompiler.CompileError(work.lineObject,work.offset,"rest length is too long")}}}},s:{args:[{def:undefined,min:0,max:255},{def:undefined,min:-128,max:127}],callback:function(self,work,command,args){if(typeof args[0]!="undefined"){work.data.push(TsdPlayer.CMD_SUSTAIN_MODE);work.data.push(args[0])}if(2==args.length&&typeof args[1]!="undefined"){work.data.push(TsdPlayer.CMD_PORTAMENT);work.data.push(TssCompiler._toUint8(args[1]))}}},t:{args:[{def:120,min:1,max:512}],callback:function(self,work,command,args){var n=~~(22050*4*60/192/args[0]);work.data.push(TsdPlayer.CMD_TEMPO);work.data.push(n>>8);work.data.push(n&255)}},v:{args:[{def:10,min:0,max:15},{def:0,min:0,max:15}],callback:function(self,work,command,args){if(TsdPlayer.HARDWARE_MODE_GAMEBOY==work.mode&&2==work.lineObject.directive)for(var i=0;i<args.length;i++)if(args[i]>3)throw new TssCompiler.CompileError(work.lineObject,work.offset,"volume must be less than 4"+" for channel 2 in gameboy mode");var base=0;work.volumeShift=3;if(TsdPlayer.HARDWARE_MODE_GAMEBOY==work.mode)work.volumeShift=0;else if(TssCompiler.VOLUME_RANGE_MODE_NORMAL==work.volumeRangeMode)work.volumeShift=4;else base=128;if(1==args.length){work.currentVolume.l=base+(args[0]<<work.volumeShift);work.currentVolume.r=-1;work.data.push(TsdPlayer.CMD_VOLUME_MONO);work.data.push(work.currentVolume.l)}else{work.currentVolume.l=base+(args[0]<<work.volumeShift);work.currentVolume.r=base+(args[1]<<work.volumeShift);work.data.push(TsdPlayer.CMD_VOLUME_LEFT);work.data.push(work.currentVolume.l);work.data.push(TsdPlayer.CMD_VOLUME_RIGHT);work.data.push(work.currentVolume.r)}}},x:{args:[{def:undefined,min:0,max:17},{def:undefined,min:0,max:3}],callback:function(self,work,command,args){if(args[0]!=undefined){if((args[0]&15)>1)throw new TssCompiler.CompileError(work.lineObject,work.offset,"invalid volume mode "+args[0]+" for 'x'");if((args[0]&16)==0)work.volumeRangeMode=TssCompiler.VOLUME_RANGE_MODE_NORMAL;else work.volumeRangeMode=TssCompiler.VOLUME_RANGE_MODE_UPPER;work.data.push(TsdPlayer.CMD_VOLUME_MODE_CHANGE);work.data.push(args[0]&15)}if(args[1]!=undefined){work.data.push(TsdPlayer.CMD_FREQUENCY_MODE_CHANGE);work.data.push(args[1])}}}};for(var ch=0;ch<this.tags.channels;ch++){var work={offset:0,line:0,lineObject:null,clock:192,maxGate:maxGate,mode:this.modes.hardware,volumeRangeMode:TssCompiler.VOLUME_RANGE_MODE_NORMAL,volumeRelativeMode:this.modes.volumeRelative,volumeShift:0,octaveMode:this.modes.octave,currentVolume:{l:0,r:0},currentOctave:4,currentGate:maxGate,defaultDot:0,defaultLength:4,loop:{offset:0,line:0,count:0,end:{offset:0,line:0}},localLoopId:0,count:0,data:[],dataLength:0};if(0==ch){work.data.push(TsdPlayer.CMD_FINENESS);work.data.push(this.tags.fineness>>8);work.data.push(this.tags.fineness&255)}if(TssCompiler.HARDWARE_MODE_FAMICOM==work.mode){work.data.push(TsdPlayer.CMD_MODULE_CHANGE);if(2!=ch)work.data.push(1);else work.data.push(4)}else if(TssCompiler.HARDWARE_MODE_GAMEBOY==work.mode){work.data.push(TsdPlayer.CMD_MODULE_CHANGE);if(3==ch)work.data.push(15);else if(2==ch)work.data.push(14);else work.data.push(13);work.data.push(TsdPlayer.CMD_FREQUENCY_MODE_CHANGE);if(2==ch)work.data.push(3)}for(work.line=0;work.line<this.channels[ch].length;work.line++){work.lineObject=this.channels[ch][work.line];for(work.offset=0;work.offset<work.lineObject.data.byteLength();){work.offset+=work.lineObject.data.countSpaces(work.offset);if(work.offset>=work.lineObject.data.byteLength())break;var c=work.lineObject.data.lowerCharAt(work.offset);var command=c;var args=[];if("a"<=c&&c<="g")c="r";if(!syntax[c])throw new TssCompiler.CompileError(work.lineObject,work.offset,"unknown command '"+c+"'");work.offset++;if(syntax[c].sequence){work.offset+=work.lineObject.data.countSpaces(work.offset);if(work.offset>=work.lineObject.data.byteLength())break;var next=work.lineObject.data.lowerCharAt(work.offset);if(syntax[c].sequence.indexOf(next)>=0){c+=next;command=c;work.offset++}}if(this.logMmlCompile)Log.getLog().info("command "+command+" with parameters as follows");for(var i=0;i<syntax[c].args.length;i++){if(0!=i){var position=TssCompiler._getCharacter(work.lineObject,work.offset,",");if(position<0)break;work.offset=position+1}var result=TssCompiler._getNumberParameter(work.lineObject,work.offset);if(typeof result.parameter=="undefined"){if(typeof syntax[c].args[i].def=="undefined"&&syntax[c].args[i].mandatory)throw new TssCompiler.CompileError(work.lineObject,work.offset,"missing argument for '"+c+"'");args.push(syntax[c].args[i].def)}else{args.push(result.parameter);work.offset=result.end+1}}if(this.logMmlCompile)Log.getLog().info(args);work.dataLength=work.data.length;if(syntax[c].callback)syntax[c].callback(this,work,command,args);if(this.logMmlCompile){var message="> "+work.dataLength.toString(16)+": ";for(i=work.dataLength;i<work.data.length;i++){if(i!=work.dataLength)message+=", ";message+=work.data[i].toString(16)}Log.getLog().info(message)}work.dataLength=work.data.length}}work.data.push(TsdPlayer.CMD_END);this.channelData[ch]=work.data;Log.getLog().info("TSS: DATA "+(ch+1)+"> "+work.data.length+" Byte(s) / "+work.count+" Tick(s)")}};TssCompiler.prototype._generateTsd=function(){var titleSize=this.tags.title.byteLength();if(0!=titleSize%2)titleSize++;var headerSize=14+2+2+titleSize+2+8*this.tags.channels+4;var dataSize=headerSize;Log.getLog().info("TSS: HEADER SIZE> "+dataSize);var i;for(i=0;i<this.tags.channels;i++)dataSize+=this.channelData[i].length;var voiceOffset=dataSize;dataSize+=2;Log.getLog().info("TSS: WAVE> "+this.validWaves);for(i=0;i<this.waves.length;i++){if(!this.waves[i])continue;Log.getLog().info("TSS:  "+i+"> "+this.waves[i].length);dataSize+=2+this.waves[i].length}dataSize+=2;Log.getLog().info("TSS: TABLE> "+this.validTables);for(i=0;i<this.tables.length;i++){if(!this.tables[i])continue;Log.getLog().info("TSS:  "+i+"> "+this.tables[i].length);dataSize+=2+this.tables[i].length}var tsd=new Uint8Array(dataSize);Log.getLog().info("TSS: TOTAL SIZE> "+dataSize);var tsdWriter=TString.createFromUint8Array(tsd);var offset=tsdWriter.setASCII(0,"T'SoundSystem");tsdWriter.setAt(offset++,Math.floor(TssCompiler.VERSION));tsdWriter.setAt(offset++,Math.floor(TssCompiler.VERSION*100)%100);offset=tsdWriter.setUint16(offset,this.tags.title.byteLength());offset=tsdWriter.setTString(offset,this.tags.title);if(0==this.tags.title.byteLength()%2)offset--;offset=tsdWriter.setUint16(offset,this.tags.channels);var channelOffset=headerSize;for(i=0;i<this.tags.channels;i++){var channelSize=this.channelData[i].length;offset=tsdWriter.setUint32(offset,channelOffset);offset=tsdWriter.setUint32(offset,channelSize);for(var n=0;n<channelSize;n++)tsdWriter.setAt(channelOffset+n,this.channelData[i][n]);channelOffset+=channelSize}offset=tsdWriter.setUint32(offset,voiceOffset);offset=tsdWriter.setUint16(voiceOffset,this.validWaves);for(i=0;i<this.waves.length;i++){if(!this.waves[i])continue;tsdWriter.setAt(offset++,i);var dataLength=this.waves[i].length;tsdWriter.setAt(offset++,dataLength);for(var dataOffset=0;dataOffset<dataLength;dataOffset++)tsdWriter.setAt(offset++,TssCompiler._toUint8(this.waves[i][dataOffset]))}offset=tsdWriter.setUint16(offset,this.validTables);for(i=0;i<this.tables.length;i++){if(!this.tables[i])continue;tsdWriter.setAt(offset++,i);dataLength=this.tables[i].length;tsdWriter.setAt(offset++,dataLength);for(dataOffset=0;dataOffset<dataLength;dataOffset++)tsdWriter.setAt(offset++,TssCompiler._toUint8(this.tables[i][dataOffset]))}return tsd.buffer};TssCompiler.prototype._compile=function(){try{this._parseLines();this._parseDirectives();this._parseChannels();return this._generateTsd()}catch(e){Log.getLog().error(e.stack);Log.getLog().error(e.toString());return null}};TssCompiler.prototype.compile=function(source){if(typeof source=="string")this.source=TString.createFromString(source);else this.source=TString.createFromUint8Array(new Uint8Array(source));return this._compile()};var MMLParser=function(){this.macro={};this.endParse=false;this.expandMode=true;this.noteShift=0;this.dumpString="";this.channel=0;this.asciiA="A".charCodeAt(0);this.commentMode=false;this.octUp="<";this.octDown=">";this.FmNode=[];this.FmPipe=-1;this.FmOps=0;this.FmMode=false;this.FmCount=0;this.number2name=["c","c+","d","d+","e","f","f+","g","g+","a","a+","b"];this.name2number={"b+":0,c:0,"c+":1,"d-":1,d:2,"d+":3,"e-":3,e:4,"f-":4,"e+":5,f:5,"f+":6,"g-":6,g:7,"g+":8,"a-":8,a:9,"a+":10,"b-":10,b:11,"c-":11}};MMLParser.prototype.initialize=function(){this.macro={};this.endParse=false;this.expandMode=true;this.noteShift=0;this.dumpString="";this.channel=0;this.asciiA="A".charCodeAt(0);this.commentMode=false;this.octUp="<";this.octDown=">";this.FmNode=[];this.FmPipe=-1;this.FmOps=0;this.FmMode=false;this.FmCount=0;this.resetChannelString()};MMLParser.prototype.isString=function(obj){return typeof obj=="string"||obj instanceof String};MMLParser.prototype.octave=function(n){return Math.floor(n/12)};MMLParser.prototype.noteMod12=function(n){while(n<0){n+=12}return n%12};MMLParser.prototype.adjustOctave=function(a,offset){var oct=this.octave(this.noteShift+offset);if(oct>0){for(var i=0;i<oct;i++){a.push(["mml",this.octUp]);this.noteShift-=12}}else if(oct<0){for(var i=0;i<-oct;i++){a.push(["mml",this.octDown]);this.noteShift+=12}}};MMLParser.prototype.repeat=function(c,n){var s="";for(var i=0;i<n;i++){s+=c}return s};MMLParser.prototype.getChannelString=function(){var ret;var n0=this.channel%26;var n1=Math.floor(this.channel/26)-1;if(n1<0){ret="#"+String.fromCharCode(this.asciiA+n0)}else{ret="#"+String.fromCharCode(this.asciiA+n1)+String.fromCharCode(this.asciiA+n0)}this.channel++;return ret};MMLParser.prototype.resetChannelString=function(){this.channel=0};MMLParser.prototype.expandWAVB=function(s){var ret="";if(s.length%2==1){s=s+"0"}for(var i=0;i<s.length;i+=2){if(i>0){ret+=","}var hex=s.substring(i,i+2);var num=parseInt(hex,16)-128;ret+=num.toString(10)}return"<"+ret+">"};MMLParser.prototype.parse=function(mml){this.initialize();var ret=[];mml=mml.replace(/\n/g,"");var lines=mml.split(";");for(var i=0;i<lines.length;i++){var s=lines[i];this.noteShift=0;var arr=this.parseLine(lines[i]);if(arr.length>0){ret.push(arr)}if(this.endParse){break}}return ret};MMLParser.prototype.expandMacro=function(s){if(this.commentMode){if(s.match(/^[^}]*}/)){s=s.replace(/^[^}]*}/,"");this.commentMode=false}else{return s}}s=s.replace(/{[^}]*}/g,"");s=s.replace(/{[^}]*$/,"{");if(s.match(/^ *#/)){return s}this.noteShift=0;var replaceCount=0;var r=s.match(/([A-Z])(\([+\-]?[0-9]+\)|\([a-g][+\-]?\))?/);while(r){var shift_in;var shift_out;var nameStr=RegExp.$1;var rangeStr=RegExp.$2.replace("(","").replace(")","");var range;if(rangeStr!==""){if(rangeStr.match(/[+\-]?[0-9]+/)){range=parseInt(rangeStr,10)}else{range=this.name2number[rangeStr]}shift_in="@ns"+String(range);shift_out="@ns"+String(-range)}else{shift_in="";shift_out=""}s=s.substring(0,r.index)+shift_in+this.macro[nameStr]+shift_out+s.substring(r.index+r[0].length);r=s.match(/([A-Z])(\([+\-]?[0-9]+\)|\([a-g][+\-]?\))?/);nameStr=RegExp.$1;rangeStr=RegExp.$2.replace("(","").replace(")","");replaceCount++;if(replaceCount>1e3){break}}return s};MMLParser.prototype.parseLine=function(s){var org_s=s;this.endParse=false;var a=[];s=this.expandMacro(s);this.noteShift=0;if(!s.match(/#TITLE/)){s=s.replace(/ /g,"")}else{s=s.replace(/^.*#TITLE[^<]*/g,"#TITLE")}if(this.commentMode){if(s.match(/^[^}]*}/)){s=s.replace(/^[^}]*}/,"");this.commentMode=false}else{return[]}}var cnt=0;while(true){cnt++;var ext_s=s;if(s.match(/^(mp)([+\-]?[0-9]+)?(,[+\-]?[0-9]+)?(,[+\-]?[0-9]+)?(,[+\-]?[0-9]+)?(,[+\-]?[0-9]+)?/)){s=s.replace(/^(mp)([+\-]?[0-9]+)?(,[+\-]?[0-9]+)?(,[+\-]?[0-9]+)?(,[+\-]?[0-9]+)?(,[+\-]?[0-9]+)?/,"");a.push(["mml",RegExp.$1,RegExp.$2,RegExp.$3,RegExp.$4,RegExp.$5,RegExp.$6])}else if(s.match(/^(na)([+\-]?[0-9]+)?(,[+\-]?[0-9]+)?/)){s=s.replace(/^(na)([+\-]?[0-9]+)?(,[+\-]?[0-9]+)?/,"");a.push(["mml",RegExp.$1,RegExp.$2,RegExp.$3])}else if(s.match(/^(nt)([+\-]?[0-9]+)?(,[+\-]?[0-9]+)?/)){s=s.replace(/^(nt)([+\-]?[0-9]+)?(,[+\-]?[0-9]+)?/,"");a.push(["exmml(unsupported)",RegExp.$1,RegExp.$2,RegExp.$3])}else if(s.match(/^(ns)([+\-]?[0-9]+)?/)){s=s.replace(/^(ns)([+\-]?[0-9]+)?/,"");if(!this.expandMode){a.push(["exmml",RegExp.$1,RegExp.$2])}if(RegExp.$2!==""){this.noteShift=parseInt(RegExp.$2,10)}else{this.noteShift=0}}else if(s.match(/^(ph)([+\-]?[0-9]+)/)){s=s.replace(/^(ph)([+\-]?[0-9]+)/,"");a.push(["exmml(unsupported)",RegExp.$1,RegExp.$2])}else if(s.match(/^(ml)([+\-]?[0-9]+)/)){s=s.replace(/^(ml)([+\-]?[0-9]+)/,"");a.push(["mml",RegExp.$1,RegExp.$2])}else if(s.match(/^([svx])([+\-]?[0-9]+)?(,[+\-]?[0-9]+)?/)){s=s.replace(/^([svx])([+\-]?[0-9]+)?(,[+\-]?[0-9]+)?/,"");a.push(["mml",RegExp.$1,RegExp.$2,RegExp.$3])}else if(s.match(/^([hijklmnopqrtuwxyz])([+\-]?[0-9]+)?/)){s=s.replace(/^([hijklmnopqrstuvwxyz])([+\-]?[0-9]+)?/,"");a.push(["mml",RegExp.$1,RegExp.$2])}else if(s.match(/^([abcdefg][+\-]?)([0-9]+)?/)){s=s.replace(/^([abcdefg][+\-]?)([0-9]+)?/,"");if(this.noteShift===0){a.push(["mml",RegExp.$1,RegExp.$2])}else{var pitch=this.name2number[RegExp.$1];this.adjustOctave(a,pitch);var newPitch=pitch+this.noteShift;a.push(["mml",this.number2name[this.noteMod12(newPitch)],RegExp.$2])}}else if(s.match(/^([r])([0-9]*)/)){s=s.replace(/^([r])([0-9]*)/,"");a.push(["mml",RegExp.$1,RegExp.$2])}else if(s.match(/^(\^)([0-9]*)/)){s=s.replace(/^(\^)([0-9]*)/,"");a.push(["mml",RegExp.$1,RegExp.$2])}else if(s.match(/^(\/:)([0-9]*)/)){s=s.replace(/^(\/:)([0-9]*)/,"");this.adjustOctave(a,0);a.push(["mml",RegExp.$1,RegExp.$2])}else if(s.match(/^(:\/)/)){s=s.replace(/^(:\/)/,"");this.adjustOctave(a,0);a.push(["mml",RegExp.$1])}else if(s.match(/^(\[)([0-9]*)/)){s=s.replace(/^(\[)([0-9]*)/,"");this.adjustOctave(a,0);a.push(["mml",RegExp.$1,RegExp.$2])}else if(s.match(/^(\])/)){s=s.replace(/^(\])/,"");this.adjustOctave(a,0);a.push(["mml",RegExp.$1])}else if(s.match(/^([$|/])/)){s=s.replace(/^([$|/])/,"");this.adjustOctave(a,0);a.push(["mml",RegExp.$1])}else if(s.match(/^([<>])/)){if(this.noteshift===0){a.push(["mml",RegExp.$1])}else{if(RegExp.$1===this.octUp){this.noteShift+=12}else{this.noteShift-=12}}s=s.replace(/^([<>])/,"")}else if(s.match(/^([,.^()])/)){s=s.replace(/^([,.^()])/,"");a.push(["mml",RegExp.$1])}else if(s.match(/^(@kr|@ks|@ml|@apn)([+\-]?[0-9]+)?(,[+\-]?[0-9]+)?/)){s=s.replace(/^(@kr|@ks|@ml|@apn)([+\-]?[0-9]+)?(,[+\-]?[0-9]+)?/,"");a.push(["exmml(unsupported)",RegExp.$1,RegExp.$2,RegExp.$3])}else if(s.match(/^(@ns)([+\-]?[0-9]+)/)){s=s.replace(/^(@ns)([+\-]?[0-9]+)/,"");if(!this.expandMode){a.push(["exmml",RegExp.$1,RegExp.$2])}this.noteShift+=parseInt(RegExp.$2,10)}else if(s.match(/^(@[vio])([+\-]?[0-9]+)?(,[+\-]?[0-9]+)/)){s=s.replace(/^(@[vio])([+\-]?[0-9]+)?(,[+\-]?[0-9]+)/,"");a.push(["mml",RegExp.$1,RegExp.$2,RegExp.$3])}else if(s.match(/^(@[v])([+\-]?[0-9]+)?/)){s=s.replace(/^(@[v])([+\-]?[0-9]+)?/,"");a.push(["mml",RegExp.$1,RegExp.$2])}else if(s.match(/^(@[a-z])([+\-]?[0-9]+)?(,[+\-]?[0-9]+)?(,[+\-]?[0-9]+)?(,[+\-]?[0-9]+)?/)){s=s.replace(/^(@[a-z])([+\-]?[0-9]+)?(,[+\-]?[0-9]+)?(,[+\-]?[0-9]+)?(,[+\-]?[0-9]+)?/,"");a.push(["exmml(unsupported)",RegExp.$1,RegExp.$2,RegExp.$3])}else if(s.match(/^([&*])/)){s=s.replace(/^([&*])/,"");a.push(["exmml(unsupported)",RegExp.$1])}else if(s.match(/^(%)([0-9]+)/)){s=s.replace(/^(%)([0-9]+)/,"");a.push(["mml",RegExp.$1,RegExp.$2+" "])}else if(s.match(/^([@])([0-9]+)/)){s=s.replace(/^([@])([0-9]+)/,"");a.push(["mml",RegExp.$1,RegExp.$2])}else if(s.match(/^([~_])([0-9]+)?/)){s=s.replace(/^([~_])([0-9]+)?/,"");a.push(["exmml(unsupported)",RegExp.$1,RegExp.$2])}else if(s.match(/^{[^}]*}/)){s=s.replace(/^{[^}]*}/,"")}else if(s.match(/^{[^}]*$/)){s=s.replace(/^{[^}]*$/,"");this.commentMode=true}else if(s.match(/^(#OCTAVE|#VOLUME)(REVERSE|NORMAL)/)){s=s.replace(/^(#OCTAVE|#VOLUME)(REVERSE|NORMAL)/,"");a.push(["directive",RegExp.$1,RegExp.$2]);if(RegExp.$2==="REVERSE"){this.octUp=">";this.octDown="<"}}else if(s.match(/^(#TABLE)([0-9]+),?(<[^>]*>)/)){s=s.replace(/^(#TABLE)([0-9]+),?(<[^>]*>)/,"");a.push(["directive",RegExp.$1,RegExp.$2,RegExp.$3])}else if(s.match(/^(#WAV)([0-9]+),?(<[^>]*>)/)){s=s.replace(/^(#WAV)([0-9]+),?(<[^>]*>)/,"");a.push(["directive",RegExp.$1,RegExp.$2,RegExp.$3])}else if(s.match(/^(#WAVB)([0-9]+),?([0-9a-fA-F]+)/)){s=s.replace(/^(#WAVB)([0-9]+),?([0-9a-fA-F]+)/,"");a.push(["directive","#WAV",RegExp.$2,this.expandWAVB(RegExp.$3)])}else if(s.match(/^(#FINENESS)([0-9]+)/)){s=s.replace(/^(#FINENESS)([0-9]+)/,"");a.push(["directive",RegExp.$1,RegExp.$2,RegExp.$3])}else if(s.match(/^(#TITLE) *(<[^>]*>)/)){s=s.replace(/^(#TITLE) *(<[^>]*>)/,"");a.push(["directive",RegExp.$1,RegExp.$2])}else if(s.match(/^(#CHANNEL)([0-9]+)/)){s=s.replace(/^(#CHANNEL)([0-9]+)/,"")}else if(s.match(/^(#PRAGMA)(FAMICOM|GAMEBOY)/)){s=s.replace(/^(#PRAGMA)(FAMICOM|GAMEBOY)/,"");a.push(["directive",RegExp.$1,RegExp.$2])}else if(s.match(/^(#MML)/)){s=s.replace(/^(#MML)/,"")}else if(s.match(/^(#END)/)){s="";this.endParse=true;break}else if(s.match(/^(#FM)(.*)/)){s=s.replace(/^(#FM)(.*)/,"");a.push(["directive",RegExp.$1,RegExp.$2])}else if(s.match(/^#([A-Z])=(.*)/)){s=s.replace(/^#([A-Z])=(.*)/,"");if(!this.expandMode){a.push(["def",RegExp.$1,RegExp.$2])}this.macro[RegExp.$1]=RegExp.$2}else if(s.match(/^(#FILTER)([0-9]+),?(<[^>]*>)/)){s=s.replace(/^(#FILTER)([0-9]+),?(<[^>]*>)/,"");a.push(["exmml(unsupported)",RegExp.$1,RegExp.$2])}else if(s.match(/^(#[A-Z]+)/)){s=s.replace(/^(#[A-Z]+)/,"");a.push(["exmml(unsupported)",RegExp.$1])}else{if(s!==""){console.log("parse error:["+s+"]");console.log("      >>> "+org_s);console.log("      >>> "+ext_s);throw new Error("parse error")}break}}return a};MMLParser.prototype.parseFmMacro=function(s){var nest=0;var a=[];var modulator_str="";var carrier;var level;var org_s=s;while(s.length>0){if(nest===0){if(s.match(/^ +/)){s=s.replace(/^ +/,"")}else if(s.match(/^([A-Z])([0-8])?\(/)){modulator_str="";carrier=RegExp.$1;if(RegExp.$2!==""){level=RegExp.$2}else{level="3"}nest++;s=s.replace(/^([A-Z])([0-8])?\(/,"")}else if(s.match(/^([A-Z])([0-8])?/)){a.push([RegExp.$1,"0",""]);s=s.replace(/^([A-Z])([0-8])?/,"")}else if(s.match(/^\+/)){a.push("+");s=s.replace(/^\+/,"")}else{if(s!==""){console.log("FM macro parse error:["+s+"]");console.log("      >>> "+org_s)}break}}else{if(s.match(/^\)/)){nest--;if(nest===0){a.push([carrier,level,this.parseFmMacro(modulator_str)]);s=s.substring(1)}else{modulator_str+=s.charAt(0);s=s.substring(1)}}else if(s.match(/^\(/)){nest++;modulator_str+=s.charAt(0);s=s.substring(1)}else{modulator_str+=s.charAt(0);s=s.substring(1)}}}return a};MMLParser.prototype.evalFmMacro=function(s){this.FmNode=new Array(26);this.FmPipe=-1;this.FmOps=0;var a=this.parseFmMacro(s);this.evalFmMacroSub(a,0,1);this.FmMode=true;this.FmCount=0};MMLParser.prototype.evalFmMacroSub=function(a,nest,mode){var childMode=1;for(var i=0;i<a.length;i++){if(this.isString(a[i])){if(a[i].match(/[A-Z]/)){this.FmOps++;var idx=a[i].charCodeAt(0)-this.asciiA;this.FmNode[idx]=[];node=this.FmNode[idx];if(a[i+1]==="0"){node[0]=0;node[1]=0;node[3]=this.FmPipe}else{this.FmPipe++;node[0]=parseInt(a[i+1],10);node[1]=this.FmPipe;node[3]=this.FmPipe-1}if(nest===1){node[2]=0;node[3]=0}else{node[2]=mode}i++}else if(a[i]==="+"){childMode=2}}else{this.evalFmMacroSub(a[i],nest+1,childMode)}}};MMLParser.prototype.dumpFmMacro=function(s){var a=this.parseFmMacro(s);this.dumpString="";this.dumpFmMacroSub(a,0);return this.dumpString};MMLParser.prototype.dumpFmMacroSub=function(a,nest){for(var i=0;i<a.length;i++){if(this.isString(a[i])){if(a[i].match(/[A-Z]/)){this.dumpString+=this.repeat(" ",nest*4)+a[i]+"<--"+a[i+1]+"--\n";i++}}else{this.dumpFmMacroSub(a[i],nest+1)}}};MMLParser.prototype.compile=function(mml,addDirective){if(addDirective===undefined){addDirective=true}var arr=this.parse(mml);var title="<>";var s="";for(var i=0;i<arr.length;i++){if(arr[i][0][0]==="directive"){var type=arr[i][0][1];if(type==="#TITLE"){title=arr[i][0][2]}else if(type==="#TABLE"||type==="#WAV"){s+=arr[i][0][1]+" "+arr[i][0][2]+","+arr[i][0][3]+"\n"}else if(type!=="#FM"){s+=arr[i][0][1]+" "+arr[i][0][2]+"\n"}}}for(var i=0;i<arr.length;i++){var l="";if(arr[i][0][0]==="directive"){var type=arr[i][0][1];if(type==="#FM"){this.evalFmMacro(arr[i][0][2])}continue}if(addDirective){l+=this.getChannelString()+"\n"}var j=0;if(arr[i][j][1]=="%"){l+=arr[i][j][1]+arr[i][j][2];j++}if(this.FmMode){var node=this.FmNode[this.FmCount];l+="@i"+node[0]+","+node[1]+"@o"+node[2]+","+node[3];this.FmCount++;if(this.FmCount>=this.FmOps){this.FmMode=false}}for(;j<arr[i].length;j++){for(var k=1;k<arr[i][j].length;k++){if(arr[i][j][0]==="exmml(unsupported)"){continue}l+=arr[i][j][k]}}if(l.match(/\$[^abcdefgr]*$/)){console.log("infinite loop detected:["+l.replace("\n"," ")+"]");throw new Error("infinite loop error")}s+=l+"\n"}if(s===""){return""}var ret="";if(addDirective){ret+="#TITLE "+title+"\n";ret+="#CHANNEL "+this.channel+"\n"}ret+=s;return ret};MMLParser.prototype.dump=function(mml){var w=this.expandMode;this.expandMode=false;var arr=this.parse(mml);this.expandMode=w;console.log("=========================");for(var i=0;i<arr.length;i++){for(var j=0;j<arr[i].length;j++){var cmd="";for(var k=0;k<arr[i][j].length;k++){cmd+=arr[i][j][k]+" "}console.log(cmd)}console.log("-------")}console.log("=========================")};if(typeof module!="undefined"){module.exports=MMLParser}(function(){var parser=new MMLParser;var looper,master,player;var lastsel="";document.onkeydown=function(e){var ctrl=e.ctrlKey||e.metaKey;if(ctrl&&e.keyCode===67){if(player===undefined){looper=new AudioLooper(2048);master=new MasterChannel;master.setVolume(1);player=new TsdPlayer;player.device=new TssChannel;player.device.setPlayer(player);master.addChannel(player.device);player.setMasterChannel(master)}var sel=String(document.getSelection());if(looper.channel){looper.setChannel(null);if(sel===lastsel){return}}lastsel=sel;var tsc=new TssCompiler;var tssmml=parser.compile(sel);if(e.shiftKey){console.log(tssmml)}if(tssmml===""){console.log("MML not found");return}var ret=tsc.compile(tssmml);if(ret===null){console.log("MML compile error")}else{setTimeout(function(){looper.setChannel(master);player.play(ret)},300)}}}})();